<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Puerto Rico — Charts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="index.html" class="nav-link border-b-2 border-transparent">Home</a>
      <a href="tables.html" class="nav-link border-b-2 border-transparent">Tables</a>
      <a href="maps.html" class="nav-link border-b-2 border-transparent">Maps</a>
      <a href="charts.html" class="nav-link border-b-2 border-transparent">Charts</a>
      <a href="profiles.html" class="nav-link border-b-2 border-transparent">Profiles</a>
      <a href="pages.html" class="nav-link border-b-2 border-transparent">Pages</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <header class="text-center space-y-2">
      <h1 class="text-4xl font-bold">Charts</h1>
      <p class="text-gray-600">
        Loads <code>data/population/prm-est2024-chg.json</code> and lets you chart any of Puerto Rico’s 78 municipios.
      </p>

      <!-- Searchable municipio combobox -->
      <div class="flex items-center justify-center gap-3 mt-2">
        <label for="muniInput" class="text-sm text-gray-600">Municipio:</label>
        <div class="flex items-center gap-2">
          <input id="muniInput" list="muniList"
                 class="px-3 py-1.5 rounded border bg-white text-sm w-64"
                 placeholder="Start typing… (e.g., Adjuntas)" />
          <datalist id="muniList"></datalist>
          <button id="reloadBtn" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">
            Reload
          </button>
          <label class="text-sm text-gray-600">
            <input id="jsonInput" type="file" accept=".json" class="hidden">
            <span class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 cursor-pointer">Upload JSON</span>
          </label>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow p-4">
        <h2 id="lineTitle" class="text-lg font-semibold mb-3">Population (2020–2024)</h2>
        <div class="aspect-video bg-gray-50 rounded p-3">
          <canvas id="prChart"></canvas>
        </div>
        <p id="status" class="mt-2 text-xs text-gray-500"></p>
      </div>

      <div class="bg-white rounded-lg shadow p-4">
        <h2 id="barTitle" class="text-lg font-semibold mb-3">Annual % Change</h2>
        <div class="aspect-video bg-gray-50 rounded p-3">
          <canvas id="pctChart"></canvas>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-lg shadow p-5">
      <h2 class="text-lg font-semibold">File Sources</h2>
      <ol class="list-decimal pl-6 mt-2 text-sm">
        <li>
          <a href="https://www.census.gov/data/datasets/time-series/demo/popest/2020s-total-puerto-rico-municipios.html"
             class="text-blue-600 underline"
             target="_blank" rel="noopener noreferrer">
            https://www.census.gov/data/datasets/time-series/demo/popest/2020s-total-puerto-rico-municipios.html
          </a>
        </li>
      </ol>
      <div class="mt-3 text-sm">
        <span class="font-medium">Files:</span>
        <ul class="list-disc pl-6 mt-1">
          <li><code>prm-est2024-chg.xlsx</code></li>
          <li><code>prm-est2024-pop.xlsx</code></li>
        </ul>
      </div>
    </section>
  </main>

  <script defer>
    // nav highlight
    document.querySelectorAll('.nav-link').forEach(a=>{
      if (location.pathname.endsWith(a.getAttribute('href'))) {
        a.classList.add('text-blue-600','font-semibold','border-blue-600');
        a.setAttribute('aria-current','page');
      }
    });

    // --- data + helpers ---
    const FULL_JSON = "data/population/prm-est2024-chg.json";
    const YEARS = [2020, 2021, 2022, 2023, 2024];
    const statusEl = document.getElementById("status");
    const muniInput = document.getElementById("muniInput");
    const muniList  = document.getElementById("muniList");
    const prCtx  = document.getElementById("prChart").getContext("2d");
    const pctCtx = document.getElementById("pctChart").getContext("2d");
    const lineTitle = document.getElementById("lineTitle");
    const barTitle  = document.getElementById("barTitle");
    let lineChart = null, barChart = null;
    let rows = [], geoHeader = null, municipios = [];

    const setStatus = (m)=> statusEl.textContent = m || "";
    const num = (v) => {
      if (v == null) return NaN;
      const s = String(v).replace(/\xa0/g,"").replace(/,/g,"").replace(/[^0-9.\-]/g,"");
      return s ? Number(s) : NaN;
    };

    function detectGeoHeader(allRows){
      const keys = Object.keys(allRows[0] || {});
      for (const k of keys) {
        const col = allRows.map(r => r[k]);
        const strCount = col.filter(v => typeof v === "string").length;
        const hasPR = col.some(v => typeof v === "string" && v.toLowerCase().includes("puerto rico"));
        if (strCount >= 10 && hasPR) return k;
      }
      return keys.find(k => /geographic|area|name|col_1/i.test(k)) || keys[0];
    }

    function getMunicipios(){
      const names = rows.map(r => r[geoHeader]).filter(Boolean).map(String).filter(n => n.trim().length>0);
      const set = new Set(names);
      const list = Array.from(set).sort((a,b)=> a.localeCompare(b,'en'));
      const i = list.indexOf("Puerto Rico");
      if (i > 0) { list.splice(i,1); list.unshift("Puerto Rico"); }
      return list;
    }

    function populateDatalist(defaultName="Adjuntas"){
      municipios = getMunicipios();
      muniList.innerHTML = "";
      for (const name of municipios){
        const opt = document.createElement("option");
        opt.value = name;
        muniList.appendChild(opt);
      }
      // Default value (Adjuntas if present, else Puerto Rico)
      muniInput.value = municipios.includes(defaultName) ? defaultName : (municipios[0] || "");
    }

    function findBestMatch(q){
      if (!q) return null;
      const exact = municipios.find(n => n === q);
      if (exact) return exact;
      const lower = q.toLowerCase();
      return municipios.find(n => n.toLowerCase().startsWith(lower))
          || municipios.find(n => n.toLowerCase().includes(lower))
          || null;
    }

    function rowFor(name){
      return rows.find(r => String(r[geoHeader]) === name);
    }

    function valuesFor(row){
      return YEARS.map(y => {
        if (row.hasOwnProperty(String(y))) {
          const v = num(row[String(y)]);
          if (Number.isFinite(v)) return v;
        }
        const comp = `Population Estimate (as of July 1) | ${y}`;
        if (row.hasOwnProperty(comp)) {
          const v = num(row[comp]); if (Number.isFinite(v)) return v;
        }
        if (y === 2020 && row.hasOwnProperty("April 1, 2020 Estimates Base")) {
          const v = num(row["April 1, 2020 Estimates Base"]); if (Number.isFinite(v)) return v;
        }
        return NaN;
      });
    }

    function drawCharts(name){
      const r = rowFor(name);
      if (!r) { setStatus(`Could not find row for "${name}".`); return; }
      const vals = valuesFor(r);
      if (vals.some(v => !Number.isFinite(v))) { setStatus(`Missing values for ${name}.`); return; }

      lineTitle.textContent = `${name} — Population (2020–2024)`;
      barTitle.textContent  = `${name} — Annual % Change`;

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(prCtx, {
        type: "line",
        data: { labels: YEARS, datasets: [{ label: "Population", data: vals, tension: 0.2, pointRadius: 4 }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> c.parsed.y.toLocaleString() } }
          },
          scales: { y: { ticks: { callback: v => Number(v).toLocaleString() } } }
        }
      });

      const labels = [], pct = [];
      for (let i=1;i<YEARS.length;i++){
        labels.push(`${YEARS[i-1]}→${YEARS[i]}`);
        pct.push(+(((vals[i]-vals[i-1]) / vals[i-1]) * 100).toFixed(2));
      }
      if (barChart) barChart.destroy();
      barChart = new Chart(pctCtx, {
        type: "bar",
        data: { labels, datasets: [{ label: "% change", data: pct }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> `${c.parsed.y.toFixed(2)}%` } }
          },
          scales: { y: { ticks: { callback: v => `${v}%` } } }
        }
      });

      setStatus("Done.");
    }

    async function fetchFull(){
      const res = await fetch(FULL_JSON, { cache: "no-store" });
      if (!res.ok) throw new Error("Could not fetch full JSON.");
      rows = await res.json();
      geoHeader = detectGeoHeader(rows);
      populateDatalist("Adjuntas");   // default
      drawCharts(muniInput.value);
    }

    // events
    document.getElementById("reloadBtn").addEventListener("click", () => {
      setStatus("Reloading…"); fetchFull().catch(e => setStatus(e.message));
    });

    muniInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") {
        const pick = findBestMatch(muniInput.value);
        if (pick) { muniInput.value = pick; drawCharts(pick); }
      }
    });
    muniInput.addEventListener("change", ()=>{
      const pick = findBestMatch(muniInput.value);
      if (pick) { muniInput.value = pick; drawCharts(pick); }
    });

    document.getElementById("jsonInput").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try{
        setStatus("Reading uploaded JSON…");
        const txt = await f.text();
        rows = JSON.parse(txt);
        geoHeader = detectGeoHeader(rows);
        populateDatalist("Adjuntas");
        drawCharts(muniInput.value);
      }catch(err){ setStatus(err.message || String(err)); }
    });

    // init
    window.addEventListener("load", ()=>{
      if (location.protocol === "file:") {
        setStatus("Open via a local server or use Upload JSON."); return;
      }
      setStatus("Loading data…");
      fetchFull().catch(e => setStatus(e.message));
    });
  </script>
</body>
</html>
