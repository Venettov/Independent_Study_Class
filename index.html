<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Puerto Rico — Map</title>

  <!-- Tailwind (optional, for consistent look with the rest of your site) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Chart.js for the hover mini-chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    #map { height: 70vh; }
    .mini-chart {
      position: absolute;
      z-index: 1000;
      width: 320px;
      pointer-events: none;            /* do not block map interactions */
      background: #ffffff;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 0.75rem;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      display: none;                   /* hidden by default */
    }
    .mini-chart header {
      font-weight: 600; font-size: 12px;
      padding: 6px 10px; border-bottom: 1px solid #eee;
    }
    .mini-chart .canvas-wrap { padding: 8px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">
  <!-- Simple top nav to match your site -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="index.html" class="nav-link border-b-2 border-transparent">Home</a>
      <a href="tables.html" class="nav-link border-b-2 border-transparent">Tables</a>
      <a href="maps.html" class="nav-link border-b-2 border-transparent">Maps</a>
      <a href="charts.html" class="nav-link border-b-2 border-transparent">Charts</a>
      <a href="profiles.html" class="nav-link border-b-2 border-transparent">Profiles</a>
      <a href="pages.html" class="nav-link border-b-2 border-transparent">Pages</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <header class="text-center space-y-2">
      <h1 class="text-3xl sm:text-4xl font-bold">Puerto Rico — Municipios</h1>
      <p class="text-gray-600">
        Hover any municipio to see a 2020–2024 population mini-chart. Data are loaded from
        <code>data/population/prm-est2024-chg.json</code>.
      </p>
    </header>

    <div id="map" class="rounded-lg shadow bg-white"></div>

    <!-- Hover mini-chart -->
    <div id="miniChart" class="mini-chart">
      <header id="miniChartTitle">Municipio</header>
      <div class="canvas-wrap">
        <canvas id="miniChartCanvas" width="300" height="160"></canvas>
      </div>
    </div>

    <section class="bg-white rounded-lg shadow p-5">
      <h2 class="text-lg font-semibold">File Sources</h2>
      <ol class="list-decimal pl-6 mt-2 text-sm">
        <li>
          <a href="https://www.census.gov/data/datasets/time-series/demo/popest/2020s-total-puerto-rico-municipios.html"
             class="text-blue-600 underline" target="_blank" rel="noopener noreferrer">
            https://www.census.gov/data/datasets/time-series/demo/popest/2020s-total-puerto-rico-municipios.html
          </a>
        </li>
      </ol>
    </section>
  </main>

  <script>
    // highlight nav
    document.querySelectorAll('.nav-link').forEach(a=>{
      if (location.pathname.endsWith(a.getAttribute('href'))) {
        a.classList.add('text-blue-600','font-semibold','border-blue-600');
        a.setAttribute('aria-current','page');
      }
    });

    // ----------- CONFIG: set this to your municipios GeoJSON path -----------
    // Example candidates:
    //   "tl_2022_72_cousub/puerto_rico_municipios.geojson"
    //   "resources/puerto_rico_municipios.geojson"
    const GEOJSON_URL = "tl_2022_72_cousub/puerto_rico_municipios.geojson";
    // Population data table (already in your repo)
    const DATA_URL    = "data/population/prm-est2024-chg.json";

    // Years to chart
    const YEARS = [2020, 2021, 2022, 2023, 2024];

    // Helpers
    const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const tidyLead = v => String(v ?? '').replace(/^\s*[.\-•]\s*/,'').trim();
    const num = v => {
      const s = String(v ?? '').replace(/\xa0/g,'').replace(/,/g,'').replace(/[^0-9.\-]/g,'');
      return s ? Number(s) : NaN;
    };

    function nameFromProps(props){
      // Common TIGER/Line fields:
      // NAME = "Adjuntas"; NAMELSAD = "Adjuntas Municipio"
      const raw = props.NAME || props.NAMELSAD || props.MUNI || props.Municipio || "";
      return tidyLead(String(raw).replace(/\s*Municipio\s*$/i,'').replace(/,?\s*Puerto Rico$/i,'').trim());
    }

    // Detect the "geographic" column in the JSON table produced by your converter
    function detectGeoHeader(rows){
      const keys = Object.keys(rows[0] || {});
      const priority = ['col_1','Geographic Area','Geographic Area Name','Geographic Area:'];
      for (const k of priority) if (keys.includes(k)) return k;
      for (const k of keys) {
        const col = rows.map(r => r[k]);
        const strCount = col.filter(v => typeof v === 'string').length;
        const hasPR = col.some(v => typeof v === 'string' && /puerto rico/i.test(v));
        if (strCount >= 20 && hasPR) return k;
      }
      return keys[0];
    }

    function valuesForRow(row){
      return YEARS.map(y => {
        if (row.hasOwnProperty(String(y))) {
          const v = num(row[String(y)]); if (Number.isFinite(v)) return v;
        }
        const composed = `Population Estimate (as of July 1) | ${y}`;
        if (row.hasOwnProperty(composed)) {
          const v = num(row[composed]); if (Number.isFinite(v)) return v;
        }
        if (y === 2020 && row.hasOwnProperty("April 1, 2020 Estimates Base")) {
          const v = num(row["April 1, 2020 Estimates Base"]); if (Number.isFinite(v)) return v;
        }
        return NaN;
      });
    }

    // ----------- Preload population table and create lookup -----------
    let municipioLookup = new Map(); // key: normalized municipio name -> row
    let lookupReady = false;

    async function loadPopulationTable() {
      try {
        const r = await fetch(DATA_URL, { cache: "no-store" });
        const rows = await r.json();
        const geoHeader = detectGeoHeader(rows);
        rows.forEach(row => {
          const name = tidyLead(row[geoHeader]);
          if (!name) return;
          const key = stripDiacritics(name.toLowerCase());
          if (!municipioLookup.has(key)) municipioLookup.set(key, row);
        });
        lookupReady = true;
      } catch (err) {
        console.warn("Population JSON not available for mini-chart:", err);
      }
    }

    // ----------- Mini-chart UI -----------
    const mini = document.getElementById('miniChart');
    const miniTitle = document.getElementById('miniChartTitle');
    const miniCanvas = document.getElementById('miniChartCanvas');
    let miniChart = null;

    function showMiniChart(name, mouseEvt) {
      if (!lookupReady) return;
      const key = stripDiacritics(name.toLowerCase());
      const row = municipioLookup.get(key);
      if (!row) { hideMiniChart(); return; }

      const vals = valuesForRow(row);
      if (vals.some(v => !Number.isFinite(v))) { hideMiniChart(); return; }

      miniTitle.textContent = `${name} — Population (2020–2024)`;

      if (miniChart) {
        miniChart.data.labels = YEARS;
        miniChart.data.datasets[0].data = vals;
        miniChart.update();
      } else {
        const ctx = miniCanvas.getContext('2d');
        miniChart = new Chart(ctx, {
          type: 'line',
          data: { labels: YEARS, datasets: [{ label: 'Population', data: vals, tension: 0.2, pointRadius: 2 }] },
          options: {
            responsive: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: { y: { ticks: { callback: v => Number(v).toLocaleString() } } }
          }
        });
      }

      // position near cursor
      if (mouseEvt && mouseEvt.originalEvent) {
        const { pageX, pageY } = mouseEvt.originalEvent;
        mini.style.left = (pageX + 12) + 'px';
        mini.style.top  = (pageY + 12) + 'px';
      }
      mini.style.display = 'block';
    }

    function moveMiniChart(mouseEvt) {
      if (mini.style.display === 'none') return;
      if (mouseEvt && mouseEvt.originalEvent) {
        const { pageX, pageY } = mouseEvt.originalEvent;
        mini.style.left = (pageX + 12) + 'px';
        mini.style.top  = (pageY + 12) + 'px';
      }
    }

    function hideMiniChart() {
      mini.style.display = 'none';
    }

    // ----------- Build map -----------
    async function init() {
      await loadPopulationTable();

      const map = L.map('map', { scrollWheelZoom: true });
      // Center on Puerto Rico
      map.setView([18.22, -66.4], 8);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Fetch municipios GeoJSON
      const gj = await fetch(GEOJSON_URL, { cache: "no-store" }).then(r => r.json());

      const baseStyle = {
        color: '#2b6cb0',
        weight: 1,
        fillColor: '#4299e1',
        fillOpacity: 0.15
      };
      const hiStyle = { weight: 2, fillOpacity: 0.35 };

      const layer = L.geoJSON(gj, {
        style: baseStyle,
        onEachFeature: (feat, lyr) => {
          const name = nameFromProps(feat.properties || {});
          // Existing hover label (if you already had one)
          lyr.bindTooltip(name, { direction: 'center', permanent: false, className: 'text-xs' });

          lyr.on({
            mouseover: e => {
              e.target.setStyle(hiStyle); e.target.bringToFront?.();
              showMiniChart(name, e);
            },
            mousemove: e => moveMiniChart(e),
            mouseout:  e => { layer.resetStyle(e.target); hideMiniChart(); },
            click:     e => map.fitBounds(e.target.getBounds(), { padding: [20,20] })
          });
        }
      }).addTo(map);

      map.fitBounds(layer.getBounds(), { padding: [12,12] });
    }

    // Kick off
    init().catch(err => console.error(err));
  </script>
</body>
</html>
