<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Cards + hero */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:hidden;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }

    /* Map — reduced height to show more of the charts below without zooming out */
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }  /* slightly shorter on wide screens */
    @media (max-width: 640px)  { #map { height: 54vh; } }  /* a bit taller on small phones */

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    /* Mini charts area */
    .mini { min-height: 260px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- Nav -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="index.html"   class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold">Home</a>
      <a href="metrics.html" class="nav-link border-b-2 border-transparent">Metrics</a>
      <a href="maps.html"    class="nav-link border-b-2 border-transparent">Maps</a>
      <a href="charts.html"  class="nav-link border-b-2 border-transparent">Charts</a>
      <a href="strategy.html"class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="about.html"   class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- HERO -->
    <header class="card hero p-6 sm:p-8 lg:p-10">
      <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
      <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
        Population & Economic Dynamics in Puerto Rico
      </h1>
      <p class="mt-3 text-lg text-gray-700">
        A graduate research project examining demographic shifts, out-migration, and sustainable development
        strategies through linked data analysis and policy synthesis.
      </p>

      <div class="mt-3">
        <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
          <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
          Hover over the map to see county / municipality details
        </span>
      </div>
    </header>

    <!-- MAP -->
    <section class="card p-4">
      <div id="map"></div>
    </section>

    <!-- DETAILS -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Population details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left text -->
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Population (Vintage 2024):</div>
            <ul class="mt-1 space-y-1">
              <li>2024: <span id="d-2024" class="font-semibold">—</span></li>
              <li>Change since 2020: <span id="d-chg" class="font-semibold">—</span></li>
              <li>2023→2024: <span id="d-2324" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">
              Open on data.census.gov ↗
            </a>
          </div>
        </div>

        <!-- Middle: line chart -->
        <div>
          <h3 class="font-semibold mb-2">Population trend (2020–2024)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChart"></canvas>
          </div>
        </div>

        <!-- Right: bar chart -->
        <div>
          <h3 class="font-semibold mb-2">Annual % Change</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------------------- Data paths ----------------------
    const GEOJSON_URL = './data/tl_2022_72_cousub/pr_municipalities.geojson';
    const POP_JSON    = './data/population/prm-est2024-chg.json';

    // ---------------------- Formatters ----------------------
    const fmt = new Intl.NumberFormat('en-US');
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;

    // ---------------------- Choropleth scale ----------------------
    const CHORO_BREAKS = [-10, -6, -3, 0, 2];
    //            <=-10     -10–-6    -6–-3      -3–0       0–2        >2
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    function colorForPctChange(pct) {
      if (!Number.isFinite(pct)) return '#93c5fd';
      if (pct <= CHORO_BREAKS[0]) return CHORO_COLORS[0];
      if (pct <= CHORO_BREAKS[1]) return CHORO_COLORS[1];
      if (pct <= CHORO_BREAKS[2]) return CHORO_COLORS[2];
      if (pct <= CHORO_BREAKS[3]) return CHORO_COLORS[3];
      if (pct <= CHORO_BREAKS[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    // ---------------------- Helpers ----------------------
    function sanitizeName(s){ return String(s||'').replace(/^\s*[.\-•]\s*/, '').trim(); }

    function detectGeoHeader(rows){
      const keys = Object.keys(rows[0]||{});
      const priority = ["col_1","Geographic Area","Geographic Area Name","Geographic Area:"];
      for (const p of priority) if (keys.includes(p)) return p;
      for (const k of keys) {
        const col = rows.slice(0,40).map(r => r[k]);
        const hasPR = col.some(v => typeof v === 'string' && /puerto rico/i.test(v));
        if (hasPR) return k;
      }
      return keys[0];
    }

    function valFromRow(row, y){
      if (row.hasOwnProperty(String(y))) {
        const n = Number(String(row[String(y)]).replace(/[, ]/g,''));
        if (Number.isFinite(n)) return n;
      }
      const alt = `Population Estimate (as of July 1) | ${y}`;
      if (row.hasOwnProperty(alt)) {
        const n = Number(String(row[alt]).replace(/[, ]/g,''));
        if (Number.isFinite(n)) return n;
      }
      if (y === 2020 && row.hasOwnProperty("April 1, 2020 Estimates Base")) {
        const n = Number(String(row["April 1, 2020 Estimates Base"]).replace(/[, ]/g,''));
        if (Number.isFinite(n)) return n;
      }
      return NaN;
    }

    const YEARS = [2020,2021,2022,2023,2024];

    function statsForMunicipio(name){
      name = sanitizeName(name);
      const row = _rows.find(r => sanitizeName(r[_geoHeader]) === name);
      if (!row) return null;
      const vals = YEARS.map(y => valFromRow(row, y));
      if (vals.some(v => !Number.isFinite(v))) return null;
      const pop2020 = vals[0];
      const pop2024 = vals[4];
      const abs = pop2024 - pop2020;
      const pctTot = (abs / pop2020) * 100;
      const pctYear = [];
      for (let i=1;i<YEARS.length;i++){
        pctYear.push(((vals[i]-vals[i-1]) / vals[i-1]) * 100);
      }
      return { vals, abs, pctTot, pctYear, pop2024 };
    }

    function censusLink(name){
      const g = '040XX00US72';
      return `https://data.census.gov/profile/Puerto_Rico?g=${g}`;
    }

    // ---------------------- Charts ----------------------
    let lineChart = null, barChart = null;
    function drawCharts(name, st){
      if (!st) return;
      const ctxL = document.getElementById('lineChart').getContext('2d');
      const ctxB = document.getElementById('barChart').getContext('2d');

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctxL, {
        type: 'line',
        data: { labels: YEARS, datasets:[{ label:'Population', data: st.vals, tension:.2, pointRadius:4 }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmt.format(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>fmt.format(v) } } },
          maintainAspectRatio: false
        }
      });

      const labels = ['2020→2021','2021→2022','2022→2023','2023→2024'];
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: { labels, datasets:[{ label:'% change', data: st.pctYear.map(v=>+v.toFixed(2)) }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } },
          maintainAspectRatio: false
        }
      });
    }

    // ---------------------- DOM targets ----------------------
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2024 = document.getElementById('d-2024');
    const dChg  = document.getElementById('d-chg');
    const d2324 = document.getElementById('d-2324');
    const dCenL = document.getElementById('d-census');

    function updateDetails(name, st, centroid){
      dName.textContent = name;
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      d2024.textContent = Number.isFinite(st?.pop2024) ? fmt.format(st.pop2024) : '—';
      dChg.textContent  = st ? `${st.abs>0?'+':''}${fmt.format(st.abs)} (${pctFmt(st.pctTot)})` : '—';
      const last = st && st.pctYear.length ? st.pctYear[st.pctYear.length-1] : NaN;
      d2324.textContent = Number.isFinite(last) ? pctFmt(last) : '—';
      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    // ---------------------- Load data + map ----------------------
    let _rows = [], _geoHeader = null;

    (async function init(){
      const res = await fetch(POP_JSON, { cache:'no-store' });
      _rows = await res.json();
      _geoHeader = detectGeoHeader(_rows);

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      const map = L.map('map', { zoomSnap: .25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      const fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      const layer = L.geoJSON(fc, {
        style: (feature) => {
          const p = feature.properties || {};
          const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const st = statsForMunicipio(name);
          const col = colorForPctChange(st ? st.pctTot : NaN);
          return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
        },
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const geoid = p.GEOID || p.geoid || '';
          const st = statsForMunicipio(name);
          const changeLine = st
            ? `<br><small>2020→2024: ${st.abs>0?'+':''}${fmt.format(st.abs)} (${st.pctTot.toFixed(2)}%)</small>`
            : '';
          lyr.bindTooltip(name, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${name}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(name, statsForMunicipio(name), c);
            },
            mouseout: e => layer.resetStyle(e.target),
            click: e => map.fitBounds(e.target.getBounds(), { padding:[20,20] })
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      // Choropleth legend
      const legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        const b = CHORO_BREAKS, c = CHORO_COLORS;
        const row = (color, label) =>
          `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
            <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                         border:1px solid rgba(0,0,0,.15)"></span>
            <span>${label}</span>
          </div>`;
        div.innerHTML = `
          <div style="font-weight:600;margin-bottom:.25rem">Change since 2020</div>
          ${row(c[0], `≤ ${b[0]}%`)}
          ${row(c[1], `${b[0]}% to ${b[1]}%`)}
          ${row(c[2], `${b[1]}% to ${b[2]}%`)}
          ${row(c[3], `${b[2]}% to ${b[3]}%`)}
          ${row(c[4], `${b[3]}% to ${b[4]}%`)}
          ${row(c[5], `> ${b[4]}%`)}
        `;
        return div;
      };
      legend.addTo(map);

      // Nudge the legend upward to sit over the Virgin Islands region (responsive)
      function moveLegend() {
        const el = legend.getContainer ? legend.getContainer() : legend._container;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px'; // ~25% up from bottom
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      // Initial details
      const initName = 'Puerto Rico';
      const st0 = statsForMunicipio(initName) || (function(){
        const f0 = (fc.features && fc.features[0]) || null;
        const nm = f0 ? (f0.properties.NAME || f0.properties.NAMELSAD || '—') : '—';
        return statsForMunicipio(nm);
      })();
      updateDetails(initName, st0, null);
    })();
  </script>
</body>
</html>
