<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Cards + hero */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }

    /* Map â€” trimmed height so charts show sooner */
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    /* Mini charts area */
    .mini { min-height: 260px; }

    /* --- Dropdown base state & transitions --- */
    #metrics-menu {
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    /* Show menu when hovering root or while JS adds .hovering for grace period */
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }
    /* Rotate chevron when open */
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
    
    /* New style for simulating 65% zoom on the main content */
    #scale-wrapper {
        /* Apply the scale transformation */
        transform: scale(0.65); 
        transform-origin: top center; /* Scale from the top-center */
        
        /* Adjustments to compensate for the scaling effect on surrounding content */
        height: 154%; /* Approx 1 / 0.65 to ensure vertical space is reserved */
        padding-bottom: 200px;
        margin-bottom: -35%; /* Pull up content following the wrapper */
    }

    /* --- LEAFLET CONTROL STYLES (NEW) --- */
    .leaflet-control-map-dropdown {
      /* Base container for the control */
      padding: 0; 
      /* Pushes the control right to clear the zoom buttons (which are top-left) */
      margin-left: 45px; 
      margin-top: 5px; 
    }
    .leaflet-control-map-dropdown .dropdown-root {
      /* Mimic the style of the default leaflet controls */
      background: #fff;
      box-shadow: 0 1px 5px rgba(0,0,0,.65);
      border-radius: 4px;
      position: relative;
    }
    .leaflet-control-map-dropdown .nav-link {
        /* Style for the button */
        padding: 6px 10px;
        color: #333;
        font-weight: 500;
        font-size: 13px;
        line-height: 1.2;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    
    /* Hiding logic for the menu */
    .leaflet-control-map-dropdown .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 5px; 
        z-index: 1000;
        opacity: 0; visibility: hidden; transform: translateY(4px);
        pointer-events: none;
        transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    
    .leaflet-control-map-dropdown .dropdown-root.hovering .dropdown-menu {
        opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    .leaflet-control-map-dropdown .dropdown-root.hovering #map-selection-chevron {
        transform: rotate(180deg);
    }
    
    .leaflet-control-map-dropdown .dropdown-menu a {
        /* Styling the menu items */
        text-decoration: none;
        padding: 6px 12px;
        font-size: 13px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="index.html"   class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="metrics.html" class="nav-link border-b-2 border-transparent inline-flex items-center gap-1 cursor-pointer select-none">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="metrics.html"               class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="metrics/population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="metrics/employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="metrics/establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="metrics/income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="metrics/housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="metrics/education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="metrics/health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
            <a href="metrics/disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
            <a href="metrics/disasters_hurricanes.html"      class="block px-4 py-2 hover:bg-gray-50">Hurricanes</a>
          </div>
        </div>
      </div>

      <a href="literature.html"  class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="strategy.html"class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="about.html"   class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
            <div>
                <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
                <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
                    Population & Economic Dynamics in Puerto Rico
                </h1>
                <p class="mt-3 text-lg text-gray-700">
                    A graduate research project examining demographic shifts, out-migration, and sustainable development
                    strategies through linked data analysis and policy synthesis.
                </p>
                <div class="mt-5">
                    <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
                        <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
                        Hover over the map to see county / municipality details
                    </span>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 right-4 group">
          <div class="text-right">
            <span class="text-sm font-semibold text-gray-700 cursor-pointer group-hover:text-blue-700 transition">
              Project Customer: Puerto Rico Planning Board
            </span>
          </div>

          <div class="absolute right-0 bottom-full mb-2 w-96 bg-white text-gray-800 p-4 rounded-lg shadow-xl border border-gray-200 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50">
            <p class="text-gray-700 text-sm">
              The Planning Board oversees long-term economic development, demographic analysis, and land-use
              planning for Puerto Rico. This projectâ€™s interactive maps, municipal-level dashboards, and
              population change analyses provide actionable insights that could directly support their policy
              models and strategic decision-making.
            </p>
            <p class="text-sm mt-3">
              ðŸ”— <a href="https://jp.pr.gov" target="_blank" rel="noopener" class="text-blue-600 underline">
                Visit Puerto Rico Planning Board Website
              </a>
            </p>
          </div>
        </div>
      </header>

      <section class="card p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-gray-700 font-medium">Map shading by</div>
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
              <button id="metricPct" type="button"
                class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">% change</button>
              <button id="metricAbs" type="button"
                class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">abs change</button>
            </div>
            <button id="clearSel"
              class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
          </div>
        </div>
        <div id="map" class="mt-3">
          <div class="leaflet-control-container" id="map-dropdown-container">
            <div class="leaflet-top leaflet-left">
              <div class="leaflet-control leaflet-control-map-dropdown">
                <div class="relative dropdown-root" id="map-selection-dropdown-root">
                  <div class="nav-link inline-flex items-center gap-1 cursor-pointer select-none">
                    Metric Selection
                    <svg id="map-selection-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <div id="map-selection-menu" class="dropdown-menu w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5">
                    <div class="py-2">
                      <a href="metrics/population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
                      <a href="metrics/employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
                      <a href="metrics/establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
                      <a href="metrics/income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
                      <a href="metrics/housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
                      <a href="metrics/education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
                      <a href="metrics/health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
                      <a href="metrics/disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
                      <a href="metrics/disasters_hurricanes.html"      class="block px-4 py-2 hover:bg-gray-50">Hurricanes</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
      </section>

      <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Population details</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div>
            <div class="text-sm">
              <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
              <div>Centroid: <span id="d-centroid" class="text-gray-600">â€”</span></div>
            </div>

            <div class="mt-4 text-sm">
              <div class="font-semibold text-gray-700">Population (Vintage 2024):</div>
              <ul class="mt-1 space-y-1">
                <li>2024: <span id="d-2024" class="font-semibold">â€”</span></li>
                <li>Change since 2010: <span id="d-chg" class="font-semibold">â€”</span></li>
                <li>2023â†’2024: <span id="d-2324" class="font-semibold">â€”</span></li>
              </ul>
            </div>

            <div class="mt-4 text-sm">
              <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">
                Open on data.census.gov â†—
              </a>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Population trend (2010â€“2024)</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="lineChart"></canvas>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Annual % Change</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
      </section>
      
      <hr class="border-gray-300">

      <section class="card p-6 space-y-6">
        <h2 class="text-lg font-semibold">Synthesis of Puerto Rico's Dynamics</h2>

        <div class="space-y-4">
          <h3 class="text-base font-semibold text-gray-700">The Core Challenge: Demographic Decline and Economic Headwinds</h3>
          <p>
            The population decline observed in the charts is the visible outcome of a complex, interconnected crisis. Puerto Rico faces severe <strong>demographic headwinds</strong>â€”including very low fertility and rapid agingâ€”which are amplified by sustained <strong>out-migration</strong>, especially among the working-age population.
          </p>
          <p>
            This demographic contraction has been driven by deep-seated <strong>economic fragility</strong>. The structural weaknesses exposed by the phase-out of Section 936 tax benefits led to industrial decline, lower average wages, and limited opportunities, pushing residents to the U.S. mainland.
          </p>
        </div>

        <div class="space-y-4">
          <h3 class="text-base font-semibold text-gray-700">Strategic Imperative: Building Local Resilience</h3>
          <p>
            A sustainable path forward requires shifting the focus from externally dependent industries to a resilient, <strong>locally anchored economic base</strong>. Strategic solutions must address the drivers of out-migration by pairing economic expansion with investments in social and physical infrastructure:
          </p>
          <ul class="list-disc list-inside ml-4 mt-2 space-y-1 text-gray-700 text-sm">
            <li><strong>Talent Retention:</strong> Implement career ladders, competitive wages, and "Return to PR" pathways to keep and attract working-age talent.</li>
            <li><strong>Local Industry:</strong> Support Small and Medium Enterprises (SMEs) in tradable services, agro-tech, and cultural clusters to grow local industry.</li>
            <li><strong>Resilience:</strong> Invest in hazard-resilient housing and school/health anchors to stabilize neighborhoods and address pervasive poverty and inequality.</li>
          </ul>
        </div>
      </section>
      </main>
  </div>

  <div class="fixed bottom-8 right-8 z-[9999]">
    <a href="metrics.html" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-full shadow-2xl transition transform hover:scale-105 font-bold text-lg no-underline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Metrics Overview
    </a>
  </div>

  <script>
    // ---------------------- Data paths ----------------------
    const GEOJSON_URL = './data/tl_2022_72_cousub/pr_municipalities.geojson';
    const POP_JSON    = './data/population/prm-est2010_2024.json'; // UPDATED dataset

    // ---------------------- Years (expanded) ----------------------
    const YEARS = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024];

    // ---------------------- Formatters ----------------------
    const fmt = new Intl.NumberFormat('en-US');
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signed = (n) => (n > 0 ? '+' : '') + fmt.format(n);

    // ---------------------- Choropleth colors ----------------------
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];

    // Default % breaks (â‰¤-10, -10â€“-6, -6â€“-3, -3â€“0, 0â€“2, >2)
    const PCT_BREAKS = [-10, -6, -3, 0, 2];

    // Computed later from data for abs change
    let ABS_BREAKS = [-10000, -6000, -3000, 0, 1000];

    // ---------------------- Helpers ----------------------
    function sanitizeName(s){ return String(s||'').trim(); }
    function valFromRow(row, y){
      const v = row?.[String(y)];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    // ---------------------- Stats (now baseline = 2010) ----------------------
    function statsForMunicipio(name){
      name = sanitizeName(name);
      const row = _rows.find(r => sanitizeName(r.Municipio) === name) ||
                  _rows.find(r => sanitizeName(r.Municipio) === name.replace(/\s*Municipio$/,''));
      if (!row) return null;

      const vals = YEARS.map(y => valFromRow(row, y));
      if (vals.some(v => !Number.isFinite(v))) return null;

      const idx2010 = YEARS.indexOf(2010);
      const idx2024 = YEARS.indexOf(2024);
      const pop2010 = vals[idx2010];
      const pop2024 = vals[idx2024];

      const abs = pop2024 - pop2010;
      const pctTot = (abs / pop2010) * 100;

      // Annual % changes (2010â†’2011 â€¦ 2023â†’2024)
      const pctYear = [];
      for (let i=1;i<YEARS.length;i++){
        pctYear.push(((vals[i]-vals[i-1]) / vals[i-1]) * 100);
      }
      return { vals, abs, pctTot, pctYear, pop2024 };
    }

    function censusLink(name){
      const g = '040XX00US72'; // Puerto Rico profile
      return `https://data.census.gov/profile/Puerto_Rico?g=${g}`;
    }

    // ---------------------- Charts ----------------------
    let lineChart = null, barChart = null;
    function drawCharts(name, st){
      if (!st) return;
      const ctxL = document.getElementById('lineChart').getContext('2d');
      const ctxB = document.getElementById('barChart').getContext('2d');

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctxL, {
        type: 'line',
        data: { labels: YEARS, datasets:[{ label:'Population', data: st.vals, tension:.2, pointRadius:3 }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmt.format(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>fmt.format(v) } } },
          maintainAspectRatio: false
        }
      });

      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}â†’${y}`);
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: { labels, datasets:[{ label:'% change', data: st.pctYear.map(v=>+v.toFixed(2)) }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } },
          maintainAspectRatio: false
        }
      });
    }

    // ---------------------- DOM targets ----------------------
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2024 = document.getElementById('d-2024');
    const dChg  = document.getElementById('d-chg');
    const d2324 = document.getElementById('d-2324');
    const dCenL = document.getElementById('d-census');

    function updateDetails(name, st, centroid){
      dName.textContent = name;
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : 'â€”';
      d2024.textContent = Number.isFinite(st?.pop2024) ? fmt.format(st.pop2024) : 'â€”';
      dChg.textContent  = st ? `${signed(st.abs)} (${pctFmt(st.pctTot)})` : 'â€”';
      const last = st && st.pctYear.length ? st.pctYear[st.pctYear.length-1] : NaN;
      d2324.textContent = Number.isFinite(last) ? pctFmt(last) : 'â€”';
      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    // ---------------------- Map + data ----------------------
    let _rows = [], map, layer, fc, legend;
    let currentMode = 'pct'; // 'pct' | 'abs'
    let lockedName = null;
    let selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    (async function init(){
      // Load population rows (2010â€“2024 JSON)
      const res = await fetch(POP_JSON, { cache:'no-store' });
      _rows = await res.json();

      // Map
      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap: .25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Initialize the map dropdown control
      L.Control.MapDropdown = L.Control.extend({
          onAdd: function(map) {
              const container = L.DomUtil.get('map-dropdown-container');
              L.DomEvent.disableClickPropagation(container);
              L.DomEvent.disableScrollPropagation(container);
              return container.querySelector('.leaflet-control-map-dropdown');
          },
          onRemove: function(map) {}
      });
      new L.Control.MapDropdown({ position: 'topleft' }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const geoid = p.GEOID || p.geoid || '';
          const shortName = name.replace(/\s*Municipio$/,'');
          const st = statsForMunicipio(shortName);
          const changeLine = st
            ? `<br><small>2010â†’2024: ${signed(st.abs)} (${st.pctTot.toFixed(2)}%)</small>`
            : '';
          lyr.bindTooltip(name, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${name}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(shortName, statsForMunicipio(shortName), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = shortName;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      // Compute ABS breaks from data (uses 2010 baseline via st.abs)
      computeAbsBreaks();

      // Legend control
      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend();
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      // Initial details
      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName), null);

      // UI wiring
      wireMetricToggle();
      wireClearSelection();
      wireDropdown();
      wireMapDropdown(); // NEW: Call the new function
    })();

    // ---------- Metric toggle ----------
    function wireMetricToggle(){
      const btnPct = document.getElementById('metricPct');
      const btnAbs = document.getElementById('metricAbs');

      function setActive(mode){
        currentMode = mode;
        btnPct.classList.toggle('bg-blue-600', mode==='pct');
        btnPct.classList.toggle('text-white', mode==='pct');
        btnPct.classList.toggle('hover:bg-gray-50', mode!=='pct');
        btnAbs.classList.toggle('bg-blue-600', mode==='abs');
        btnAbs.classList.toggle('text-white', mode==='abs');
        btnAbs.classList.toggle('hover:bg-gray-50', mode!=='abs');

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend();
      }

      btnPct.addEventListener('click', () => setActive('pct'));
      btnAbs.addEventListener('click', () => setActive('abs'));
      setActive(currentMode);
    }

    // Clear selection + reset zoom
    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    // Style function based on current mode
    function styleForFeature(feature){
      const p = feature.properties || {};
      const name = (p.NAME || p.NAMELSAD || p.name || 'Unknown').replace(/\s*Municipio$/,'');
      const st = statsForMunicipio(name);
      const value = !st ? NaN : (currentMode === 'pct' ? st.pctTot : st.abs);
      const breaks = (currentMode === 'pct') ? PCT_BREAKS : ABS_BREAKS;
      const col = colorFor(value, breaks);
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    // Utility: color for a value given breaks
    function colorFor(value, breaks) {
      if (!Number.isFinite(value)) return '#93c5fd';
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    // Legend render (UPDATED titles to 2010 baseline)
    function renderLegend(){
      if (!legend || !legend._div) return;
      const breaks = (currentMode === 'pct') ? PCT_BREAKS : ABS_BREAKS;
      const title  = (currentMode === 'pct') ? 'Change since 2010 â€” %' : 'Change since 2010 â€” people';

      const labels = [];
      function row(color, label) {
        return `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
                  <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                               border:1px solid rgba(0,0,0,.15)"></span>
                  <span>${label}</span>
                </div>`;
      }
      const fmtRange = (a,b) => (currentMode==='pct')
          ? `${a}% to ${b}%`
          : `${signed(a)} to ${signed(b)}`;

      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      labels.push(row(CHORO_COLORS[0], (currentMode==='pct') ? `â‰¤ ${breaks[0]}%` : `â‰¤ ${signed(breaks[0])}`));
      labels.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1])));
      labels.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2])));
      labels.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3])));
      labels.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4])));
      labels.push(row(CHORO_COLORS[5], (currentMode==='pct') ? `> ${breaks[4]}%` : `> ${signed(breaks[4])}`));

      legend._div.innerHTML = labels.join('');
    }

    // Compute ABS breaks from current data (quantile-ish, robust)
    function computeAbsBreaks(){
      const values = [];
      (fc.features || []).forEach(f => {
        const p = f.properties || {};
        const name = (p.NAME || p.NAMELSAD || p.name || 'Unknown').replace(/\s*Municipio$/,'');
        const st = statsForMunicipio(name);
        if (st && Number.isFinite(st.abs)) values.push(st.abs);
      });
      const neg = values.filter(v => v < 0).sort((a,b)=>a-b);
      const pos = values.filter(v => v > 0).sort((a,b)=>a-b);
      const q = (arr, t) => {
        if (!arr.length) return null;
        const i = (arr.length - 1) * t;
        const lo = Math.floor(i), hi = Math.ceil(i);
        if (lo === hi) return arr[lo];
        return arr[lo] * (hi - i) + arr[hi] * (i - lo);
      };
      const n1 = q(neg, 0.2) ?? -1000;
      const n2 = q(neg, 0.5) ?? -500;
      const n3 = q(neg, 0.8) ?? -100;
      const p1 = q(pos, 0.5) ?? 100;
      ABS_BREAKS = [n1, n2, n3, 0, p1];
    }

    // Dropdown functionality
    function wireDropdown() {
      // Wires the main navigation dropdown (top of page)
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');

      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }

      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    // --- NEW FUNCTION: Wires the map dropdown (top-left of map) ---
    function wireMapDropdown() {
        const root = document.getElementById('map-selection-dropdown-root');
        if (!root) return;
        let hoverTimeout;
        const menu = document.getElementById('map-selection-menu');

        function addHovering(){ 
            clearTimeout(hoverTimeout); 
            root.classList.add('hovering'); 
        }
        function removeHovering(){ 
            hoverTimeout = setTimeout(()=>{
                root.classList.remove('hovering');
            }, 300); 
        }

        root.addEventListener('mouseenter', addHovering);
        root.addEventListener('mouseleave', removeHovering);
        if (menu) {
            menu.addEventListener('mouseenter', addHovering);
            menu.addEventListener('mouseleave', removeHovering);
        }
    }
  </script>
</body>
</html>