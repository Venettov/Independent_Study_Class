<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); overflow:visible; }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }
    .mini { min-height: 260px; }

    /* Dropdown */
    #metrics-menu{opacity:0;visibility:hidden;transform:translateY(4px);pointer-events:none;transition:opacity .15s,transform .15s,visibility .15s}
    #metrics-dropdown-root:hover #metrics-menu,#metrics-dropdown-root.hovering #metrics-menu{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto}
    #metrics-dropdown-root:hover #metrics-chevron,#metrics-dropdown-root.hovering #metrics-chevron{transform:rotate(180deg)}
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <!-- Top nav -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="index.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold">Home</a>
      <div class="relative" id="metrics-dropdown-root">
        <a href="metrics.html" class="nav-link border-b-2 border-transparent inline-flex items-center gap-1 cursor-pointer select-none">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="metrics.html"               class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="metrics/population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="metrics/employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="metrics/establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="metrics/income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="metrics/housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="metrics/education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="metrics/health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>
      <a href="literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- Hero -->
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">Population & Economic Dynamics in Puerto Rico</h1>
          <p class="mt-3 text-lg text-gray-700">A graduate research project examining demographic shifts, out-migration, and sustainable development strategies through linked data analysis and policy synthesis.</p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see county / municipality details
            </span>
          </div>
        </div>
      </div>
      <div class="absolute bottom-4 right-4 group">
        <div class="text-right">
          <span class="text-sm font-semibold text-gray-700 cursor-pointer group-hover:text-blue-700 transition">Project Customer: Puerto Rico Planning Board</span>
        </div>
        <div class="absolute right-0 bottom-full mb-2 w-96 bg-white text-gray-800 p-4 rounded-lg shadow-xl border border-gray-200 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50">
          <p class="text-gray-700 text-sm">The Planning Board oversees long-term economic development, demographic analysis, and land-use planning for Puerto Rico. This projectâ€™s interactive maps, municipal dashboards, and population change analyses provide actionable insights for policy.</p>
          <p class="text-sm mt-3">ðŸ”— <a href="https://jp.pr.gov" target="_blank" rel="noopener" class="text-blue-600 underline">Visit Puerto Rico Planning Board Website</a></p>
        </div>
      </div>
    </header>

    <!-- Map + controls -->
    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricPct" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">% change</button>
            <button id="metricAbs" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">abs change</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <!-- Detail + charts -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Population details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">â€”</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Population (latest available):</div>
            <ul class="mt-1 space-y-1">
              <li><span id="d-latest-year">â€”</span>: <span id="d-latest" class="font-semibold">â€”</span></li>
              <li>Change since <span id="d-base-year">2010</span>: <span id="d-chg" class="font-semibold">â€”</span></li>
              <li><span id="d-lastpair">â€”</span>: <span id="d-lastpct" class="font-semibold">â€”</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">Open on data.census.gov â†—</a>
          </div>

          <div id="d-note" class="mt-3 text-xs text-amber-700 hidden">
            Note: This municipioâ€™s series begins after 2010. Stats use the earliest year available.
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2" id="trendTitle">Population trend (2010â€“2024)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChart"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Annual % Change</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Paths & constants ----------
    const GEOJSON_URL = './data/tl_2022_72_cousub/pr_municipalities.geojson';
    const POP_JSON    = './data/population/pr_pr_2010_2024.json';
    const BASELINE_YEAR = 2010;

    // ---------- Formatters ----------
    const fmt  = new Intl.NumberFormat('en-US');
    const pct2 = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signed = (n) => (n>0?'+':'') + fmt.format(n);

    // ---------- Colors / breaks ----------
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    const PCT_BREAKS = [-10, -6, -3, 0, 2];
    let ABS_BREAKS = [-10000, -6000, -3000, 0, 1000];

    function colorFor(value, breaks) {
      if (!Number.isFinite(value)) return '#93c5fd';
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    // ---------- Data holders ----------
    const seriesByName = new Map(); // name -> [{year, population}]
    let YEARS = []; // global domain (will be 2010..2024)

    // ---------- Helpers ----------
    const dNote = document.getElementById('d-note');
    function showNote(show){ dNote.classList.toggle('hidden', !show); }
    function sanitizeName(s){ return String(s||'').replace(/^\s*[.\-â€¢]\s*/, '').trim(); }

    function censusLink(name){ return `https://data.census.gov/profile/Puerto_Rico?g=040XX00US72`; }

    // Align a municipioâ€™s data to the full global domain (fill missing with null for charts)
    function alignToDomain(arr, yearsDomain) {
      const byYear = new Map(arr.map(d => [Number(d.year), Number(d.population)]));
      return yearsDomain.map(y => ({
        year: y,
        population: byYear.has(y) ? byYear.get(y) : null
      }));
    }

    // Stats relative to 2010 if present; otherwise earliest available year for that municipio.
    function statsForMunicipio(name){
      const nm = sanitizeName(name);
      const raw = seriesByName.get(nm);
      if (!raw || !raw.length) return null;

      const aligned = alignToDomain([...raw].sort((a,b)=>a.year-b.year), YEARS);
      const years = aligned.map(d=>d.year);
      const vals  = aligned.map(d=>d.population);

      const latestIdx = vals.length - 1;
      const latestYear = years[latestIdx];
      const latest = vals[latestIdx];

      const baseIdx2010 = years.indexOf(BASELINE_YEAR);
      // find first non-null value
      let firstIdx = vals.findIndex(v => v !== null && Number.isFinite(v));
      if (firstIdx === -1) return null;

      const has2010 = baseIdx2010 !== -1 && vals[baseIdx2010] !== null;
      const baseIdx = has2010 ? baseIdx2010 : firstIdx;
      const baseYearUsed = years[baseIdx];
      const base = vals[baseIdx];

      // Build YoY % using only consecutive non-null pairs
      const pctYear = [];
      for (let i=1;i<vals.length;i++){
        const a = vals[i-1], b = vals[i];
        if (a !== null && b !== null) pctYear.push(((b-a)/a)*100);
        else pctYear.push(null);
      }

      const abs = (latest!==null && base!==null) ? (latest - base) : null;
      const pctTot = (latest!==null && base) ? ((latest - base) / base) * 100 : null;

      // last valid YoY pair label/value
      let lastPair = 'â€”', lastPct = null;
      for (let i=pctYear.length-1;i>=0;i--){
        if (pctYear[i] !== null) { lastPair = `${years[i]}â†’${years[i+1]}`; lastPct = pctYear[i]; break; }
      }

      return { years, vals, pctYear, latest, latestYear, lastPair, lastPct, abs, pctTot, baseYearUsed };
    }

    // ---------- Charts ----------
    let lineChart = null, barChart = null;

    function drawCharts(name, st){
      if (!st) return;
      const ctxL = document.getElementById('lineChart').getContext('2d');
      const ctxB = document.getElementById('barChart').getContext('2d');

      // Build line data (nulls render as gaps)
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctxL, {
        type: 'line',
        data: { labels: st.years, datasets:[{ label:'Population', data: st.vals, spanGaps:false, tension:.2, pointRadius:2 }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> c.parsed.y==null ? 'No data' : fmt.format(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>fmt.format(v) } }, x:{ ticks:{ autoSkip:true } } },
          maintainAspectRatio: false
        }
      });

      // YoY % labels across full domain (year-1 â†’ year)
      const labels = [];
      for (let i=1;i<st.years.length;i++){ labels.push(`${st.years[i-1]}â†’${st.years[i]}`); }
      const barData = st.pctYear.map(v => v==null ? null : +v.toFixed(2));

      if (barChart) barChart.destroy();
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: { labels, datasets:[{ label:'% change', data: barData }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> c.parsed.y==null ? 'No data' : pct2(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pct2(v) } } },
          maintainAspectRatio: false
        }
      });
    }

    // ---------- DOM ----------
    const dName   = document.getElementById('d-name');
    const dCent   = document.getElementById('d-centroid');
    const dLatest = document.getElementById('d-latest');
    const dLatestY= document.getElementById('d-latest-year');
    const dBaseY  = document.getElementById('d-base-year');
    const dChg    = document.getElementById('d-chg');
    const dPair   = document.getElementById('d-lastpair');
    const dLastPct= document.getElementById('d-lastpct');
    const dCenL   = document.getElementById('d-census');
    const trendTitle = document.getElementById('trendTitle');

    function updateDetails(name, st, centroid){
      dName.textContent = name;
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : 'â€”';
      if (st){
        dLatestY.textContent = st.latestYear ?? 'â€”';
        dLatest.textContent  = (st.latest==null) ? 'â€”' : fmt.format(st.latest);
        dBaseY.textContent   = st.baseYearUsed ?? BASELINE_YEAR;
        dChg.textContent     = (st.abs==null || st.pctTot==null) ? 'â€”' : `${signed(st.abs)} (${pct2(st.pctTot)})`;
        dPair.textContent    = st.lastPair ?? 'â€”';
        dLastPct.textContent = (st.lastPct==null) ? 'â€”' : pct2(st.lastPct);
        showNote(st.baseYearUsed !== BASELINE_YEAR);
      } else {
        dLatestY.textContent = 'â€”';
        dLatest.textContent  = 'â€”';
        dChg.textContent     = 'â€”';
        dPair.textContent    = 'â€”';
        dLastPct.textContent = 'â€”';
        showNote(false);
      }
      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    // ---------- Map ----------
    let map, layer, fc, legend;
    let currentMode = 'pct';
    let lockedName = null;
    let selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    function styleForFeature(feature){
      const p = feature.properties || {};
      const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
      const st = statsForMunicipio(name);
      const value = (!st || st.abs==null || st.pctTot==null)
        ? NaN
        : (currentMode === 'pct' ? st.pctTot : st.abs);
      const breaks = (currentMode === 'pct') ? PCT_BREAKS : ABS_BREAKS;
      const col = colorFor(value, breaks);
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    function renderLegend(){
      if (!legend || !legend._div) return;
      const breaks = (currentMode === 'pct') ? PCT_BREAKS : ABS_BREAKS;
      const title  = (currentMode === 'pct') ? `Change since ${BASELINE_YEAR} â€” %` : `Change since ${BASELINE_YEAR} â€” people`;
      const fmtRange = (a,b) => (currentMode==='pct') ? `${a}% to ${b}%` : `${signed(a)} to ${signed(b)}`;
      const row = (c,t)=>`<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;"><span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${c};border:1px solid rgba(0,0,0,.15)"></span><span>${t}</span></div>`;
      legend._div.innerHTML = [
        `<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`,
        row(CHORO_COLORS[0], (currentMode==='pct') ? `â‰¤ ${breaks[0]}%` : `â‰¤ ${signed(breaks[0])}`),
        row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1])),
        row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2])),
        row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3])),
        row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4])),
        row(CHORO_COLORS[5], (currentMode==='pct') ? `> ${breaks[4]}%` : `> ${signed(breaks[4])}`)
      ].join('');
    }

    function computeAbsBreaks(){
      const values = [];
      (fc.features || []).forEach(f => {
        const p = f.properties || {};
        const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
        const st = statsForMunicipio(name);
        if (st && st.abs!=null) values.push(st.abs);
      });
      const neg = values.filter(v=>v<0).sort((a,b)=>a-b);
      const pos = values.filter(v=>v>0).sort((a,b)=>a-b);
      const q = (arr,t)=>{ if(!arr.length) return null; const i=(arr.length-1)*t, lo=Math.floor(i), hi=Math.ceil(i); return lo===hi?arr[lo]:arr[lo]*(hi-i)+arr[hi]*(i-lo); };
      const n1 = q(neg,0.2) ?? -1000, n2 = q(neg,0.5) ?? -500, n3 = q(neg,0.8) ?? -100, p1 = q(pos,0.5) ?? 100;
      ABS_BREAKS = [n1,n2,n3,0,p1];
    }

    function wireMetricToggle(){
      const btnPct = document.getElementById('metricPct');
      const btnAbs = document.getElementById('metricAbs');
      function setActive(mode){
        currentMode = mode;
        btnPct.classList.toggle('bg-blue-600', mode==='pct'); btnPct.classList.toggle('text-white', mode==='pct'); btnPct.classList.toggle('hover:bg-gray-50', mode!=='pct');
        btnAbs.classList.toggle('bg-blue-600', mode==='abs'); btnAbs.classList.toggle('text-white', mode==='abs'); btnAbs.classList.toggle('hover:bg-gray-50', mode!=='abs');
        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend();
      }
      btnPct.addEventListener('click', () => setActive('pct'));
      btnAbs.addEventListener('click', () => setActive('abs'));
      setActive(currentMode);
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function add(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function rem(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', add); root.addEventListener('mouseleave', rem);
      if (menu) { menu.addEventListener('mouseenter', add); menu.addEventListener('mouseleave', rem); }
    }

    // ---------- Boot ----------
    (async function init(){
      // 1) Load population JSON (cache-busted)
      const res = await fetch(POP_JSON + (POP_JSON.includes('?')?'&':'?') + 'cb=' + Date.now(), { cache:'no-store' });
      const raw = await res.json();

      // Accept array, single object, or dict-of-arrays
      if (Array.isArray(raw)) {
        raw.forEach(obj => { if (obj?.name && Array.isArray(obj.series)) seriesByName.set(sanitizeName(obj.name), obj.series.map(d=>({year:+d.year, population: d.population==null?null:+d.population}))); });
      } else if (raw?.name && Array.isArray(raw.series)) {
        seriesByName.set(sanitizeName(raw.name), raw.series.map(d=>({year:+d.year, population: d.population==null?null:+d.population})));
      } else if (raw && typeof raw === 'object') {
        for (const [k,v] of Object.entries(raw)) {
          if (Array.isArray(v)) seriesByName.set(sanitizeName(k), v.map(d=>({year:+d.year, population: d.population==null?null:+d.population})));
        }
      }

      // 2) Build global YEARS (full domain)
      const yearSet = new Set();
      for (const arr of seriesByName.values()) arr.forEach(d => yearSet.add(+d.year));
      YEARS = Array.from(yearSet).sort((a,b)=>a-b);
      if (YEARS.length) {
        const first = Math.min(...YEARS), last = Math.max(...YEARS);
        // Force domain to start at 2010 if present anywhere; otherwise start at first available
        const start = YEARS.includes(2010) ? 2010 : first;
        YEARS = Array.from({length: (last - start + 1)}, (_,i)=> start + i);
        const tt = document.getElementById('trendTitle');
        if (tt) tt.textContent = `Population trend (${YEARS[0]}â€“${YEARS[YEARS.length-1]})`;
      }

      // 3) Map
      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap: .25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const st = statsForMunicipio(name);
          const changeLine = (st && st.abs!=null && st.pctTot!=null)
            ? `<br><small>Since ${st.baseYearUsed}: ${signed(st.abs)} (${pct2(st.pctTot)})</small>`
            : '';
          lyr.bindTooltip(name, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${name}</strong>${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(name, statsForMunicipio(name), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l; lockedName = name; l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(name, statsForMunicipio(name), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      // 4) Abs breaks & legend
      computeAbsBreaks();
      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white'; div.style.padding = '8px 10px'; div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)'; div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div; renderLegend(); return div;
      };
      legend.addTo(map);
      function moveLegend(){ const el=legend._div; if(!el) return; el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px'; el.style.marginRight='8px'; }
      map.on('resize', moveLegend); moveLegend();

      // 5) Initial details (prefer Puerto Rico aggregate if present)
      const initName = seriesByName.has('Puerto Rico') ? 'Puerto Rico' : (fc.features?.[0]?.properties?.NAME || 'Puerto Rico');
      updateDetails(initName, statsForMunicipio(initName), null);

      // 6) UI wiring
      wireMetricToggle(); wireClearSelection(); wireDropdown();
    })();
  </script>
</body>
</html>
