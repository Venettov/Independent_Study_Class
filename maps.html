<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Puerto Rico Municipalities</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20n69z7S+y9oRbywbydY+a/oYvSjY+yT5q4lQ4a4R28="
          crossorigin=""></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    #map {
      height: 85vh;
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    @media (min-height: 900px) {
      #map { height: 88vh; }
    }
    .leaflet-tooltip {
      background: rgba(255,255,255,0.95);
      border-color: #333;
      color: #333;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 5px 10px;
    }
  </style>
</head>
<body class="flex items-center justify-center p-8 min-h-screen">
  <div class="container mx-auto max-w-7xl w-full">
    <div class="bg-white rounded-xl p-6 shadow-lg">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Puerto Rico Municipalities</h1>
        <button id="resetBtn"
                class="px-3 py-2 rounded-lg border text-sm font-medium bg-gray-50 hover:bg-gray-100">
          Reset view
        </button>
      </div>
      <p class="text-gray-600 mb-4">Hover a municipality to see its name. Click to zoom.</p>
      <div id="map" class="rounded-lg"></div>
      <p id="errorMsg" class="hidden mt-4 text-sm text-red-600"></p>
      <p class="mt-3 text-xs text-gray-500">
        Basemap © OpenStreetMap contributors · Boundaries: TIGER/Line® (via your repo)
      </p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initial bounds covering Puerto Rico (incl. Vieques & Culebra)
      const prBounds = L.latLngBounds([ [17.85, -67.45], [18.55, -65.25] ]);

      const map = L.map('map', {
        zoomControl: true,
        attributionControl: true
      }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        minZoom: 7,
        maxZoom: 19
      }).addTo(map);

      const geojsonUrl = 'https://raw.githubusercontent.com/venettov/Independent_Study_Class/main/data/tl_2022_72_cousub/pr_municipalities.geojson';

      // Style helpers
      const defaultStyle = {
        fillColor: '#93c5fd', // light blue
        weight: 1.2,
        opacity: 1,
        color: '#111827',     // near-black stroke
        fillOpacity: 0.70
      };

      const highlightStyle = {
        weight: 3,
        color: '#374151',
        dashArray: '',
        fillOpacity: 0.9
      };

      // For consistent hover reset, we keep a reference to the layer
      let geojsonLayer = null;

      // Fetch GeoJSON
      fetch(geojsonUrl)
        .then((response) => {
          if (!response.ok) throw new Error(`HTTP ${response.status} fetching GeoJSON`);
          return response.json();
        })
        .then((fc) => {
          geojsonLayer = L.geoJSON(fc, {
            style: defaultStyle,
            onEachFeature: function (feature, layer) {
              const props = feature.properties || {};
              // Robust name fallback for TIGER/Line variants
              const muniName = props.NAME || props.NAMELSAD || props.name || 'Unknown';

              // Tooltip on hover
              layer.bindTooltip(muniName, {
                permanent: false,
                direction: 'center',
                className: 'leaflet-tooltip',
                offset: [0, 0]
              });

              // Interactions
              layer.on({
                mouseover: function (e) {
                  e.target.setStyle(highlightStyle);
                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    e.target.bringToFront();
                  }
                },
                mouseout: function (e) {
                  geojsonLayer.resetStyle(e.target);
                },
                click: function (e) {
                  map.fitBounds(e.target.getBounds(), { padding: [20, 20] });
                }
              });

              // Optional popup with a little more info if present
              const geoid = props.GEOID || props.geoid || '';
              if (geoid) {
                layer.bindPopup(`<strong>${muniName}</strong><br/><span style="font-size:12px">GEOID: ${geoid}</span>`);
              } else {
                layer.bindPopup(`<strong>${muniName}</strong>`);
              }
            }
          }).addTo(map);
        })
        .catch((err) => {
          console.error('Error loading GeoJSON:', err);
          const msg = document.getElementById('errorMsg');
          msg.textContent = 'There was a problem loading boundary data. Check the file path and that the repo is public.';
          msg.classList.remove('hidden');
        });

      // Reset button
      document.getElementById('resetBtn').addEventListener('click', () => {
        map.fitBounds(prBounds, { padding: [10, 10] });
      });

      // Press Escape to reset view
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') map.fitBounds(prBounds, { padding: [10, 10] });
      });

      // Ensure map resizes nicely when container changes
      window.addEventListener('resize', () => map.invalidateSize());
    });
  </script>
</body>
</html>
