<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Health Coverage Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Cards + hero */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }

    /* Map — trimmed height so charts show sooner */
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    /* Mini charts area */
    .mini { min-height: 260px; }

    /* --- Dropdown base state & transitions --- */
    #metrics-menu {
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    /* Show menu when hovering root or while JS adds .hovering for grace period */
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }
    /* Rotate chevron when open */
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
    
    /* New style for simulating 65% zoom on the main content */
    #scale-wrapper {
        /* Apply the scale transformation */
        transform: scale(0.65); 
        transform-origin: top center; /* Scale from the top-center */
        
        /* Adjustments to compensate for the scaling effect on surrounding content */
        height: 154%; /* Approx 1 / 0.65 to ensure vertical space is reserved */
        padding-bottom: 200px;
        margin-bottom: -35%; /* Pull up content following the wrapper */
    }

    /* --- LEAFLET CONTROL STYLES (FROM population.html) --- */
    .leaflet-control-map-dropdown {
      /* Base container for the control */
      padding: 0; 
      margin-left: 45px; /* Pushes the control right to clear the zoom buttons */
      margin-top: 5px; /* Move slightly down to align with zoom */
    }
    .leaflet-control-map-dropdown .dropdown-root {
      background: #fff;
      box-shadow: 0 1px 5px rgba(0,0,0,.65);
      border-radius: 4px;
      position: relative; 
    }
    .leaflet-control-map-dropdown .nav-link {
        padding: 6px 10px;
        color: #333;
        font-weight: 500;
        font-size: 13px;
        line-height: 1.2;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    
    .leaflet-control-map-dropdown .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 5px; 
        z-index: 1000;
        
        /* Hiding logic */
        opacity: 0; visibility: hidden; transform: translateY(4px);
        pointer-events: none;
        transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    
    .leaflet-control-map-dropdown .dropdown-root.hovering .dropdown-menu {
        opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    .leaflet-control-map-dropdown .dropdown-root.hovering #map-selection-chevron {
        transform: rotate(180deg);
    }
    
    .leaflet-control-map-dropdown .dropdown-menu a {
        text-decoration: none;
        padding: 6px 12px;
        font-size: 13px;
    }

    /* --- RADIAL MENU STYLES --- */
    #radial-menu-container { pointer-events: none; width: 300px; height: 300px; position: fixed; bottom: 0; right: 0; z-index: 9999; }
    
    #radial-trigger { pointer-events: auto; }
    
    /* Radial Item Base State */
    .radial-item {
        position: absolute;
        bottom: 7rem;
        right: 2rem;  
        width: 3rem; height: 3rem;
        border-radius: 50%;
        background-color: white;
        color: #4f46e5;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex; align-items: center; justify-content: center;
        text-decoration: none;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        z-index: 9990;

        /* CSS Variables for position */
        --tx: 0px;
        --ty: 0px;
        /* CSS Variables for Label Offset */
        --lx: 0px;
        --ly: 0px;
        /* CSS Variable for Label Rotation */
        --lr: 0deg;
        
        transform: translate(0, 0) scale(0.5);
    }
    
    /* Radial Item Open State */
    .radial-open .radial-item {
        opacity: 1;
        pointer-events: auto;
        transform: translate(var(--tx), var(--ty)) scale(1);
    }

    /* Radial Item Hover State */
    .radial-open .radial-item:hover { 
        background-color: #e0e7ff; 
        transform: translate(var(--tx), var(--ty)) scale(1.1); 
        z-index: 10005 !important; /* Stacking fix */
    }
    
    /* UPDATED RADIAL LABEL STYLES */
    .radial-label {
        position: absolute;
        left: 50%; 
        top: 50%; 
        /* Move label radially outward based on calculations AND rotate */
        transform: translate(calc(-50% + var(--lx)), calc(-50% + var(--ly))) rotate(var(--lr));
        transform-origin: center center;
        
        /* Visual Styles: White bg, Black text */
        background: rgba(255, 255, 255, 0.95); 
        color: black; 
        padding: 4px 8px; 
        border-radius: 6px; 
        font-size: 12px; 
        font-weight: 700;
        white-space: nowrap; 
        
        /* Visibility Control */
        opacity: 0; 
        transition: opacity 0.3s ease;
        pointer-events: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    /* Show ALL labels when menu is open */
    .radial-open .radial-label { 
        opacity: 1; 
    }

    #radial-trigger {
        position: absolute; bottom: 7rem; right: 2rem;
        width: 4rem; height: 4rem;
        border-radius: 50%;
        background-color: #4f46e5;
        color: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: transform 0.3s ease;
        z-index: 10000;
    }
    #radial-trigger:hover { transform: scale(1.05); background-color: #4338ca; }
    .radial-open #radial-trigger { transform: rotate(45deg); background-color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html"   class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html"               class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 bg-gray-100 font-semibold">Health</a>
            <a href="disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
            <a href="disasters_hurricanes.html"      class="block px-4 py-2 hover:bg-gray-50">Hurricanes</a>
          </div>
        </div>
      </div>

      <a href="../literature.html"  class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"   class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
            <div>
                <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
                <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
                    Population & Economic Dynamics in Puerto Rico
                </h1>
                <p class="mt-3 text-lg text-gray-700">
                    A graduate research project examining demographic shifts, out-migration, and sustainable development
                    strategies through linked data analysis and policy synthesis.
                </p>
                <div class="mt-5">
                    <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
                        <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
                        Hover over the map to see county / municipality details
                    </span>
                </div>
            </div>
        </div>
      </header>

      <section class="card p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-gray-700 font-medium">Map shading by</div>
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
              <button id="metricPct" type="button"
                class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">% Change in Coverage Gap</button>
              <button id="metricAbs" type="button"
                class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Absolute Coverage Gap</button>
            </div>
            <button id="clearSel"
              class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
          </div>
        </div>
        <div id="map" class="mt-3">
          <div class="leaflet-control-container" id="map-dropdown-container">
            <div class="leaflet-top leaflet-left">
              <div class="leaflet-control leaflet-control-map-dropdown">
                <div class="relative dropdown-root" id="map-selection-dropdown-root">
                  <div class="nav-link inline-flex items-center gap-1 cursor-pointer select-none">
                    Metric Selection
                    <svg id="map-selection-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <div id="map-selection-menu" class="dropdown-menu w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5">
                    <div class="py-2">
                      <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
                      <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
                      <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
                      <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
                      <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
                      <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
                      <a href="health.html"         class="block px-4 py-2 bg-gray-100 font-semibold">Health</a>
                      <a href="disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
                      <a href="disasters_hurricanes.html"      class="block px-4 py-2 hover:bg-gray-50">Hurricanes</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
      </section>

      <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Health Coverage Details</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div>
            <div class="text-sm">
              <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
              <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
            </div>

            <div class="mt-4 text-sm">
              <div class="font-semibold text-gray-700">Health Coverage Gap (Percentage Without Coverage):</div>
              <ul class="mt-1 space-y-1">
                <li>Latest Year (2023): <span id="d-latest" class="font-semibold">—</span></li>
                <li>Change since 2013: <span id="d-chg" class="font-semibold">—</span></li>
                <li>Latest Annual Change: <span id="d-annual-chg" class="font-semibold">—</span></li>
              </ul>
            </div>

            <div class="mt-4 text-sm">
              <a id="d-census" class="text-blue-600 underline" href="https://data.census.gov/table?q=S2701:+HEALTH+INSURANCE+COVERAGE+STATUS+Puerto+Rico" target="_blank" rel="noopener">
                Open on data.census.gov (S2701) ↗
              </a>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Percentage Without Coverage Trend (2013–2023)</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="lineChart"></canvas>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Annual Change in Coverage Gap (pp)</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="mt-6 pt-6 border-t border-gray-200">
          <h3 class="font-semibold mb-2">Comparison of Coverage Gap Change by Period (pp)</h3>
          <div class="w-full h-80 bg-gray-50 rounded p-3">
              <canvas id="compareChart"></canvas>
          </div>
        </div>
        <div class="mt-10 pt-6 border-t border-gray-200">
            <h3 class="text-xl font-semibold mb-3">Understanding the Health Coverage Trend</h3>
            <p class="text-gray-700 text-base">
                The striking, massive drop in the uninsured rate shown between 2014 and 2015 is not solely a reflection of real-world improvement. It is a combination of two major factors:
            </p>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700 mt-3 ml-4">
                <li>
                    <strong>Policy Effect:</strong> The implementation of the <strong>Affordable Care Act (ACA)</strong> and the corresponding expansion of government-funded healthcare (*Mi Salud*) in Puerto Rico dramatically increased public coverage, moving a large uninsured population into the insured category.
                </li>
                <li>
                    <strong>Data Discontinuity:</strong> The drop was <strong>amplified by a major methodological change</strong> in the U.S. Census Bureau's American Community Survey (ACS) starting in 2015. New, clearer questions were introduced that effectively captured public health insurance enrollment, whereas previous surveys often missed this information, leading to an artificially high "uninsured" rate before 2015.
                </li>
            </ul>
            
            <h3 class="text-xl font-semibold mt-6 mb-3">Analyzing Post-2015 Volatility</h3>
            <p class="text-gray-700 text-base">
                Since 2015, the uninsured rate has stabilized in the low single digits (4%–8%). However, the annual bar chart shows high volatility—small changes in this low rate result in noticeable positive or negative absolute percentage point swings. This suggests that the remaining uninsured population is <strong>highly susceptible to local economic shocks and mobility</strong>:
            </p>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700 mt-3 ml-4">
                <li>
                    <strong>Small Denominator Effect:</strong> Because the rate is so low, minor shifts in the number of uninsured individuals (the numerator) or the population (the denominator) can exaggerate the apparent percentage point change.
                </li>
                <li>
                    <strong>Economic and Migration Shocks:</strong> Post-2017 (Hurricane Maria) and during the COVID-19 pandemic, sudden job losses, business closures, and high migration rates created rapid, temporary shifts in employer-provided and public coverage, causing the year-to-year swings seen in the municipal data.
                </li>
                <li>
                    <strong>Hard-to-Reach Population:</strong> The population remaining uninsured tends to be complex—often young, highly mobile, or self-employed—making their rate difficult to measure precisely and highly sensitive to local economic events.
                </li>
            </ul>
        </div>
        <div class="mt-10 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-semibold mb-2">Research References:</h3>
            <ul class="list-disc list-inside ml-4 text-sm text-gray-700">
                <li>
                    <strong>Health Insurance Data:</strong> 
                    <a href="https://data.census.gov/cedsci/table?q=S2701" target="_blank" rel="noopener" class="text-blue-600 underline">ACS Table S2701: Health Insurance Coverage Status</a>
                </li>
                <li>
                    <strong>Public Health Context:</strong> Puerto Rico Department of Health (Departamento de Salud) & CMS Medicaid & CHIP Scorecard.
                </li>
                <li>
                    <strong>Processed Data Files:</strong> <em>municipios_acs_health_2013_2023_wide.json</em>
                </li>
            </ul>
        </div>
      </section>
    </main>
  </div>

  <div class="fixed bottom-8 right-8 z-[9998]">
    <a href="../metrics.html" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-full shadow-2xl transition transform hover:scale-105 font-bold text-lg no-underline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Metrics Overview
    </a>
  </div>

  <div id="radial-menu-container">
      <button id="radial-trigger" onclick="toggleRadialMenu()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
      </button>
  </div>

  <script>
    // ---------------------- Data paths ----------------------
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const HEALTH_JSON    = '../data/health/municipios_acs_health_2013_2023_wide.json';
    
    const YEARS = [2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];

    // ---------------------- Formatters ----------------------
    const fmtPct = (v) => `${(Number(v)||0).toFixed(1)}%`;
    const ppFmt = (v) => `${(Number(v)||0).toFixed(2)} pp`;
    const signedPP = (n) => (n > 0 ? '+' : '') + ppFmt(n);

    // ---------------------- Choropleth colors ----------------------
    // Note: Health Coverage Gap (Uninsured Rate) is LOWER is BETTER.
    // CHORO_COLORS are defined (Green -> Red) to reflect that lower values get better colors.
    const CHORO_COLORS = ['#15803d', '#22c55e', '#bbf7d0', '#f97316', '#b91c1c', '#7f1d1d']; 
    const PCT_BREAKS = [2.5, 4.0, 6.0, 8.0, 10.0]; // Latest Value Breaks (%)
    let ABS_BREAKS = [-4.0, -2.0, 0.0, 1.0, 2.0]; // Cumulative Change Breaks (pp)

    // Stores the global min and max values for the current map mode
    let _extremeValues = { min: Infinity, max: -Infinity };

    // Utility: color for a value given breaks
    function colorFor(value, breaks) {
      if (!Number.isFinite(value)) return '#93c5fd';
      
      // Because CHORO_COLORS is defined (Green -> Red), but the breaks are ascending,
      // we match the breaks to the colors directly to maintain the desired visual:
      // LOWEST Break (Best/Lowest Gap) -> CHORO_COLORS[0] (Deep Green)
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    // ---------------------- Helpers ----------------------
    function sanitizeName(s){ 
      return String(s||'').replace(/^\s*[.\-•]\s*/, '').replace(/\s*Municipio$/,'').trim(); 
    }

    function valFromRow(row, y){
      const v = row?.[String(y)];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }
    
    function statsForMunicipio(name){
      name = sanitizeName(name);
      const row = _rows.find(r => sanitizeName(r.Municipio) === name);
      if (!row) return null;

      const vals = YEARS.map(y => valFromRow(row, y));
      
      const firstYear = YEARS[0];
      const lastYear = YEARS[YEARS.length - 1];
      const changeAbs = row[`Cum_Change_${firstYear}_${lastYear}`];
      const changePct = row[`Cum_Pct_Change_${firstYear}_${lastYear}`];
      const annualChange = row[`Change_${YEARS[YEARS.length-2]}_${lastYear}`];
      
      if (vals.some(v => !Number.isFinite(v))) return null;
      
      const ppChangeYear = [];
      for (let i = 1; i < YEARS.length; i++) {
        ppChangeYear.push(vals[i] - vals[i - 1]);
      }
      
      const latestVal = vals[vals.length - 1];
      
      const val2015 = valFromRow(row, 2015) || NaN;
      const val2017 = valFromRow(row, 2017) || NaN;
      const val2021 = valFromRow(row, 2021) || NaN;
      const val2023 = valFromRow(row, 2023) || NaN;
      
      const chg_1517 = Number.isFinite(val2017) && Number.isFinite(val2015) ? val2017 - val2015 : NaN;
      const chg_2123 = Number.isFinite(val2023) && Number.isFinite(val2021) ? val2023 - val2021 : NaN;
      
      return { 
        vals, 
        abs: Number(changeAbs), 
        pctTot: Number(changePct), 
        ppChangeYear, 
        latestVal, 
        annualChange: Number(annualChange),
        chg_1517,
        chg_2123
      };
    }
    
    // NEW: Function to pre-calculate global min/max for the current metric
    function calculateExtremeValues() {
        _extremeValues = { min: Infinity, max: -Infinity };
        let valueKey;
        const firstYear = YEARS[0];
        const lastYear = YEARS[YEARS.length - 1];

        // Map modes to the correct data keys
        if (currentMode === 'abs') valueKey = `${lastYear}`; // 'abs' mode maps to latest (2023) uninsured percentage
        else if (currentMode === 'pct') valueKey = `Cum_Change_${firstYear}_${lastYear}`; // Cumulative Change in PP
        else return;

        // Iterate through all municipalities to find the global min and max value
        const municipioRows = _rows.filter(r => r.Municipio !== 'Puerto Rico' && !r.metadata);
        
        municipioRows.forEach(row => {
            const value = Number(row[valueKey]);

            if (Number.isFinite(value)) {
                _extremeValues.min = Math.min(_extremeValues.min, value);
                _extremeValues.max = Math.max(_extremeValues.max, value);
            }
        });
        
        // Handle floating point precision for comparison
        _extremeValues.min = parseFloat(_extremeValues.min.toFixed(2));
        _extremeValues.max = parseFloat(_extremeValues.max.toFixed(2));
    }


    function censusLink(name){
      return `https://data.census.gov/table?q=S2701:+HEALTH+INSURANCE+COVERAGE+STATUS+Puerto+Rico`;
    }

    // ---------------------- Charts ----------------------
    let lineChart = null, barChart = null, compareChart = null;
    
    function getMunicipioComparisonData() {
        const data = _rows
            .filter(r => r.Municipio !== 'Puerto Rico' && !r.metadata)
            .map(row => {
                const st = statsForMunicipio(row.Municipio);
                // Fallback for missing/NaN data in the comparison periods
                if (!st || !Number.isFinite(st.chg_1517) || !Number.isFinite(st.chg_2123)) return null; 
                return {
                    municipio: row.Municipio.replace(' Municipio', ''),
                    chg_1517: st.chg_1517,
                    chg_2123: st.chg_2123
                };
            })
            .filter(d => d !== null)
            .sort((a, b) => (a.chg_2123 + a.chg_1517) - (b.chg_2123 + b.chg_1517)); 

        const labels = data.map(d => d.municipio);
        const data1517 = data.map(d => d.chg_1517);
        const data2123 = data.map(d => d.chg_2123);
        
        return { labels, data1517, data2123 };
    }
    
    function drawCharts(name, st){
      if (!st) return;
      const ctxL = document.getElementById('lineChart').getContext('2d');
      const ctxB = document.getElementById('barChart').getContext('2d');
      const ctxC = document.getElementById('compareChart').getContext('2d'); 

      // --- 1. Line Chart (Coverage Trend) ---
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctxL, {
        type: 'line',
        data: { 
          labels: YEARS, 
          datasets:[{ 
            label:'% Without Coverage', 
            data: st.vals, 
            tension:.2, 
            pointRadius:4,
            borderColor: '#dc2626'
          }] 
        },
        options: {
          plugins:{ 
            legend:{ display:false }, 
            tooltip:{ callbacks:{ label:(c)=>fmtPct(c.parsed.y) } } 
          },
          scales:{ 
            y:{ 
              ticks:{ callback:v=>fmtPct(v) },
              title: { display: true, text: '% Without Coverage' }
            } 
          },
          maintainAspectRatio: false
        }
      });

      // --- 2. Bar Chart (Annual Change) ---
      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}–${y}`);
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: { 
          labels, 
          datasets:[{ 
            label:'Annual Change in Percentage Points (pp)', 
            data: st.ppChangeYear.map(v=>+v.toFixed(2)),
            backgroundColor: st.ppChangeYear.map(v => v < 0 ? '#15803d' : '#b91c1c') 
          }] 
        },
        options: {
          plugins:{ 
            legend:{ display:false }, 
            tooltip:{ callbacks:{ label:(c)=>signedPP(c.parsed.y) } } 
          },
          scales:{ 
            y:{ 
              ticks:{ callback:v=>ppFmt(v) },
              title: { display: true, text: 'Change in PP' }
            } 
          },
          maintainAspectRatio: false
        }
      });
      
      // --- 3. Comparison Chart (Full-Width View) ---
      if (compareChart) compareChart.destroy();
      
      // The chart will be a horizontal bar chart when displaying all municipios
      const compData = getMunicipioComparisonData();
      const numToShow = 20; // Show top 10 best and 10 worst
      
      // Filter/Slice the data to show top/bottom for Islandwide view, or show the current municipality if selected
      let displayLabels, display1517, display2123;
      
      if (name !== 'Puerto Rico' && Number.isFinite(st.chg_1517) && Number.isFinite(st.chg_2123)) {
          // Individual municipality view
          displayLabels = ['2015–2017 (Policy/Reform)', '2021–2023 (Post-Pandemic)'];
          display1517 = [st.chg_1517];
          display2123 = [st.chg_2123];
          
          compareChart = new Chart(ctxC, {
              type: 'bar',
              data: {
                  labels: displayLabels,
                  datasets: [
                      {
                          label: 'Change in Coverage Gap (pp)',
                          data: [st.chg_1517, st.chg_2123],
                          backgroundColor: [st.chg_1517 < 0 ? '#15803d' : '#b91c1c', st.chg_2123 < 0 ? '#15803d' : '#b91c1c']
                      }
                  ]
              },
              options: {
                  indexAxis: 'y', // Set to horizontal for single muni view for better label readability
                  plugins: { 
                    legend: { display: false }, 
                    tooltip: { callbacks: { label: (c) => signedPP(c.parsed.x) } } 
                  },
                  scales: {
                      x: { position: 'top', ticks: { callback: v => ppFmt(v) }, title: { display: true, text: 'Change in Percentage Points (pp)' } },
                      y: { ticks: { maxRotation: 0, minRotation: 0 } }
                  },
                  maintainAspectRatio: false
              }
          });
      } else {
          // Islandwide view: Show top/bottom 20 municipios
          const topN = compData.labels.slice(0, numToShow);
          const top1517N = compData.data1517.slice(0, numToShow);
          const top2123N = compData.data2123.slice(0, numToShow);

          compareChart = new Chart(ctxC, {
              type: 'bar',
              data: {
                  labels: topN,
                  datasets: [
                      {
                          label: '2015–2017 Change (pp)',
                          data: top1517N,
                          backgroundColor: top1517N.map(v => v < 0 ? '#22c55e' : '#f97316'), 
                          stack: 'stack1'
                      },
                      {
                          label: '2021–2023 Change (pp)',
                          data: top2123N,
                          backgroundColor: top2123N.map(v => v < 0 ? '#15803d' : '#b91c1c'), 
                          stack: 'stack2'
                      }
                  ]
              },
              options: {
                  indexAxis: 'y',
                  plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 10 } }, 
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${signedPP(c.parsed.x)}` } } 
                  },
                  scales: {
                      x: { position: 'top', ticks: { callback: v => ppFmt(v) }, title: { display: true, text: 'Change in Percentage Points (pp)' } },
                      y: { ticks: { autoSkip: false, maxRotation: 0, minRotation: 0 } }
                  },
                  maintainAspectRatio: false
              }
          });
      }
    }

    // ---------------------- DOM targets ----------------------
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const dLatest = document.getElementById('d-latest');
    const dChg  = document.getElementById('d-chg');
    const dAnnualChg = document.getElementById('d-annual-chg');
    const dCenL = document.getElementById('d-census');

    function updateDetails(name, st, centroid){
      dName.textContent = name;
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      
      dLatest.textContent = Number.isFinite(st?.latestVal) ? fmtPct(st.latestVal) : '—';
      dChg.textContent  = st ? signedPP(st.abs) : '—';
      dAnnualChg.textContent = st ? signedPP(st.annualChange) : '—';
      
      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    // ---------------------- Load data + map ----------------------
    let _rows = [];
    let map, layer, fc, legend;
    let currentMode = 'pct'; 

    let lockedName = null;
    let selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    (async function init(){
      const res = await fetch(HEALTH_JSON, { cache:'no-store' });
      const rawData = await res.json();
      _rows = rawData.filter(row => !row.metadata);

      // Calculate initial extremes
      calculateExtremeValues();


      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomControl: false, zoomSnap: .25 }).fitBounds(prBounds); // Hide default zoom

      // Add zoom controls back as a separate control
      L.control.zoom({ position: 'topleft' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Initialize the map dropdown control
      L.Control.MapDropdown = L.Control.extend({
          onAdd: function(map) {
              const container = L.DomUtil.get('map-dropdown-container');
              L.DomEvent.disableClickPropagation(container);
              L.DomEvent.disableScrollPropagation(container);
              return container.querySelector('.leaflet-control-map-dropdown');
          },
          onRemove: function(map) {}
      });
      new L.Control.MapDropdown({ position: 'topleft' }).addTo(map);


      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const geoid = p.GEOID || p.geoid || '';
          const statsName = sanitizeName(name);
          const st = statsForMunicipio(statsName);
          
          let changeLine = '';
          if (st) {
            const latest = fmtPct(st.latestVal);
            const change = signedPP(st.abs);
            changeLine = `<br><small>Without Coverage (2023): ${latest}<br>Change since ${YEARS[0]}: ${change}</small>`;
          }
          
          lyr.bindTooltip(name, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${name}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return; 
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(statsName, statsForMunicipio(statsName), c);
            },
            mouseout: e => {
              if (lockedName) return; 
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              const clickedName = sanitizeName(name);

              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = clickedName;
              l.setStyle(selectedOutline);

              map.fitBounds(l.getBounds(), { padding:[20,20] });

              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      computeAbsBreaks();

      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend();
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px'; 
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName), null);

      wireMetricToggle();
      wireClearSelection();
      wireDropdown(); // Main nav dropdown
      wireMapDropdown(); // NEW map dropdown
      initRadialMenu(); // Init radial menu
    })();

    // ---------- Metric toggle ----------
    function wireMetricToggle(){
      const btnPct = document.getElementById('metricPct');
      const btnAbs = document.getElementById('metricAbs');

      function setActive(mode){
        currentMode = mode;
        
        btnPct.classList.toggle('bg-blue-600', mode==='pct');
        btnPct.classList.toggle('text-white', mode==='pct');
        btnPct.classList.toggle('hover:bg-gray-50', mode!=='pct');
        btnAbs.classList.toggle('bg-blue-600', mode==='abs');
        btnAbs.classList.toggle('text-white', mode==='abs');
        btnAbs.classList.toggle('hover:bg-gray-50', mode!=='abs');
        
        // Re-calculate extremes before restyling
        calculateExtremeValues();

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);

        renderLegend();
      }

      btnPct.addEventListener('click', () => setActive('pct'));
      btnAbs.addEventListener('click', () => setActive('abs'));
      setActive(currentMode);
    }

    // Clear selection wiring (also zoom back to original bounds)
    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
        updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico'), null);
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    // Style function based on current mode
    function styleForFeature(feature){
      const p = feature.properties || {};
      const name = p.NAME || p.NAMELSAD || p.name || 'Unknown';
      const statsName = sanitizeName(name);
      const st = statsForMunicipio(statsName);
      
      const isLatestValue = currentMode === 'abs'; // 'abs' mode maps to latest (2023) uninsured percentage
      const value = !st ? NaN : (isLatestValue ? st.latestVal : st.abs);
      const breaks = isLatestValue ? PCT_BREAKS : ABS_BREAKS;
      
      const col = colorFor(value, breaks);
      
      // Default style
      let style = { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
      
      // >>> START: Custom logic to highlight only the single min and max values (Thicker Yellow Line) <<<
      if (Number.isFinite(value) && _extremeValues.min !== Infinity) {
          // Compare value to the globally calculated min and max, accounting for floating point
          const valRounded = parseFloat(value.toFixed(2));
          const isExtreme = valRounded === _extremeValues.min || valRounded === _extremeValues.max;
          
          // Only highlight if min is not equal to max (i.e., not all values are the same)
          if (isExtreme && _extremeValues.min !== _extremeValues.max) { 
              style.weight = 5;            // Thicker border
              style.color = '#facc15';     // Yellow border (tailwind yellow-400)
              style.dashArray = '';        // Solid line
              style.fillOpacity = 0.95;    // Max fill opacity to make the interior color stand out
          }
      }
      // >>> END: Custom logic to highlight only the single min and max values (Thicker Yellow Line) <<<

      return style;
    }

    // Legend render (updates title + ranges)
    function renderLegend(){
      if (!legend || !legend._div) return;
      
      const isLatestValue = currentMode === 'abs';
      const breaks = isLatestValue ? PCT_BREAKS : ABS_BREAKS;
      
      const title  = isLatestValue 
        ? `Coverage Gap (2023) — %` 
        : `Coverage Gap Change (${YEARS[0]}–${YEARS[YEARS.length-1]}) — pp`;

      const labels = [];
      function row(color, label) {
        return `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
                  <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                               border:1px solid rgba(0,0,0,.15)"></span>
                  <span>${label}</span>
                </div>`;
      }
      
      const fmtRange = (a,b) => isLatestValue 
          ? `${fmtPct(a)} to ${fmtPct(b)}` 
          : `${signedPP(a)} to ${signedPP(b)}`;
      const fmtValue = (v) => isLatestValue ? fmtPct(v) : signedPP(v);

      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      
      labels.push(row(CHORO_COLORS[0], `≤ ${fmtValue(breaks[0])}`));
      labels.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1])));
      labels.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2])));
      labels.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3])));
      labels.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4])));
      labels.push(row(CHORO_COLORS[5], `> ${fmtValue(breaks[4])}`));

      legend._div.innerHTML = labels.join('');
    }

    // Compute ABS breaks from current data (quantile-ish, robust)
    function computeAbsBreaks(){
      const values = [];
      _rows.filter(r => r.Municipio !== 'Puerto Rico').forEach(row => {
        const firstYear = YEARS[0];
        const lastYear = YEARS[YEARS.length - 1];
        const abs = row[`Cum_Change_${firstYear}_${lastYear}`];
        if (Number.isFinite(abs)) values.push(abs);
      });
      
      // Use fixed, common-sense breaks for percentage point change
      // Deep Green (Best Improvement) to Deep Red (Worst Deterioration)
      ABS_BREAKS = [-4.0, -2.0, 0.0, 1.0, 2.0];
    }
    
    // Dropdown functionality & active link
    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');

      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }

      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }
    
    function wireMapDropdown() {
        // Wires the new map selection dropdown (top left of map)
        const root = document.getElementById('map-selection-dropdown-root');
        if (!root) return;
        let hoverTimeout;
        const menu = document.getElementById('map-selection-menu');

        function addHovering(){ 
            clearTimeout(hoverTimeout); 
            root.classList.add('hovering'); 
        }
        function removeHovering(){ 
            hoverTimeout = setTimeout(()=>{
                root.classList.remove('hovering');
            }, 300); 
        }

        root.addEventListener('mouseenter', addHovering);
        root.addEventListener('mouseleave', removeHovering);
        if (menu) {
            menu.addEventListener('mouseenter', addHovering);
            menu.addEventListener('mouseleave', removeHovering);
        }
    }

    // --- RADIAL MENU LOGIC ---
    const menuItems = [
        { label: 'Population', href: 'population.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { label: 'Employment Rate', href: 'employment.html', icon: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
        { label: 'Establishments', href: 'establishments.html', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
        { label: 'Household Income', href: 'income.html', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
        { label: 'Housing Units', href: 'housing.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { label: 'Education', href: 'education.html', icon: 'M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z' },
        { label: 'Health', href: 'health.html', icon: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' },
        { label: 'Earthquakes', href: 'disasters_earthquakes.html', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
        { label: 'Hurricanes', href: 'disasters_hurricanes.html', icon: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' }
    ];

    function initRadialMenu() {
        const container = document.getElementById('radial-menu-container');
        const trigger = document.getElementById('radial-trigger');
        
        const totalAngle = 100; // Degrees of spread
        const radius = 180; // Distance from center
        const count = menuItems.length;
        const startAngle = -95; // Top (12 o'clock ish)
        const step = totalAngle / (count - 1);

        menuItems.forEach((item, index) => {
            const angleDeg = startAngle - (step * index); 
            const angleRad = angleDeg * (Math.PI / 180);
            
            // Icon coordinates
            const x = Math.round(radius * Math.cos(angleRad));
            const y = Math.round(radius * Math.sin(angleRad));

            // Label coordinates (offset further out for "red line" effect)
            const textGap = 75; // Distance from icon center to text
            const lx = Math.round(textGap * Math.cos(angleRad));
            const ly = Math.round(textGap * Math.sin(angleRad));

            const el = document.createElement('a');
            el.href = item.href;
            el.className = 'radial-item';
            el.style.transitionDelay = `${index * 0.03}s`;
            
            // Store coordinates in CSS variables on the element
            el.style.setProperty('--tx', `${x}px`);
            el.style.setProperty('--ty', `${y}px`);
            el.style.setProperty('--lx', `${lx}px`);
            el.style.setProperty('--ly', `${ly}px`);
            el.style.setProperty('--lr', `${angleDeg + 180}deg`); // Rotate text

            el.innerHTML = `
                <span class="radial-label">${item.label}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" />
                </svg>
            `;
            container.insertBefore(el, trigger);
        });
    }

    function toggleRadialMenu() {
        const container = document.getElementById('radial-menu-container');
        // Simply toggle class - CSS variables handle the positioning now
        container.classList.toggle('radial-open');
    }

    // Highlights active nav link
    document.addEventListener('DOMContentLoaded', () => {
      const metricsLink = document.querySelector('#metrics-dropdown-root > a');
      const isMetricsSubPage = window.location.pathname.includes('/metrics/');

      if (isMetricsSubPage) {
        metricsLink.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold');
        metricsLink.setAttribute('aria-current', 'page');
        
        const currentPathname = window.location.pathname.split('/').pop();
        const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
        if (subPageLink) {
          subPageLink.classList.add('bg-gray-100', 'font-semibold');
        }
      } else {
        document.querySelectorAll('.nav-link[href]').forEach(a => {
          if (a.href.endsWith(window.location.pathname)) {
            a.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold');
            a.setAttribute('aria-current', 'page');
          }
        });
      }
      wireMapDropdown(); // Ensure the map dropdown is also wired up on DOMContentLoaded
      initRadialMenu(); // Init Radial Menu
    });
  </script>
</body>
</html>