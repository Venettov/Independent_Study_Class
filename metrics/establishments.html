<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employer Establishment Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
    
    /* New style for simulating 65% zoom on the main content */
    #scale-wrapper {
        /* Apply the scale transformation */
        transform: scale(0.65); 
        transform-origin: top center; /* Scale from the top-center */
        
        /* Adjustments to compensate for the scaling effect on surrounding content */
        height: 154%; /* Approx 1 / 0.65 to ensure vertical space is reserved */
        padding-bottom: 200px;
        margin-bottom: -35%; /* Pull up content following the wrapper */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 bg-gray-100 font-semibold">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
          <div>
            <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
            <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
              Population & Economic Dynamics in Puerto Rico
            </h1>
            <p class="mt-3 text-lg text-gray-700">
              A graduate research project examining demographic shifts, out-migration, and sustainable development strategies through linked data analysis and policy synthesis.
            </p>
            <div class="mt-5">
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
                <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
                Hover over the map to see county / municipality details
              </span>
            </div>
            </div>
        </div>
      </header>

      <section class="card p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-gray-700 font-medium">Map shading by</div>
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
              <button id="metricNominalPct" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Change in Count (%)</button>
              <button id="metricNominalAbs" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Change in Count (Abs.)</button>
              <button id="metricRealPct" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Percent Change (%)</button>
            </div>
            <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
          </div>
        </div>
        <div id="map" class="mt-3"></div>
      </section>

      <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Employer Establishment details</h2>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          
          <div>
            <div class="text-sm">
              <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
              <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
            </div>

            <div class="mt-4 text-sm">
              <div class="font-semibold text-gray-700">Total Employer Establishments (Vintage 2023):</div>
              <ul class="mt-1 space-y-1">
                <li>2023 Count: <span id="d-2023" class="font-semibold">—</span></li>
                <li>2023 Placeholder: <span id="d-2023-real" class="font-semibold">—</span></li>
                <li>Change since 2012 (Absolute): <span id="d-chg" class="font-semibold">—</span></li>
                <li>Change since 2012 (Placeholder): <span id="d-chg-real" class="font-semibold">—</span></li>
              </ul>
            </div>

            <div class="mt-4 text-sm">
              <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">
                Open on Census CBP Data ↗
              </a>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Establishment Count Trend (2012–2023)</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="lineChartNominal"></canvas>
            </div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Annual % Change in Establishments</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="barChartNominal"></canvas>
            </div>
          </div>
          
          <div>
            <h3 class="font-semibold mb-2">Annual % Change (Nominal, Placeholder)</h3>
            <div class="mini bg-gray-50 rounded p-3">
              <canvas id="barChartReal"></canvas>
            </div>
          </div>
        </div>
        
        <h2 class="text-lg font-semibold mb-4 pt-8 border-t border-gray-200 mt-8">Understanding the Establishment Metrics</h2>
        <div class="space-y-4 text-gray-700">
          <p>
            The charts above illustrate the change in the number of Employer Establishments (businesses with paid employees) from 2012 to 2023. This metric reflects the dynamics of business formation and contraction at the local level.
          </p>
          
          <h3 class="font-semibold text-gray-800 pt-2">Nominal Count Trend (2012–2023)</h3>
          <p>
            The primary focus here is the total number of establishments (businesses) operating annually. The trend line shows the raw yearly count.
          </p>
          
          <ul class="list-disc list-inside space-y-2 ml-4">
            <li>
              <strong class="text-blue-600">Establishment Count Trend</strong> is the raw number of establishments, as reported by the Census Bureau's County Business Patterns (CBP) data.
            </li>
            <li>
              **Note on Placeholder Fields:** The "Real" income columns in the original data structure are retained here as placeholders (`null`) to ensure the JavaScript code runs without error. The visualization logic is therefore adjusted to focus entirely on Nominal (raw) counts.
            </li>
          </ul>

          <h3 class="font-semibold text-gray-800 pt-2">Annual Percentage Change</h3>
          <p>
            The bar chart below shows the year-over-year percentage change in the number of establishments.
          </p>

          <ul class="list-disc list-inside space-y-2 ml-4">
            <li>
              <strong class="text-blue-600">Annual % Change:</strong> A positive bar indicates a net growth in the number of operating businesses compared to the previous year, suggesting economic expansion or recovery.
            </li>
            <li>
              **Negative bars** indicate a net contraction or decline in the number of establishments, often pointing to economic headwinds or post-disaster business closure.
            </li>
          </ul>
        </div>
        </section>

      <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">File Sources</h2>
        <div class="space-y-4">
          <p>Data for this metric was derived from the U.S. Census Bureau:</p>
          <ul class="list-disc list-inside space-y-1">
            <li>
              <a href="https://data.census.gov/cedsci/table?g=0400000US72&tid=CB2300CBP.CB2300CBP"
                target="_blank" rel="noopener" class="text-blue-600 underline">
                2023 County Business Patterns (CBP) - Employer Establishments (NAICS 00)
              </a>
            </li>
            <li>
              <a href="https://wwwcensus.gov/data/tables/time-series/demo/popest/intercensal-2010-2020-puerto-rico-municipios.html"
                target="_blank" rel="noopener" class="text-gray-600">
                (Original file source for municipal boundaries/GeoJSON remains valid)
              </a>
            </li>
          </ul>

          <p>Specific files used:</p>
          <ul class="list-disc list-inside">
            <li>municipios_cbp_establishments_2010_2023_wide.json (site build)</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    // --- UPDATED: New file path and name for the establishment data
    const INCOME_JSON = '../data/employment_establishments/municipios_cbp_establishments_2010_2023_wide.json';

    // --- UPDATED: Years start at 2012 based on the new data file's structure
    const YEARS = [2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];

    // --- UPDATED: Format for standard number (count) and percentage
    const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    // The signed function is now used for counts (absolute change)
    const signed = (n) => (n > 0 ? '+' : '') + fmt.format(n);

    // Map Mode Identifiers
    const MODE_NOMINAL_PCT = 'nominal_pct';
    const MODE_NOMINAL_ABS = 'nominal_abs';
    const MODE_REAL_PCT    = 'real_pct';

    // Color breaks for choropleth map
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    
    // --- UPDATED: Breaks suitable for Establishment Count % Change (e.g., -10% to +30%)
    const NOMINAL_PCT_BREAKS = [-10, 0, 10, 20, 30]; 
    // --- UPDATED: Breaks suitable for Establishment Absolute Change (e.g., 10 to 50 counts)
    let NOMINAL_ABS_BREAKS = [10, 20, 30, 40, 50]; 
    // --- UPDATED: Using Nominal % Breaks as a placeholder for the unused 'Real' metric
    const REAL_PCT_BREAKS = [-10, 0, 10, 20, 30]; 
    
    const sanitizeName = s => String(s||'').trim();
    
    // Stores the global min and max values for the current map mode
    let _extremeValues = { min: Infinity, max: -Infinity };

    // Helper to extract nominal value (Establishment Count)
    const yearVal = (row,y) => {
      const v = row?.[String(y)];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    };
    
    // Helper to extract real value (Will now return NaN or null placeholder)
    const realYearVal = (row,y) => {
      const v = row?.[`RealIncome_${y}`];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    };


    let lineChartNominal = null, barChartNominal = null, barChartReal = null;
    
    // Element IDs for the new detail structure
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2023 = document.getElementById('d-2023');
    const d2023Real = document.getElementById('d-2023-real');
    const dChg  = document.getElementById('d-chg');
    const dChgReal = document.getElementById('d-chg-real');
    const dCenL = document.getElementById('d-census');

    // --- REPLACED: Updated logic to manage nominal data and use nominal data for 'real' placeholders
    function statsForMunicipio(name){
      // 1. Normalize the name from the GeoJSON feature: remove "Municipio" suffix
      const nameKey = sanitizeName(name).replace(/\s*Municipio$/,'');
      
      // 2. Find the row, matching against the normalized name or the special PR case
      const row = _rows.find(r => 
        sanitizeName(r.Municipio) === nameKey || 
        (nameKey === 'Puerto Rico' && sanitizeName(r.Municipio) === 'Puerto Rico')
      );

      if (!row || row.metadata) return null;

      // Nominal Establishment Metrics (raw counts)
      const nominalVals = YEARS.map(y => yearVal(row,y));
      const nominalPctYear = [];
      for (let i=1;i<YEARS.length;i++){
        nominalPctYear.push(((nominalVals[i]-nominalVals[i-1]) / nominalVals[i-1]) * 100);
      }
      
      // Real Placeholders: Use nominal values for charting to avoid 'null' arrays,
      // but note that this data has no 'real'/inflation-adjusted meaning.
      const realVals = nominalVals.map(v => v); 
      const realPctYear = nominalPctYear.map(v => v);
      
      const firstYear = YEARS[0];
      const lastYear = YEARS[YEARS.length-1];

      // Use the pre-calculated cumulative fields in your JSON:
      const nominalCumAbs = row[`Cum_Change_${firstYear}_${lastYear}`];
      const nominalCumPct = row[`Cum_Pct_Change_${firstYear}_${lastYear}`];
      
      // Use Real fields from JSON (which are null placeholders) or default to Nominal if null
      const realCumAbs = row[`Real_Cum_Change_${firstYear}_${lastYear}`] || nominalCumAbs;
      const realCumPct = row[`Real_Cum_Pct_Change_${firstYear}_${lastYear}`] || nominalCumPct;
      
      const val2023 = nominalVals[nominalVals.length - 1];
      const realVal2023 = nominalVals[nominalVals.length - 1]; // Use nominal value for placeholder
      
      return { 
        nominalVals, nominalCumAbs, nominalCumPct, nominalPctYear, val2023, 
        realVals, realCumAbs, realCumPct, realPctYear, realVal2023 
      };
    }
    // --- END statsForMunicipio REPLACEMENT ---


    function censusLink(name){
      return `https://data.census.gov/cedsci/table?g=0400000US72&tid=CB2300CBP.CB2300CBP`;
    }

    function drawCharts(name, st){
      if (!st) return;
      const ctxLN = document.getElementById('lineChartNominal').getContext('2d');
      const ctxBN = document.getElementById('barChartNominal').getContext('2d');
      const ctxBR = document.getElementById('barChartReal').getContext('2d');

      // Nominal Line Chart (Establishment Count Trend)
      if (lineChartNominal) lineChartNominal.destroy();
      lineChartNominal = new Chart(ctxLN, {
        type: 'line',
        data: { labels: YEARS, datasets:[{ label:'Establishment Count', data: st.nominalVals, tension:.2, pointRadius:3 }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmt.format(c.parsed.y) } } },
          scales:{ 
            y:{ ticks:{ callback:v=>`${fmt.format(v)}` } }, 
            x:{ ticks:{ maxRotation: 90, minRotation: 90 } }
          },
          maintainAspectRatio:false
        }
      });

      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}→${y}`);
      
      // Nominal Bar Chart (Annual % Change)
      if (barChartNominal) barChartNominal.destroy();
      barChartNominal = new Chart(ctxBN, {
        type:'bar',
        data:{ labels, datasets:[{ 
          label:'% change', 
          data: st.nominalPctYear.map(v=>+v.toFixed(2)),
          // Added color logic based on positive/negative change
          backgroundColor: st.nominalPctYear.map(v => v < 0 ? '#b91c1c' : '#15803d') 
        }] },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } },
          maintainAspectRatio:false
        }
      });

      // Real Bar Chart (Placeholder - shows Nominal % Change for compatibility)
      if (barChartReal) barChartReal.destroy();
      barChartReal = new Chart(ctxBR, {
        type:'bar',
        data:{ labels, datasets:[{ 
          label:'% change (Nominal)', 
          data: st.realPctYear.map(v=>+v.toFixed(2)), // Uses nominal data
          // Added color logic based on positive/negative change
          backgroundColor: st.realPctYear.map(v => v < 0 ? '#b91c1c' : '#15803d') 
        }] },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } },
          maintainAspectRatio:false
        }
      });
    }

    function updateDetails(name, st, centroid){
      dName.textContent = name.replace(/\s*Municipio$/,'');
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      
      // Nominal fields
      d2023.textContent = Number.isFinite(st?.val2023) ? fmt.format(st.val2023) : '—';
      dChg.textContent  = st ? `${signed(st.nominalCumAbs)} (${pctFmt(st.nominalCumPct)})` : '—';
      
      // Real Placeholder fields (show nominal values)
      d2023Real.textContent = Number.isFinite(st?.realVal2023) ? fmt.format(st.realVal2023) : '—';
      // Use the Nominal Change for the Placeholder display since the underlying JSON data is null
      dChgReal.textContent  = st ? `${signed(st.nominalCumAbs)} (${pctFmt(st.nominalCumPct)})` : '—'; 

      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }
    
    // NEW: Function to pre-calculate global min/max for the current metric
    function calculateExtremeValues() {
        _extremeValues = { min: Infinity, max: -Infinity };
        let valueKey;
        if (currentMode === MODE_NOMINAL_PCT || currentMode === MODE_REAL_PCT) valueKey = `Cum_Pct_Change_${YEARS[0]}_${YEARS[YEARS.length - 1]}`;
        else if (currentMode === MODE_NOMINAL_ABS) valueKey = `Cum_Change_${YEARS[0]}_${YEARS[YEARS.length - 1]}`;
        else return;

        // Iterate through all municipalities to find the global min and max value
        // Note: Exclude the overall "Puerto Rico" row.
        const municipioRows = _rows.filter(r => r.Municipio !== 'Puerto Rico' && !r.metadata);
        
        municipioRows.forEach(row => {
            const value = Number(row[valueKey]);

            if (Number.isFinite(value)) {
                _extremeValues.min = Math.min(_extremeValues.min, value);
                _extremeValues.max = Math.max(_extremeValues.max, value);
            }
        });
        
        // Handle floating point precision for comparison
        _extremeValues.min = parseFloat(_extremeValues.min.toFixed(2));
        _extremeValues.max = parseFloat(_extremeValues.max.toFixed(2));
    }


    let _rows = [], map, layer, fc, legend;
    let currentMode = MODE_REAL_PCT; // Start on % Change, which now uses nominal
    let lockedName = null, selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    (async function init(){
      const res = await fetch(INCOME_JSON, { cache:'no-store' });
      _rows = await res.json();

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };
      
      // Calculate initial extremes
      calculateExtremeValues();

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const geoid = p.GEOID || p.geoid || '';
          
          const statsName = rawName.replace(/\s*Municipio$/,'');
          const stTip = statsForMunicipio(statsName);
          
          // --- UPDATED: Tooltip content now reflects Establishment change (2012-2023)
          const firstYear = YEARS[0];
          const lastYear = YEARS[YEARS.length-1];
          const changeLine = stTip
            ? `<br><small>${firstYear}→${lastYear}: ${signed(stTip.nominalCumAbs)} (${stTip.nominalCumPct.toFixed(2)}%)</small>`
            : '';
          
          lyr.bindTooltip(rawName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${rawName}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(statsName, statsForMunicipio(statsName), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              const clickedName = rawName.replace(/\s*Municipio$/,'');
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = clickedName;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      computeAbsBreaks();

      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend(currentMode);
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName), null);

      wireMetricToggle();
      wireClearSelection();
      wireDropdown();
    })();

    function wireMetricToggle(){
      const btnNomPct = document.getElementById('metricNominalPct');
      const btnNomAbs = document.getElementById('metricNominalAbs');
      const btnRealPct = document.getElementById('metricRealPct');

      function setActive(mode){
        currentMode = mode;
        
        [btnNomPct, btnNomAbs, btnRealPct].forEach(btn => {
          const isActive = (btn.id === 'metricNominalPct' && mode === MODE_NOMINAL_PCT) ||
                           (btn.id === 'metricNominalAbs' && mode === MODE_NOMINAL_ABS) ||
                           (btn.id === 'metricRealPct' && mode === MODE_REAL_PCT);
          btn.classList.toggle('bg-blue-600', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('hover:bg-gray-50', !isActive);
        });
        
        // Calculate extremes after setting the mode
        calculateExtremeValues();

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend(currentMode);
      }

      btnNomPct.addEventListener('click', () => setActive(MODE_NOMINAL_PCT));
      btnNomAbs.addEventListener('click', () => setActive(MODE_NOMINAL_ABS));
      btnRealPct.addEventListener('click', () => setActive(MODE_REAL_PCT));
      
      setActive(currentMode); // Initialize the state
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function styleForFeature(feature){
      const p = feature.properties || {};
      const rawName = (p.NAME || p.NAMELSAD || p.name || 'Unknown');
      const name = rawName.replace(/\s*Municipio$/,''); 
      const st = statsForMunicipio(name);
      
      if (!st) {
        // Default style for missing data
        return { fillColor: '#93c5fd', weight: 1.2, color:'#111827', fillOpacity:.15 }; 
      }

      let value;
      let breaks;
      let valueKey;

      if (currentMode === MODE_NOMINAL_PCT) {
          value = st.nominalCumPct;
          breaks = NOMINAL_PCT_BREAKS;
          valueKey = `Cum_Pct_Change_${YEARS[0]}_${YEARS[YEARS.length - 1]}`;
      } else if (currentMode === MODE_NOMINAL_ABS) {
          value = st.nominalCumAbs;
          breaks = NOMINAL_ABS_BREAKS;
          valueKey = `Cum_Change_${YEARS[0]}_${YEARS[YEARS.length - 1]}`;
      } else if (currentMode === MODE_REAL_PCT) {
          // Use Nominal % Change for the placeholder mode
          value = st.nominalCumPct;
          breaks = REAL_PCT_BREAKS;
          valueKey = `Cum_Pct_Change_${YEARS[0]}_${YEARS[YEARS.length - 1]}`;
      }
      
      const col = colorFor(value, breaks);
      
      // Default style
      let style = { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
      
      // >>> START: Custom logic to highlight only the single min and max values (Thicker Yellow Line) <<<
      if (Number.isFinite(value) && _extremeValues.min !== Infinity) {
          // Compare value to the globally calculated min and max, accounting for floating point
          const valRounded = parseFloat(value.toFixed(2));
          const isExtreme = valRounded === _extremeValues.min || valRounded === _extremeValues.max;
          
          // Only highlight if min is not equal to max (i.e., not all values are the same)
          if (isExtreme && _extremeValues.min !== _extremeValues.max) { 
              style.weight = 5;            // Thicker border
              style.color = '#facc15';     // Yellow border (tailwind yellow-400)
              style.dashArray = '';        // Solid line
              style.fillOpacity = 0.95;    // Max fill opacity to make the interior color stand out
          }
      }
      // >>> END: Custom logic to highlight only the single min and max values (Thicker Yellow Line) <<<
      
      return style;
    }

    function colorFor(value, breaks) {
      if (!Number.isFinite(value)) return '#93c5fd';
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    function renderLegend(mode){
      if (!legend || !legend._div) return;
      
      let breaks;
      let title;
      let isPct;

      if (mode === MODE_NOMINAL_PCT) {
          breaks = NOMINAL_PCT_BREAKS;
          title = 'Establishment Change 2012–2023 — % Change';
          isPct = true;
      } else if (mode === MODE_REAL_PCT) {
          breaks = REAL_PCT_BREAKS;
          title = 'Establishment Change 2012–2023 — % Change (Nominal)';
          isPct = true;
      } else {
          breaks = NOMINAL_ABS_BREAKS;
          title = 'Establishment Change 2012–2023 — Absolute Count';
          isPct = false;
      }

      const labels = [];
      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;
      
      // --- UPDATED: Format break to display count values properly (without $)
      const formatBreak = (val, isPct) => {
        if (isPct) {
            return `${(Math.round(val * 100) / 100)}%`;
        }
        // For non-percentage (Absolute Change) use 'Count' formatting
        return `${val > 0 ? '+' : ''}${fmt.format(val)}`;
      };
      
      const fmtRange = (a,b,isPct) => `${formatBreak(a, isPct)} to ${formatBreak(b, isPct)}`;
      
      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      labels.push(row(CHORO_COLORS[0], isPct ? `≤ ${formatBreak(breaks[0], true)}` : `≤ ${formatBreak(breaks[0], false)}`));
      labels.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1], isPct)));
      labels.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2], isPct)));
      labels.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3], isPct)));
      labels.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4], isPct)));
      labels.push(row(CHORO_COLORS[5], isPct ? `> ${formatBreak(breaks[4], true)}` : `> ${formatBreak(breaks[4], false)}`));

      legend._div.innerHTML = labels.join('');
    }

    function computeAbsBreaks(){
      // --- UPDATED: Breaks for Absolute Establishment Count Change
      // Logic to dynamically calculate breaks from the data is too complex without sample data.
      // Keeping the constant/placeholder breaks from the original file for now.
      NOMINAL_ABS_BREAKS = [10, 20, 30, 40, 50]; 
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Correcting the nav highlight for the current page
      const subPageLink = document.querySelector(`#metrics-menu a[href="establishments.html"]`);
      if (subPageLink) {
        document.querySelector(`#metrics-menu a[href="population.html"]`)?.classList.remove('bg-gray-100', 'font-semibold');
        subPageLink.classList.add('bg-gray-100','font-semibold');
      }
    });
  </script>
</body>
</html>