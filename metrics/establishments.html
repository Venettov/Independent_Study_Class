<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Custom styles preserved from original file */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease.
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- Navigation Structure (Retained) -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 bg-gray-100 font-semibold">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Employer Establishment Employment in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            Analysis of the change in the number of paid employees (All Industries, NAICS 00) at employer establishments
            across Puerto Rico's municipalities from 2012 to 2023.
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see county / municipality details
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Map Section (Structure Retained) -->
    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <!-- Removed Real Change Metric -->
            <button id="metricNominalPct" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Percent Change (%)</button>
            <button id="metricNominalAbs" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Absolute Change (Count)</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <!-- Details and Charts Section (Content Updated) -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Employer Establishment Employment details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <!-- Updated Detail Metric Label -->
            <div class="font-semibold text-gray-700">Total Paid Employees (2023):</div>
            <ul class="mt-1 space-y-1">
              <!-- d-2023 and d-chg are reused for employment counts -->
              <li>2023 (Count): <span id="d-2023" class="font-semibold">—</span></li>
              <!-- Removed the old Real Income fields -->
              <li>Change since 2012 (Count): <span id="d-chg" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="https://data.census.gov/cedsci/table?q=County%20Business%20Patterns%20Puerto%20Rico&tid=CBP2021.CB2100A15" target="_blank" rel="noopener">
              Open on data.census.gov ↗
            </a>
          </div>
        </div>

        <div>
          <!-- Updated Chart Title -->
          <h3 class="font-semibold mb-2">Employee Count Trend (2012–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartNominal"></canvas>
          </div>
        </div>

        <div>
          <!-- Updated Chart Title -->
          <h3 class="font-semibold mb-2">Annual % Change (Count)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChartNominal"></canvas>
          </div>
        </div>

        <div>
          <!-- Repurposed for Absolute Change as Real Data is unavailable -->
          <h3 class="font-semibold mb-2">Annual Absolute Change (Count)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChartReal"></canvas>
          </div>
        </div>
      </div>

      <!-- Updated Descriptive Text -->
      <h2 class="text-lg font-semibold mb-4 pt-8 border-t border-gray-200 mt-8">Understanding the Employment Metrics</h2>
      <div class="space-y-4 text-gray-700">
        <p>
          This visualization tracks the **Total Number of Paid Employees** in employer establishments across all industries (NAICS 00) within Puerto Rico, based on the U.S. Census Bureau's County Business Patterns (CBP).
          This data represents an annual snapshot taken on March 12th of each year.
        </p>

        <h3 class="font-semibold text-gray-800 pt-2">Employment Trend Analysis</h3>
        <p>
          The time series focuses purely on **Nominal Counts**, as employment figures are not typically adjusted for inflation (unlike income). Analyzing the data from 2012 to 2023 helps reveal the municipality-level dynamics of business health and job creation/loss over the past decade.
        </p>

        <ul class="list-disc list-inside space-y-2 ml-4">
          <li>
            <strong class="text-blue-600">Employee Count Trend:</strong> This line chart shows the raw number of employees over time. For Puerto Rico overall, the data shows an initial decline followed by a strong recovery and growth towards the end of the period.
          </li>
          <li>
            <strong class="text-blue-600">Annual % Change:</strong> This bar chart shows the year-over-year percentage increase or decrease in the number of paid employees. Positive bars indicate growth in the local job market.
          </li>
          <li>
            <strong class="text-green-600">Annual Absolute Change:</strong> This chart displays the raw numerical change in employee count, which is useful for showing the magnitude of employment shifts, especially in larger municipalities like San Juan, Ponce, and Bayamón.
          </li>
        </ul>

        <p class="mt-4">
          The map visually summarizes the **cumulative change in employee counts from 2012 to 2023**. Shading helps identify which municipalities have experienced the strongest growth (green/blue) or the most significant losses (red/orange) in employment during this period.
        </p>
      </div>
      </section>

    <!-- File Sources Section (Updated) -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <div class="space-y-4">
        <p>Data for the Employer Establishments (Paid Employees) was derived from the U.S. Census Bureau:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>
            <a href="https://data.census.gov/cedsci/table?q=County%20Business%20Patterns%20Puerto%20Rico&tid=CBP2021.CB2100A15"
               target="_blank" rel="noopener" class="text-blue-600 underline">
              U.S. Census Bureau, County Business Patterns (CBP), All Industries (NAICS 00)
            </a>
          </li>
          <li>
            <a href="https://www.census.gov/data/tables/time-series/demo/popest/intercensal-2010-2020-puerto-rico-municipios.html"
               target="_blank" rel="noopener" class="text-gray-600">
              (Original file source for municipal boundaries/GeoJSON remains valid)
            </a>
          </li>
        </ul>

        <p>Specific files used:</p>
        <ul class="list-disc list-inside">
          <li>municipios_cbp_total_employment_2010_2023_wide.json (site build & analysis)</li>
          <li>pr_municipalities.geojson (map boundary)</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // --- UPDATED CONSTANTS ---
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    // Updated JSON path to reflect the new employment data location/name
    const EMPLOYMENT_JSON = '../data/employment_establishments/municipios_cbp_total_employment_2010_2023_wide.json';

    // Updated years to reflect the start year of the new employment data (2012)
    const YEARS = [2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];
    const BASE_YEAR = 2012;

    // Format for whole numbers (counts) and percentage
    const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signed = (n) => (n > 0 ? '+' : '') + fmt.format(n);

    // Map Mode Identifiers (Removed REAL_PCT)
    const MODE_NOMINAL_PCT = 'nominal_pct';
    const MODE_NOMINAL_ABS = 'nominal_abs';
    
    // Color breaks for choropleth map (Retained)
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    
    // --- UPDATED BREAKS FOR EMPLOYMENT COUNTS (2012-2023 Change) ---
    // Employee Count PCT Change (2012-2023)
    const NOMINAL_PCT_BREAKS = [0, 10, 20, 40, 60]; 
    // Employee Count Absolute Change (2012-2023) - adjusted to hundreds/thousands of employees
    const NOMINAL_ABS_BREAKS = [-1000, -500, 0, 500, 1500]; 
    
    // Helper function for name sanitization
    const sanitizeName = s => String(s||'').trim();
    
    // Helper function to extract numerical value for a given year
    const yearVal = (row,y) => {
      const v = row?.[String(y)];
      const n = Number(v);
      // CBP data may have '0' for suppressed small counts, treat 0 as 0
      return Number.isFinite(n) ? n : 0; 
    };
    
    // Real values are not used for CBP data, but these functions are kept for structural compatibility 
    const realYearVal = (row,y) => 0; 
    
    
    let lineChartNominal = null, barChartNominal = null, barChartAbsolute = null; // barChartReal is now barChartAbsolute
    
    // Element IDs for the detail structure
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2023 = document.getElementById('d-2023');
    const dChg  = document.getElementById('d-chg');
    const dCenL = document.getElementById('d-census');

    function statsForMunicipio(name){
      // 1. Normalize the name from the GeoJSON feature: remove "Municipio" suffix
      const nameKey = sanitizeName(name).replace(/\s*Municipio$/,'');
      
      // 2. Find the row, matching against the normalized name or the special PR case
      const row = _rows.find(r => 
        sanitizeName(r.Municipio).replace(/\s*Municipio$/,'') === nameKey || 
        (nameKey === 'Puerto Rico' && sanitizeName(r.Municipio) === 'Puerto Rico')
      );

      if (!row || row.metadata) return null;

      // --- EMPLOYMENT METRICS (Nominal Counts) ---
      const nominalVals = YEARS.map(y => yearVal(row,y));
      
      // Annual % Change
      const nominalPctYear = [];
      for (let i=1;i<YEARS.length;i++){
        const currentVal = nominalVals[i];
        const prevVal = nominalVals[i-1];
        // FIX: Handle division by zero for initial years with 0 or NaN/null
        const pctChange = (prevVal > 0 && Number.isFinite(currentVal) && Number.isFinite(prevVal)) 
                            ? ((currentVal - prevVal) / prevVal) * 100
                            : 0; // Return 0 if the start value is 0 or non-finite
        nominalPctYear.push(pctChange);
      }
      
      // Annual Absolute Change
      const nominalAbsYear = [];
      for (let i=1;i<YEARS.length;i++){
        nominalAbsYear.push(nominalVals[i] - nominalVals[i-1]);
      }

      // Use the pre-calculated cumulative fields in your JSON:
      let nominalCumAbs = row.Cum_Change_2012_2023;
      let nominalCumPct = row.Cum_Pct_Change_2012_2023;
      
      // FIX: Handle Infinity from cumulative percentage change (occurs when base year 2012 is 0)
      if (!Number.isFinite(nominalCumPct) || nominalVals[0] === 0) {
        nominalCumPct = 0;
      }
      
      const val2023 = nominalVals[nominalVals.length - 1];

      return { 
        nominalVals, 
        nominalCumAbs: nominalCumAbs, 
        nominalCumPct: nominalCumPct, 
        nominalPctYear,
        nominalAbsYear, 
        val2023
      };
    }

    function censusLink(name){
      // Census CBP link is the same island-wide
      return `https://data.census.gov/cedsci/table?q=County%20Business%20Patterns%20Puerto%20Rico&tid=CBP2021.CB2100A15`;
    }

    // barChartReal is repurposed to display Annual Absolute Change
    function drawCharts(name, st){
      if (!st) return;
      const ctxLN = document.getElementById('lineChartNominal').getContext('2d');
      const ctxBN = document.getElementById('barChartNominal').getContext('2d');
      const ctxBA = document.getElementById('barChartReal').getContext('2d'); // Reused ID

      const chartOptions = {
        plugins:{ legend:{ display:false } },
        maintainAspectRatio:false
      };
      
      // Nominal Line Chart (Employee Count Trend)
      if (lineChartNominal) lineChartNominal.destroy();
      lineChartNominal = new Chart(ctxLN, {
        type: 'line',
        data: { labels: YEARS, datasets:[{ label:'Employee Count', data: st.nominalVals, tension:.2, pointRadius:3 }] },
        options: {
          ...chartOptions,
          plugins:{ ...chartOptions.plugins, tooltip:{ callbacks:{ label:(c)=>fmt.format(c.parsed.y) } } },
          scales:{ 
            y:{ ticks:{ callback:v=>fmt.format(v) } }, 
            x:{ ticks:{ maxRotation: 90, minRotation: 90 } }
          }
        }
      });

      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}→${y}`);
      
      // Nominal Bar Chart (% Change)
      if (barChartNominal) barChartNominal.destroy();
      barChartNominal = new Chart(ctxBN, {
        type:'bar',
        data:{ labels, datasets:[{ label:'% change', data: st.nominalPctYear.map(v=>+v.toFixed(2)) }] },
        options:{
          ...chartOptions,
          plugins:{ ...chartOptions.plugins, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } }
        }
      });

      // Annual Absolute Change Chart (Reusing barChartReal ID)
      if (barChartAbsolute) barChartAbsolute.destroy();
      barChartAbsolute = new Chart(ctxBA, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Count Change', data: st.nominalAbsYear.map(v=>+v.toFixed(0)) }] },
        options:{
          ...chartOptions,
          plugins:{ ...chartOptions.plugins, tooltip:{ callbacks:{ label:(c)=>signed(c.parsed.y) } } },
          // FIX: Use fmt.format for y-axis ticks (was using fmt.format(v).replace('$', '') from old income code)
          scales:{ y:{ ticks:{ callback:v=>fmt.format(v) } } } 
        }
      });
    }

    function updateDetails(name, st, centroid){
      dName.textContent = name.replace(/\s*Municipio$/,'');
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      
      // Nominal fields (now Employee Counts)
      d2023.textContent = Number.isFinite(st?.val2023) ? fmt.format(st.val2023) : '—';
      // Updated label text to reflect change from BASE_YEAR
      dChg.textContent  = st ? `${signed(st.nominalCumAbs)} (${pctFmt(st.nominalCumPct)})` : '—';
      
      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    let _rows = [], map, layer, fc, legend;
    // Default mode is Absolute Change (Count)
    let currentMode = MODE_NOMINAL_ABS; 
    let lockedName = null, selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    (async function init(){
      // Updated JSON constant name and path
      const res = await fetch(EMPLOYMENT_JSON, { cache:'no-store' });
      _rows = await res.json();

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // FIX: Added cache buster to GeoJSON fetch to ensure fresh data load if environment changes
      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = (p.NAME || p.NAMELSAD || p.name || 'Unknown');
          const geoid = p.GEOID || p.geoid || '';
          
          const statsName = rawName.replace(/\s*Municipio$/,'');
          const stTip = statsForMunicipio(statsName);
          
          // Updated tooltip to reflect change from BASE_YEAR
          const changeLine = stTip
            ? `<br><small>${BASE_YEAR}→2023: ${signed(stTip.nominalCumAbs)} (${stTip.nominalCumPct.toFixed(2)}%)</small>`
            : '';
          
          lyr.bindTooltip(rawName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${rawName}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(statsName, statsForMunicipio(statsName), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              const clickedName = rawName.replace(/\s*Municipio$/,'');
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = clickedName;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend(currentMode);
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName), null);

      wireMetricToggle();
      wireClearSelection();
      wireDropdown();
    })();

    function wireMetricToggle(){
      const btnNomPct = document.getElementById('metricNominalPct');
      const btnNomAbs = document.getElementById('metricNominalAbs');

      function setActive(mode){
        currentMode = mode;
        
        [btnNomPct, btnNomAbs].forEach(btn => { 
          const isActive = (btn.id === 'metricNominalPct' && mode === MODE_NOMINAL_PCT) ||
                           (btn.id === 'metricNominalAbs' && mode === MODE_NOMINAL_ABS);
          btn.classList.toggle('bg-blue-600', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('hover:bg-gray-50', !isActive);
        });

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend(currentMode);
      }

      btnNomPct.addEventListener('click', () => setActive(MODE_NOMINAL_PCT));
      btnNomAbs.addEventListener('click', () => setActive(MODE_NOMINAL_ABS));
      
      setActive(currentMode); // Initialize the state
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
        
        // Reset details to Puerto Rico aggregate
        const initName = 'Puerto Rico';
        updateDetails(initName, statsForMunicipio(initName), null);
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function styleForFeature(feature){
      const p = feature.properties || {};
      const rawName = (p.NAME || p.NAMELSAD || p.name || 'Unknown');
      const name = rawName.replace(/\s*Municipio$/,''); 
      const st = statsForMunicipio(name);
      
      if (!st) {
        // Fallback style for no data
        return { fillColor: '#93c5fd', weight: 1.2, color:'#111827', fillOpacity:.15 }; 
      }

      let value;
      let breaks;

      if (currentMode === MODE_NOMINAL_PCT) {
          value = st.nominalCumPct;
          breaks = NOMINAL_PCT_BREAKS;
      } else if (currentMode === MODE_NOMINAL_ABS) {
          value = st.nominalCumAbs;
          breaks = NOMINAL_ABS_BREAKS;
      } 
      
      const col = colorFor(value, breaks);
      
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    function colorFor(value, breaks) {
      // Ensure the value is a number, otherwise use fallback color
      if (!Number.isFinite(value)) return '#93c5fd'; 
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    function renderLegend(mode){
      if (!legend || !legend._div) return;
      
      let breaks;
      let title;
      let isPct;
      let formatFn;

      if (mode === MODE_NOMINAL_PCT) {
          breaks = NOMINAL_PCT_BREAKS;
          title = `Employee Change ${BASE_YEAR}–2023 — %`;
          isPct = true;
          formatFn = (val) => `${(Math.round(val * 10) / 10)}%`;
      } else { // MODE_NOMINAL_ABS
          breaks = NOMINAL_ABS_BREAKS;
          title = `Employee Change ${BASE_YEAR}–2023 — Count`;
          isPct = false;
          // Updated formatting to use signed helper for consistency
          formatFn = (val) => signed(val);
      }

      const labels = [];
      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;
      
      // *** FIX: Simplified fmtRange to use formatFn directly for cleaner display ***
      const fmtRange = (a,b) => {
        const start = formatFn(a);
        const end = formatFn(b);
        // Remove '+' sign from the start of ranges if they are positive, 
        // to display ranges like "1,000 to +3,000" rather than "+1,000 to +3,000"
        return `${start.startsWith('+') ? start.slice(1) : start} to ${end}`;
      };
      
      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      // For the lowest bucket, ensure the formatFn returns the correct signed value
      labels.push(row(CHORO_COLORS[0], `≤ ${formatFn(breaks[0])}`)); 
      labels.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1])));
      labels.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2])));
      labels.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3])));
      labels.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4])));
      labels.push(row(CHORO_COLORS[5], `> ${formatFn(breaks[4])}`));

      legend._div.innerHTML = labels.join('');
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const currentPathname = window.location.pathname.split('/').pop();
      // Ensure the correct link is highlighted in the dropdown
      const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
      if (subPageLink) subPageLink.classList.add('bg-gray-100','font-semibold');
    });
  </script>
</body>
</html>
