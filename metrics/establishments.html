<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1),
                 0 4px 6px -2px rgba(0,0,0,.05);
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg,#fafafa 0%,#f3f4f6 100%);
    }
    #map {height:48vh;width:100%;border-radius:.75rem;}
    @media (min-width:1280px){#map{height:46vh;}}
    @media (max-width:640px){#map{height:54vh;}}

    .leaflet-tooltip{
      background:rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }
    .mini{min-height:260px;}

    #metrics-menu{
      opacity:0;visibility:hidden;transform:translateY(4px);
      pointer-events:none;
      transition:opacity .15s ease,transform .15s ease,visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu{
      opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron{transform:rotate(180deg);}
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

<!-- Navigation -->
<nav class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
    <a href="../index.html" class="border-b-2 border-transparent">Home</a>
    <div class="relative" id="metrics-dropdown-root">
      <a href="../metrics.html"
         class="border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none"
         aria-current="page">
        Metrics
        <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg"
             class="w-4 h-4 transition-transform" viewBox="0 0 20 20"
             fill="currentColor"><path fill-rule="evenodd"
             d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z"
             clip-rule="evenodd"/></svg>
      </a>
      <div id="metrics-menu"
           class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
        <div class="py-2">
          <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
          <div class="my-1 border-t border-gray-100"></div>
          <a href="population.html" class="block px-4 py-2 hover:bg-gray-50">Population</a>
          <a href="employment.html" class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
          <a href="establishments.html" class="block px-4 py-2 bg-gray-100 font-semibold">Employer Establishments</a>
          <a href="income.html" class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
          <a href="housing.html" class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
          <a href="education.html" class="block px-4 py-2 hover:bg-gray-50">Education</a>
          <a href="health.html" class="block px-4 py-2 hover:bg-gray-50">Health</a>
        </div>
      </div>
    </div>
    <a href="../literature.html" class="border-b-2 border-transparent">Literature</a>
    <a href="../strategy.html" class="border-b-2 border-transparent">Strategy</a>
    <a href="../about.html" class="border-b-2 border-transparent">About</a>
  </div>
</nav>

<!-- Main -->
<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

  <!-- Hero -->
  <header class="card hero p-6 sm:p-8 lg:p-10 relative">
    <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
    <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
      Population & Economic Dynamics in Puerto Rico
    </h1>
    <p class="mt-3 text-lg text-gray-700">
      A graduate research project examining <strong>employer establishments</strong>,
      business structure, and economic diversification across Puerto Rico’s municipalities.
    </p>
    <div class="mt-5">
      <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
        <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
        Hover over the map to see municipality details
      </span>
    </div>
  </header>

  <!-- Map -->
  <section class="card p-4">
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm text-gray-700 font-medium">Map shading by</div>
      <div class="flex items-center gap-2">
        <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
          <button id="metricNominalPct" type="button"
                  class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">
            Nominal Change (%)
          </button>
          <button id="metricNominalAbs" type="button"
                  class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">
            Nominal Change (absolute)
          </button>
        </div>
        <button id="clearSel"
                class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">
          Clear selection
        </button>
      </div>
    </div>
    <div id="map" class="mt-3"></div>
  </section>
  <!-- Employer Establishments Details -->
  <section class="card p-6">
    <h2 class="text-lg font-semibold mb-4">Employer Establishments details</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left column -->
      <div>
        <div class="text-sm">
          <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
          <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
        </div>

        <div class="mt-4 text-sm">
          <div class="font-semibold text-gray-700">Employer Establishments (2023):</div>
          <ul class="mt-1 space-y-1">
            <li>2023: <span id="d-2023" class="font-semibold">—</span></li>
            <li>Change since 2012 (Nominal): <span id="d-chg" class="font-semibold">—</span></li>
          </ul>
        </div>

        <div class="mt-4 text-sm">
          <a id="d-census" class="text-blue-600 underline" href="https://www.census.gov/programs-surveys/cbp.html" target="_blank" rel="noopener">
            Open on census.gov ↗
          </a>
        </div>
      </div>

      <!-- Middle column: line chart -->
      <div>
        <h3 class="font-semibold mb-2">Total Establishments Trend (2012–2023)</h3>
        <div class="mini bg-gray-50 rounded p-3">
          <canvas id="lineChartNominal"></canvas>
        </div>
      </div>

      <!-- Right column: bar chart -->
      <div>
        <h3 class="font-semibold mb-2">Annual % Change (Nominal)</h3>
        <div class="mini bg-gray-50 rounded p-3">
          <canvas id="barChartNominal"></canvas>
        </div>
      </div>
    </div>

    <h2 class="text-lg font-semibold mb-4 pt-8 border-t border-gray-200 mt-8">
      Understanding the Establishment Metrics
    </h2>

    <div class="space-y-4 text-gray-700">
      <p>
        This page presents changes in the number of <strong>Employer Establishments</strong>
        across Puerto Rico municipalities between 2012 and 2023.
        Each establishment represents a business location with paid employees as reported by
        the U.S. Census Bureau’s County Business Patterns (CBP) program.
      </p>

      <h3 class="font-semibold text-gray-800 pt-2">What Nominal Change Means</h3>
      <p>
        Nominal change measures the raw increase or decrease in the number of establishments without
        adjusting for inflation or other economic factors. The two map modes allow you to visualize:
      </p>

      <ul class="list-disc list-inside space-y-2 ml-4">
        <li><strong>Nominal Change (%):</strong> Shows the percentage change in establishments from 2012 to 2023.</li>
        <li><strong>Nominal Change (absolute):</strong> Displays the actual increase or decrease in establishment counts over the same period.</li>
      </ul>

      <h3 class="font-semibold text-gray-800 pt-2">Why This Matters</h3>
      <p>
        Tracking establishment growth highlights local business development, economic resilience, and
        recovery trends following economic shocks such as the 2008 recession and Hurricanes Irma and Maria.
      </p>
    </div>
  </section>

  <!-- Sources -->
  <section class="card p-6">
    <h2 class="text-lg font-semibold mb-4">File Sources</h2>
    <div class="space-y-4">
      <p>
        Data derived from the U.S. Census Bureau’s <strong>County Business Patterns (CBP)</strong> program.
      </p>

      <ul class="list-disc list-inside space-y-1">
        <li>
          <a href="https://www.census.gov/programs-surveys/cbp.html"
             target="_blank" rel="noopener"
             class="text-blue-600 underline">
            County Business Patterns (CBP)
          </a>
        </li>
      </ul>

      <p>Specific files used:</p>
      <ul class="list-disc list-inside">
        <li>municipios_cbp_total_employment_2010_2023_wide.json (site build)</li>
        <li>municipios_cbp_total_employment_2010_2023_wide.csv (analysis)</li>
      </ul>
    </div>
  </section>
</main>
<!-- JavaScript -->
<script>
/* ---------- Paths (confirmed) ---------- */
const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
const EMPLOYMENT_JSON = '../data/employment_establishments/municipios_cbp_total_employment_2010_2023_wide.json';

/* ---------- Constants ---------- */
const YEARS = [2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];
const fmt = new Intl.NumberFormat('en-US');
const pctFmt = v => `${(Number(v)||0).toFixed(2)}%`;
const signed = n => (n>0?'+':'') + fmt.format(n);

const MODE_NOMINAL_PCT = 'nominal_pct';
const MODE_NOMINAL_ABS = 'nominal_abs';

const CHORO_COLORS = ['#7f1d1d','#b91c1c','#f97316','#bbf7d0','#22c55e','#15803d'];
const NOMINAL_PCT_BREAKS = [-30,-10,0,10,25];
const NOMINAL_ABS_BREAKS = [-300,-100,0,100,300];

/* ---------- State ---------- */
let map, geoLayer, _rows = [], _geojson, _mode = MODE_NOMINAL_PCT, selectedName = null;
let lineChartNominal = null, barChartNominal = null;

/* ---------- DOM ---------- */
const dName = document.getElementById('d-name');
const dCent = document.getElementById('d-centroid');
const d2023 = document.getElementById('d-2023');
const dChg  = document.getElementById('d-chg');

/* ---------- Helpers ---------- */
const sanitize = s => String(s ?? '').trim();
const toNum = v => {
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
};
const yearVal = (row, y) => toNum(row?.[String(y)]);

/* Get municipio display name from a GeoJSON feature robustly */
function getFeatureName(feature) {
  const p = feature?.properties || {};
  const raw =
    p.NAMELSAD ??
    p.NAME ??
    p.MUNICIPIO ??
    p.Municipio ??
    p.municipio ??
    '';
  return sanitize(raw)
    .replace(/ Municipio,?\s*Puerto Rico$/i, '')
    .replace(/ Municipio$/i, '')
    .trim();
}

/* Find the JSON row for a given (normalized) municipio name */
function rowForMunicipio(name) {
  const key = sanitize(name)
    .replace(/ Municipio,?\s*Puerto Rico$/i, '')
    .replace(/ Municipio$/i, '')
    .trim();
  return _rows.find(r => sanitize(r.Municipio) === key) || null;
}

/* Choropleth color */
function colorForValue(val, mode) {
  const breaks = mode === MODE_NOMINAL_ABS ? NOMINAL_ABS_BREAKS : NOMINAL_PCT_BREAKS;
  if (val <= breaks[0]) return CHORO_COLORS[0];
  if (val <= breaks[1]) return CHORO_COLORS[1];
  if (val <= breaks[2]) return CHORO_COLORS[2];
  if (val <= breaks[3]) return CHORO_COLORS[3];
  if (val <= breaks[4]) return CHORO_COLORS[4];
  return CHORO_COLORS[5];
}

/* Proper Leaflet legend control */
function legendControl() {
  const ctrl = L.control({ position: 'bottomright' });
  ctrl.onAdd = function() {
    const div = L.DomUtil.create('div', 'card p-2 text-xs bg-white rounded-lg shadow');
    const breaks = _mode === MODE_NOMINAL_ABS ? NOMINAL_ABS_BREAKS : NOMINAL_PCT_BREAKS;
    const unit = _mode === MODE_NOMINAL_ABS ? 'establishments' : '%';
    div.innerHTML = `<strong>${_mode === MODE_NOMINAL_ABS ? 'Nominal Change (absolute)' : 'Nominal Change (%)'}</strong><br>`;
    for (let i = 0; i < breaks.length; i++) {
      const from = breaks[i], to = breaks[i + 1];
      const swatch = `<i style="background:${colorForValue(from + 0.1, _mode)};width:12px;height:12px;display:inline-block;margin-right:4px;border-radius:2px"></i>`;
      div.innerHTML += `${swatch}${from}${to ? '–' + to : ''} ${unit}<br>`;
    }
    return div;
  };
  return ctrl;
}

let legend; // keep reference to update when mode changes

/* ---------- UI Updates ---------- */
function updateDetails(name, row) {
  dName.textContent = name;
  // You can replace this placeholder with a real centroid lookup if you have it:
  dCent.textContent = '—';
  d2023.textContent = Number.isFinite(row?.['2023']) ? fmt.format(row['2023']) : '—';
  const chg = toNum(row?.['Cum_Change_2012_2023']);
  dChg.textContent = Number.isFinite(chg) ? signed(chg) : '—';
}

function updateCharts(row) {
  const years = YEARS;
  const vals = years.map(y => yearVal(row, y));
  const pct = [];
  for (let i = 1; i < vals.length; i++) {
    const prev = vals[i - 1];
    const curr = vals[i];
    const pctVal = Number.isFinite(prev) && prev !== 0 ? ((curr - prev) / prev) * 100 : NaN;
    pct.push(pctVal);
  }

  const ctx1 = document.getElementById('lineChartNominal');
  const ctx2 = document.getElementById('barChartNominal');

  if (lineChartNominal) lineChartNominal.destroy();
  if (barChartNominal)  barChartNominal.destroy();

  lineChartNominal = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        label: 'Total Establishments',
        data: vals,
        borderColor: '#2563eb',
        tension: .2,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: { y: { ticks: { callback: v => fmt.format(v) } } },
      plugins: { legend: { display: false } }
    }
  });

  barChartNominal = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: years.slice(1),
      datasets: [{
        label: '% Change (Nominal)',
        data: pct,
        backgroundColor: '#60a5fa'
      }]
    },
    options: {
      responsive: true,
      scales: { y: { ticks: { callback: v => pctFmt(v) } } },
      plugins: { legend: { display: false } }
    }
  });
}

/* ---------- Map Paint ---------- */
function styleForFeature(feature) {
  const name = getFeatureName(feature);
  const row = rowForMunicipio(name);
  if (!row) return { color: '#999', weight: 1, fillColor: '#e5e7eb', fillOpacity: .7 };
  const val = _mode === MODE_NOMINAL_ABS ? toNum(row['Cum_Change_2012_2023'])
                                         : toNum(row['Cum_Pct_Change_2012_2023']);
  const fill = Number.isFinite(val) ? colorForValue(val, _mode) : '#e5e7eb';
  return { color: '#999', weight: 1, fillColor: fill, fillOpacity: .85 };
}

function repaintPolys() {
  geoLayer.setStyle(styleForFeature);
  // refresh legend to show correct units
  if (legend) legend.remove();
  legend = legendControl(); legend.addTo(map);
}

/* ---------- Init ---------- */
async function init() {
  try {
    const res = await fetch(EMPLOYMENT_JSON, { cache: 'no-store' });
    let data = await res.json();

    // ✅ Remove the metadata block if present
    if (Array.isArray(data) && data.length && data[data.length - 1].metadata) {
      data = data.slice(0, -1);
    }
    _rows = data;

    console.log("Loaded municipios:", _rows.length);
    console.log("Sample keys:", Object.keys(_rows[0]));

    const geoRes = await fetch(GEOJSON_URL, { cache: 'no-store' });
    _geojson = await geoRes.json();


    // Basic sanity check to surface issues quickly:
    if (!_rows.length) console.warn('Employment JSON loaded but contains 0 rows. Check file content/structure.');
    if (!_geojson?.features?.length) console.warn('GeoJSON loaded but contains 0 features. Check file path/format.');

    map = L.map('map', { scrollWheelZoom: true }).setView([18.22, -66.45], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    geoLayer = L.geoJSON(_geojson, {
      style: styleForFeature,
      onEachFeature: (feature, layer) => {
        const name = getFeatureName(feature);
        layer.bindTooltip(name, { direction: 'center', permanent: false });
        layer.on({
          mouseover: e => {
            e.target.setStyle({ weight: 2, color: '#000' });
            const row = rowForMunicipio(name);
            if (row) { updateDetails(name, row); updateCharts(row); }
          },
          mouseout: e => geoLayer.resetStyle(e.target),
          click:   () => {
            selectedName = name;
            const row = rowForMunicipio(name);
            if (row) { updateDetails(name, row); updateCharts(row); }
          }
        });
      }
    }).addTo(map);

    legend = legendControl(); legend.addTo(map);

    // Optional: show Puerto Rico totals on load if present
    const pr = _rows.find(r => sanitize(r.Municipio) === 'Puerto Rico');
    if (pr) { updateDetails('Puerto Rico', pr); updateCharts(pr); }

    setTimeout(() => map.invalidateSize(), 50);
  } catch (err) {
    console.error('Initialization error:', err);
  }
}

/* ---------- Buttons ---------- */
document.getElementById('metricNominalPct').addEventListener('click', () => {
  _mode = MODE_NOMINAL_PCT;
  repaintPolys();
});

document.getElementById('metricNominalAbs').addEventListener('click', () => {
  _mode = MODE_NOMINAL_ABS;
  repaintPolys();
});

document.getElementById('clearSel').addEventListener('click', () => {
  selectedName = null;
  dName.textContent = 'Puerto Rico';
  dCent.textContent = '—';
  d2023.textContent = '—';
  dChg.textContent  = '—';
  if (lineChartNominal) lineChartNominal.destroy();
  if (barChartNominal)  barChartNominal.destroy();
});

/* ---------- Kick off ---------- */
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
