<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico - Total Employment</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease.
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html"     class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 bg-gray-100 font-semibold">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Total Employment & Economic Dynamics in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            Examining the total number of paid employees in each municipio to understand shifts in the labor market 
            and local economic activity from **2012 to 2023** (County Business Patterns).
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see municipio employment details
            </span>
          </div>
        </div>
      </div>
    </header>

    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by cumulative change from 2012–2023</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricNominalPct" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Percent Change (%)</button>
            <button id="metricNominalAbs" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Absolute Change (Count)</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Total Employment details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Total Paid Employees (As of March 12, 2023):</div>
            <ul class="mt-1 space-y-1">
              <li>2023 Total: <span id="d-2023" class="font-semibold">—</span></li>
              <li>Change since 2012 (Absolute): <span id="d-chg-abs" class="font-semibold">—</span></li>
              <li>Change since 2012 (Percent): <span id="d-chg-pct" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="https://data.census.gov/cedsci/table?q=paid%20employees%20Puerto%20Rico&tid=CBP20.CB1900A11&g=0400000US72&vintage=2020" target="_blank" rel="noopener">
              Open on Census CBP Source ↗
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Total Employment Trend (2012–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartEmployment"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Annual Change (%)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChartPctChange"></canvas>
          </div>
        </div>
        
        <div class="col-span-1 lg:col-span-1">
          <h3 class="font-semibold mb-2">Annual Change (Count)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChartAbsChange"></canvas>
          </div>
        </div>
      </div>
      
      <h2 class="text-lg font-semibold mb-4 pt-8 border-t border-gray-200 mt-8">Understanding the Employment Metrics</h2>
      <div class="space-y-4 text-gray-700">
        <p>
          The charts and map illustrate the trajectory of **Total Paid Employees** (County Business Patterns - All Industries) in Puerto Rico's municipios from **2012 to 2023**. These figures represent the number of employees as of March 12 of each year.
        </p>
        
        <h3 class="font-semibold text-gray-800 pt-2">Employment Trend and Annual Change</h3>
        <p>
          The analysis uses **2012 as the base year** because data for 2010 and 2011 are unavailable or incomplete for most municipios in this specific dataset. The trend shows overall changes in the size of the paid labor force across the island.
        </p>
        
        <ul class="list-disc list-inside space-y-2 ml-4">
          <li>
            <strong class="text-blue-600">Total Employment Trend:</strong> This line chart shows the total number of paid employees over the selected period (2012–2023).
          </li>
          <li>
            <strong class="text-green-600">Annual Change (% and Count):</strong> The bar charts show the year-over-year change. Positive bars indicate job growth, while negative bars indicate job losses. Note the significant drops in certain years (e.g., 2017/2018 post-Hurricane Maria) followed by recovery in later years.
          </li>
        </ul>
      </div>
      </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <div class="space-y-4">
        <p>Data for this project was derived from the U.S. Census Bureau:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>
            <a href="https://data.census.gov/cedsci/table?q=paid%20employees%20Puerto%20Rico&tid=CBP20.CB1900A11&g=0400000US72&vintage=2020"
               target="_blank" rel="noopener" class="text-blue-600 underline">
              County Business Patterns (CBP) - Number of Paid Employees (NAICS 00)
            </a>
          </li>
        </ul>

        <p>Specific files used:</p>
        <ul class="list-disc list-inside">
          <li>municipios_cbp_total_employment_2010_2023_wide_with_PR.json (site build / analysis)</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const EMPLOYMENT_JSON = '../data/employment_establishments/municipios_cbp_total_employment_2010_2023_wide_with_PR.json';

    const BASE_YEAR = 2012;
    const ALL_YEARS = [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023]; // Use all years for parsing

    // Formatters remain the same
    const countFmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signedCount = (n) => (n > 0 ? '+' : '') + countFmt.format(n);
    const signedPct = (n) => (n > 0 ? '+' : '') + pctFmt(n);

    // Map Mode Identifiers
    const MODE_NOMINAL_PCT = 'nominal_pct'; 
    const MODE_NOMINAL_ABS = 'nominal_abs'; 
    
    // Color breaks for choropleth map
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    
    // Employment PCT Change (2012-2023) - Adjusted breaks for employment %
    const EMPLOYMENT_PCT_BREAKS = [-10, 0, 10, 20, 40]; 
    // Employment Absolute Change (2012-2023) - Adjusted breaks for employment count
    let EMPLOYMENT_ABS_BREAKS = [-1500, -500, 0, 500, 1500]; 
    
    const sanitizeName = s => String(s||'').trim();
    const yearVal = (row,y) => {
      const v = row?.[String(y)];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    };
    
    // Global variables for map state and data
    let lineChartEmployment = null, barChartPctChange = null, barChartAbsChange = null; 
    let _rows = [], map, layer, fc, legend;
    let currentMode = MODE_NOMINAL_PCT;
    let lockedName = null, selectedLayer = null;
    let prBoundsGlobal = null;

    // Element IDs for the new detail structure
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2023 = document.getElementById('d-2023');
    const dChgAbs = document.getElementById('d-chg-abs');
    const dChgPct  = document.getElementById('d-chg-pct');
    const dCenL = document.getElementById('d-census');
    

    function statsForMunicipio(name){
      const nameKey = sanitizeName(name).replace(/\s*Municipio$/,'');
      
      const row = _rows.find(r => 
        sanitizeName(r.Municipio).replace(/\s*Municipio$/,'') === nameKey || 
        (nameKey === 'Puerto Rico' && r.Municipio === 'Puerto Rico')
      );

      if (!row || row.metadata) return null;
      
      // FIX: Dynamically determine the start index for the chart data (charts cannot handle 0/null data points at the start easily)
      let dataStartYear = BASE_YEAR;
      let employmentVals = ALL_YEARS.map(y => yearVal(row,y));
      let employmentYears = ALL_YEARS;
      
      // Find the first non-null/non-zero data point starting from 2012
      let startIndex = employmentVals.findIndex((v, i) => v > 0 && ALL_YEARS[i] >= BASE_YEAR);

      if (startIndex !== -1) {
          employmentVals = employmentVals.slice(startIndex);
          employmentYears = ALL_YEARS.slice(startIndex);
          dataStartYear = employmentYears[0];
      } else {
          // If no data > 0 exists from 2012 onward, default to the 2012 slice
          employmentVals = ALL_YEARS.map(y => yearVal(row, y)).slice(2); // Slice to start at 2012 (index 2)
          employmentYears = ALL_YEARS.slice(2);
      }
      // END FIX

      // Calculate cumulative change using 2012 as the explicit base year 
      const baseVal = yearVal(row, BASE_YEAR);
      const val2023 = yearVal(row, 2023); // Always use the fixed 2023 column value

      let cumAbs = NaN;
      let cumPct = NaN;

      if (Number.isFinite(baseVal) && Number.isFinite(val2023)) {
          cumAbs = val2023 - baseVal;
          if (baseVal !== 0) {
              cumPct = (cumAbs / baseVal) * 100;
          }
      }
      
      // Calculate Annual Percentage Change - must use the potentially sliced/filtered data for annual change.
      const employmentAbsYear = [];
      const employmentPctYear = [];
      
      for (let i=1; i < employmentYears.length; i++){
        const current = employmentVals[i];
        const previous = employmentVals[i-1];
        if (Number.isFinite(current) && Number.isFinite(previous) && previous !== 0) {
            employmentAbsYear.push(current - previous);
            employmentPctYear.push(((current - previous) / previous) * 100);
        } else {
            employmentAbsYear.push(NaN);
            employmentPctYear.push(NaN);
        }
      }

      return { 
        employmentVals: employmentVals, 
        employmentYears: employmentYears, // Return the sliced years
        cumAbs: cumAbs, 
        cumPct: cumPct, 
        employmentPctYear: employmentPctYear, 
        employmentAbsYear: employmentAbsYear, 
        val2023: val2023 
      };
    }

    function censusLink(name){
      return `https://data.census.gov/cedsci/table?q=paid%20employees%20Puerto%20Rico&tid=CBP20.CB1900A11&g=0400000US72&vintage=2020`;
    }

    function drawCharts(name, st){
      if (!st || !st.employmentYears || st.employmentYears.length === 0) return;
      
      // Get chart contexts
      const ctxLN = document.getElementById('lineChartEmployment').getContext('2d');
      const ctxBP = document.getElementById('barChartPctChange').getContext('2d');
      const ctxBA = document.getElementById('barChartAbsChange').getContext('2d');

      // Employment Line Chart
      if (lineChartEmployment) lineChartEmployment.destroy();
      lineChartEmployment = new Chart(ctxLN, {
        type: 'line',
        data: { 
          labels: st.employmentYears, // Use the dynamically determined years
          datasets:[{ label:'Total Employees', 
          data: st.employmentVals.map(v => Number.isFinite(v) ? v : null), 
          tension:.2, pointRadius:3 }] 
        },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>countFmt.format(c.parsed.y) } } },
          scales:{ 
            y:{ ticks:{ callback:v=>`${countFmt.format(v)}` } }, 
            x:{ ticks:{ maxRotation: 90, minRotation: 90 } }
          },
          maintainAspectRatio:false
        }
      });

      // Labels for annual change charts must match the number of data points (Years - 1)
      const labels = st.employmentYears.slice(1).map((y,i)=> `${st.employmentYears[i]}→${y}`);
      
      // Annual % Change Bar Chart
      if (barChartPctChange) barChartPctChange.destroy();
      barChartPctChange = new Chart(ctxBP, {
        type:'bar',
        data:{ labels, datasets:[{ label:'% change', 
          data: st.employmentPctYear.map(v=> Number.isFinite(v) ? +v.toFixed(2) : null) }] },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>pctFmt(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>pctFmt(v) } } },
          maintainAspectRatio:false
        }
      });

      // Annual Absolute Change Bar Chart
      if (barChartAbsChange) barChartAbsChange.destroy();
      barChartAbsChange = new Chart(ctxBA, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Count change', 
          data: st.employmentAbsYear.map(v=> Number.isFinite(v) ? +v.toFixed(0) : null) }] },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>signedCount(c.parsed.y) } } },
          scales:{ y:{ ticks:{ callback:v=>countFmt.format(v) } } },
          maintainAspectRatio:false
        }
      });
    }

    function updateDetails(name, st, centroid){
      dName.textContent = name.replace(/\s*Municipio$/,'');
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      
      // Employment fields
      d2023.textContent = Number.isFinite(st?.val2023) ? countFmt.format(st.val2023) : '—';
      dChgAbs.textContent = st ? signedCount(st.cumAbs) : '—';
      dChgPct.textContent = st ? signedPct(st.cumPct) : '—';

      dCenL.href = censusLink(name);
      drawCharts(name, st);
    }

    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };

    (async function init(){
      // Attempt to load data
      try {
        const res = await fetch(EMPLOYMENT_JSON, { cache:'no-store' });
        _rows = await res.json();
      } catch (e) {
        console.error("Failed to load employment data. Check file path and local server setup.", e);
        document.getElementById('map').innerHTML = '<div style="height:100%; display:flex; align-items:center; justify-content:center; background-color:#fef2f2; border:1px solid #fca5a5; border-radius:0.75rem;"><p class="text-xl text-red-600 font-bold">⚠️ ERROR: Failed to load employment data. Check JSON file path / local security settings.</p></div>';
      }
      

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Attempt to load GeoJSON
      try {
        const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
        fc = await gjRes.json();
      } catch (e) {
         console.error("Failed to load GeoJSON file. Check file path and local server setup.", e);
         return; 
      }

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const geoid = p.GEOID || p.geoid || '';
          
          const statsName = rawName.replace(/\s*Municipio$/,'');
          const stTip = statsForMunicipio(statsName);
          
          const changeLine = stTip
            ? `<br><small>${BASE_YEAR}→2023: ${signedCount(stTip.cumAbs)} (${pctFmt(stTip.cumPct)})</small>`
            : '';
          
          lyr.bindTooltip(rawName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${rawName}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(statsName, statsForMunicipio(statsName), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              const clickedName = rawName.replace(/\s*Municipio$/,'');
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = clickedName;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      computeAbsBreaks();

      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend(currentMode);
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName), null);

      wireMetricToggle();
      wireClearSelection();
      wireDropdown();
    })();

    function wireMetricToggle(){
      const btnNomPct = document.getElementById('metricNominalPct');
      const btnNomAbs = document.getElementById('metricNominalAbs');

      function setActive(mode){
        currentMode = mode;
        
        [btnNomPct, btnNomAbs].forEach(btn => {
          const isActive = (btn.id === 'metricNominalPct' && mode === MODE_NOMINAL_PCT) ||
                           (btn.id === 'metricNominalAbs' && mode === MODE_NOMINAL_ABS);
          btn.classList.toggle('bg-blue-600', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('hover:bg-gray-50', !isActive);
        });

        if (layer) layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend(currentMode);
      }

      btnNomPct.addEventListener('click', () => setActive(MODE_NOMINAL_PCT));
      btnNomAbs.addEventListener('click', () => setActive(MODE_NOMINAL_ABS));
      
      setActive(currentMode); // Initialize the state
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
        // Reset details to Puerto Rico aggregate
        const initName = 'Puerto Rico';
        updateDetails(initName, statsForMunicipio(initName), null);
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function styleForFeature(feature){
      const p = feature.properties || {};
      const rawName = (p.NAME || p.NAMELSAD || p.name || 'Unknown');
      const name = rawName.replace(/\s*Municipio$/,''); 
      const st = statsForMunicipio(name);
      
      if (!st) {
        return { fillColor: '#93c5fd', weight: 1.2, color:'#111827', fillOpacity:.15 }; 
      }

      let value;
      let breaks;

      if (currentMode === MODE_NOMINAL_PCT) {
          value = st.cumPct;
          breaks = EMPLOYMENT_PCT_BREAKS;
      } else if (currentMode === MODE_NOMINAL_ABS) {
          value = st.cumAbs;
          breaks = EMPLOYMENT_ABS_BREAKS;
      }
      
      // Handle Infinity/NaN resulting from division by zero, set color to highlight
      if (value === Infinity || value === -Infinity || !Number.isFinite(value)) {
        return { fillColor: '#fca5a5', weight: 1.2, color:'#111827', fillOpacity:.75 }; // Light Red for Missing/NaN/Infinity
      }

      const col = colorFor(value, breaks);
      
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    function colorFor(value, breaks) {
      if (!Number.isFinite(value)) return '#93c5fd'; // Default color for missing data
      if (value <= breaks[0]) return CHORO_COLORS[0];
      if (value <= breaks[1]) return CHORO_COLORS[1];
      if (value <= breaks[2]) return CHORO_COLORS[2];
      if (value <= breaks[3]) return CHORO_COLORS[3];
      if (value <= breaks[4]) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    function renderLegend(mode){
      if (!legend || !legend._div) return;
      
      let breaks;
      let title;
      let isPct;

      if (mode === MODE_NOMINAL_PCT) {
          breaks = EMPLOYMENT_PCT_BREAKS;
          title = `Employment Change ${BASE_YEAR}–2023 — % Change`;
          isPct = true;
      } else {
          breaks = EMPLOYMENT_ABS_BREAKS;
          title = `Employment Change ${BASE_YEAR}–2023 — Absolute Count`;
          isPct = false;
      }

      const labels = [];
      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;
      
      const formatBreak = (val, isPct) => {
        if (isPct) {
            return `${(Math.round(val * 10) / 10)}%`;
        }
        // Format as signed count with comma separators
        return `${val > 0 ? '+' : ''}${countFmt.format(val)}`;
      };
      
      const fmtRange = (a,b,isPct) => `${formatBreak(a, isPct)} to ${formatBreak(b, isPct)}`;
      
      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      labels.push(row(CHORO_COLORS[0], isPct ? `≤ ${formatBreak(breaks[0], true)}` : `≤ ${formatBreak(breaks[0], false)}`));
      labels.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1], isPct)));
      labels.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2], isPct)));
      labels.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3], isPct)));
      labels.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4], isPct)));
      labels.push(row(CHORO_COLORS[5], isPct ? `> ${formatBreak(breaks[4], true)}` : `> ${formatBreak(breaks[4], false)}`));
      
      // Add entry for error/missing data
      labels.push(row('#fca5a5', 'Missing/Unreliable Base Data'));


      legend._div.innerHTML = labels.join('');
    }

    function computeAbsBreaks(){
      // Fixed breaks for Employment Absolute mode
      EMPLOYMENT_ABS_BREAKS = [-1500, -500, 0, 500, 1500];
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const currentPathname = window.location.pathname.split('/').pop();
      // Ensure 'employment.html' link is highlighted
      const subPageLink = document.querySelector('#metrics-menu a[href="employment.html"]'); 
      if (subPageLink) subPageLink.classList.add('bg-gray-100','font-semibold');
    });
  </script>
</body>
</html>