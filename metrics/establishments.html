<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Population & Economic Dynamics in Puerto Rico</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Cards + hero */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }

    /* Map sizing */
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover (persistent hover) */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }

    /* Small helpers */
    .kpi { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- Top Navigation -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 bg-gray-100 font-semibold">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- Hero -->
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Population & Economic Dynamics in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            Employer Establishments across Puerto Rico’s municipios (2012–2023), using U.S. Census <em>County Business Patterns (CBP)</em>.
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see county / municipality details
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Map Section -->
    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricNominalPct" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Nominal Change (%)</button>
            <button id="metricNominalAbs" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Nominal Change (#)</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <!-- Charts & Details -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Employer Establishments Details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Establishments (2012–2023):</div>
            <ul class="mt-1 space-y-1">
              <li>2023 Establishments: <span id="d-2023" class="font-semibold kpi">—</span></li>
              <li>Change since 2012: <span id="d-chg" class="font-semibold kpi">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="https://www.census.gov/programs-surveys/cbp.html" target="_blank" rel="noopener">
              Open CBP on census.gov ↗
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Establishments Trend (2012–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartNominal"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Annual % Change in Establishments</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChartNominal"></canvas>
          </div>
        </div>
      </div>

      <!-- Explanation -->
      <h2 class="text-lg font-semibold mb-4 pt-8 border-t border-gray-200 mt-8">Understanding the Establishment Metrics</h2>
      <div class="space-y-4 text-gray-700">
        <p>
          The charts above display the change in <strong>Employer Establishments</strong> across Puerto Rico. These represent active business locations with paid employees as reported in the U.S. Census Bureau’s <em>County Business Patterns (CBP)</em> program.
        </p>

        <h3 class="font-semibold text-gray-800 pt-2">Interpreting Trends</h3>
        <p>
          Growth or decline in establishments reflects shifts in the island’s economic activity, business formation, and recovery after major events such as natural disasters or recessions.
        </p>

        <ul class="list-disc list-inside space-y-2 ml-4">
          <li><strong>Nominal Change (%):</strong> Measures the percent difference in total establishments from 2012 to 2023.</li>
          <li><strong>Nominal Change (#):</strong> Shows the absolute change in the number of establishments over the same period.</li>
        </ul>
      </div>
    </section>

    <!-- File Sources -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <ul class="list-disc list-inside space-y-1">
        <li>
          <a href="https://www.census.gov/programs-surveys/cbp.html" target="_blank" rel="noopener" class="text-blue-600 underline">
            U.S. Census Bureau — County Business Patterns (CBP)
          </a>
        </li>
        <li>
          municipios_cbp_total_employment_2010_2023_wide.json (used for map and charts)
        </li>
        <li>
          municipios_cbp_total_employment_2010_2023.csv (used for data verification)
        </li>
      </ul>
    </section>
  </main>

  <!-- JS Logic -->
  <script>
    /* -------------------------
       Config + helpers
    --------------------------*/
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const DATA_JSON   = '../data/employment_establishments/municipios_cbp_total_employment_2010_2023_wide.json';
    const YEARS       = [2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];

    // Formatting
    const intFmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signed = (n) => (n>0?'+':'') + intFmt.format(n);

    // Map modes (no REAL here)
    const MODE_NOMINAL_PCT = 'nominal_pct';
    const MODE_NOMINAL_ABS = 'nominal_abs';
    let currentMode = MODE_NOMINAL_PCT;

    // Choropleth palette (6 bins, red -> green)
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];

    // Breaks (defaults; recomputed from data)
    let NOMINAL_PCT_BREAKS = [-20, -10, 0, 10, 20];
    let NOMINAL_ABS_BREAKS = [-300, -150, 0, 150, 300];

    // DOM refs (details panel)
    const dName   = document.getElementById('d-name');
    const dCent   = document.getElementById('d-centroid');
    const d2023   = document.getElementById('d-2023');
    const dChg    = document.getElementById('d-chg');

    // Chart handles
    let lineChart = null, barChart = null;

    // Map globals
    let _rows = [];
    let map, layer, legend;
    let lockedName = null, selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    // Helpers
    const sanitizeName = (s) => String(s || '').trim();
    const normMunicipio = (s) => sanitizeName(s).replace(/\s*Municipio$/,'');
    const yearVal = (row, y) => {
      const v = row?.[String(y)];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    };

    /* -------------------------
       Data access + stats
    --------------------------*/
    function findRowForMunicipio(name) {
      const key = normMunicipio(name);
      return _rows.find(r =>
        (r && !r.metadata) &&
        (normMunicipio(r.Municipio) === key || (key === 'Puerto Rico' && r.Municipio === 'Puerto Rico'))
      ) || null;
    }

    function statsForMunicipio(name) {
      const row = findRowForMunicipio(name);
      if (!row) return null;

      const vals = YEARS.map(y => yearVal(row, y));
      const pctYear = [];
      for (let i = 1; i < YEARS.length; i++) {
        const prev = vals[i-1], cur = vals[i];
        const pct = (Number.isFinite(prev) && prev !== 0) ? ((cur - prev) / prev) * 100 : NaN;
        pctYear.push(pct);
      }

      // Use precomputed cumulative fields from the JSON
      // NOTE: employment JSON uses 2012 as the first year
      const cumAbs = Number(row.Cum_Change_2012_2023);
      const cumPct = Number(row.Cum_Pct_Change_2012_2023);
      const val2023 = vals[vals.length - 1];

      return { vals, pctYear, cumAbs, cumPct, val2023 };
    }

    /* -------------------------
       Charts
    --------------------------*/
    function drawCharts(name, st) {
      if (!st) return;

      const ctxL = document.getElementById('lineChartNominal').getContext('2d');
      const ctxB = document.getElementById('barChartNominal').getContext('2d');

      if (lineChart) lineChart.destroy();
      if (barChart)  barChart.destroy();

      lineChart = new Chart(ctxL, {
        type: 'line',
        data: {
          labels: YEARS,
          datasets: [{
            label: 'Establishments',
            data: st.vals,
            tension: .2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> intFmt.format(c.parsed.y) } }
          },
          scales: {
            y: { ticks: { callback: (v)=> intFmt.format(v) } },
            x: { ticks: { maxRotation: 90, minRotation: 90 } }
          },
          maintainAspectRatio: false
        }
      });

      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}→${y}`);
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Annual % Change',
            data: st.pctYear.map(v=> Number.isFinite(v) ? +v.toFixed(2) : null)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> pctFmt(c.parsed.y) } }
          },
          scales: {
            y: { ticks: { callback: (v)=> pctFmt(v) } }
          },
          maintainAspectRatio: false
        }
      });
    }

    function updateDetails(name, st, centroid) {
      dName.textContent = normMunicipio(name);
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';

      if (!st) {
        d2023.textContent = '—';
        dChg.textContent  = '—';
      } else {
        d2023.textContent = Number.isFinite(st.val2023) ? intFmt.format(st.val2023) : '—';
        dChg.textContent  = `${signed(st.cumAbs)} (${pctFmt(st.cumPct)})`;
      }

      drawCharts(name, st);
    }

    /* -------------------------
       Choropleth rendering
    --------------------------*/
    function colorFor(value, breaks, isPct) {
      if (!Number.isFinite(value)) return '#e5e7eb'; // neutral gray
      // 6 bins => 5 breaks
      const [b0,b1,b2,b3,b4] = breaks;
      if (value <= b0) return CHORO_COLORS[0];
      if (value <= b1) return CHORO_COLORS[1];
      if (value <= b2) return CHORO_COLORS[2];
      if (value <= b3) return CHORO_COLORS[3];
      if (value <= b4) return CHORO_COLORS[4];
      return CHORO_COLORS[5];
    }

    function styleForFeature(feature) {
      const p = feature.properties || {};
      const rawName = (p.NAME || p.NAMELSAD || p.name || 'Unknown');
      const name = normMunicipio(rawName);
      const st = statsForMunicipio(name);

      let value, breaks, isPct = false;
      if (currentMode === MODE_NOMINAL_PCT) {
        value = st ? st.cumPct : NaN;
        breaks = NOMINAL_PCT_BREAKS;
        isPct = true;
      } else {
        value = st ? st.cumAbs : NaN;
        breaks = NOMINAL_ABS_BREAKS;
      }
      const fill = colorFor(value, breaks, isPct);
      return { fillColor: fill, weight: 1.2, color:'#ffffff', fillOpacity:.78 };
    }

    // Recompute data-driven breaks (quantiles) for better contrast
    function computeBreaks() {
      const pctVals = [], absVals = [];
      for (const r of _rows) {
        if (r && !r.metadata) {
          const p = Number(r.Cum_Pct_Change_2012_2023);
          const a = Number(r.Cum_Change_2012_2023);
          if (Number.isFinite(p)) pctVals.push(p);
          if (Number.isFinite(a)) absVals.push(a);
        }
      }
      pctVals.sort((x,y)=>x-y);
      absVals.sort((x,y)=>x-y);

      const q = (arr, q) => {
        if (!arr.length) return NaN;
        const pos = (arr.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        if (arr[base + 1] !== undefined) {
          return arr[base] + rest * (arr[base + 1] - arr[base]);
        } else {
          return arr[base];
        }
      };

      const pctBreaks = [q(pctVals,.10), q(pctVals,.30), q(pctVals,.50), q(pctVals,.70), q(pctVals,.90)]
        .map(v => Number.isFinite(v) ? Math.round(v*100)/100 : v);
      const absBreaks = [q(absVals,.10), q(absVals,.30), q(absVals,.50), q(absVals,.70), q(absVals,.90)]
        .map(v => Number.isFinite(v) ? Math.round(v) : v);

      if (pctBreaks.every(Number.isFinite)) NOMINAL_PCT_BREAKS = pctBreaks;
      if (absBreaks.every(Number.isFinite)) NOMINAL_ABS_BREAKS = absBreaks;
    }

    function renderLegend(mode) {
      if (!legend || !legend._div) return;

      let breaks, title, isPct;
      if (mode === MODE_NOMINAL_PCT) {
        breaks = NOMINAL_PCT_BREAKS;
        title  = 'Establishment Change 2012–2023 — % (Nominal)';
        isPct  = true;
      } else {
        breaks = NOMINAL_ABS_BREAKS;
        title  = 'Establishment Change 2012–2023 — # (Nominal)';
        isPct  = false;
      }

      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;

      const fmtBreak = (v) => {
        if (!Number.isFinite(v)) return '—';
        return isPct ? `${v.toFixed(2)}%` : (v>0?'+':'') + intFmt.format(v);
      };
      const fmtRange = (a,b) => `${fmtBreak(a)} to ${fmtBreak(b)}`;

      const html = [];
      html.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      html.push(row(CHORO_COLORS[0], `≤ ${fmtBreak(breaks[0])}`));
      html.push(row(CHORO_COLORS[1], fmtRange(breaks[0], breaks[1])));
      html.push(row(CHORO_COLORS[2], fmtRange(breaks[1], breaks[2])));
      html.push(row(CHORO_COLORS[3], fmtRange(breaks[2], breaks[3])));
      html.push(row(CHORO_COLORS[4], fmtRange(breaks[3], breaks[4])));
      html.push(row(CHORO_COLORS[5], `> ${fmtBreak(breaks[4])}`));

      legend._div.innerHTML = html.join('');
    }

    /* -------------------------
       UI wiring
    --------------------------*/
    function restyleLayer() {
      if (!layer) return;
      layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
      if (selectedLayer) selectedLayer.setStyle(selectedOutline);
      renderLegend(currentMode);
    }

    function wireMetricToggle() {
      const btnNomPct = document.getElementById('metricNominalPct');
      const btnNomAbs = document.getElementById('metricNominalAbs');

      function setActive(mode) {
        currentMode = mode;

        const setBtn = (btn, active) => {
          btn.classList.toggle('bg-blue-600', active);
          btn.classList.toggle('text-white', active);
          btn.classList.toggle('hover:bg-gray-50', !active);
        };
        setBtn(btnNomPct, mode === MODE_NOMINAL_PCT);
        setBtn(btnNomAbs, mode === MODE_NOMINAL_ABS);

        restyleLayer();
      }

      btnNomPct.addEventListener('click', () => setActive(MODE_NOMINAL_PCT));
      btnNomAbs.addEventListener('click', () => setActive(MODE_NOMINAL_ABS));
      setActive(currentMode); // init
    }

    function wireClearSelection() {
      function clearSelection() {
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding: [15,15] });
        // Reset details to islandwide
        updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico'), null);
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    /* -------------------------
       App init
    --------------------------*/
    (async function init(){
      // Load data
      const res = await fetch(DATA_JSON, { cache: 'no-store' });
      if (!res.ok) {
        console.error('Failed to load data JSON:', res.status, await res.text());
        alert('Could not load data JSON. Check the path in establishments.html.');
        return;
      }
      _rows = await res.json();

      // Compute breaks from data (robust to skew)
      computeBreaks();

      // Build map
      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      if (!gjRes.ok) {
        console.error('Failed to load GeoJSON:', gjRes.status, await gjRes.text());
        alert('Could not load GeoJSON. Check the GEOJSON_URL path.');
        return;
      }
      const fc = await gjRes.json();

      const hoverStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const displayName = rawName;
          const statsName = normMunicipio(rawName);
          const geoid = p.GEOID || p.geoid || '';

          const stTip = statsForMunicipio(statsName);
          const changeLine = stTip
            ? `<br><small>2012→2023: ${signed(stTip.cumAbs)} (${(Number(stTip.cumPct)||0).toFixed(2)}%)</small>`
            : '';

          lyr.bindTooltip(displayName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${displayName}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hoverStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(statsName, statsForMunicipio(statsName), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              const clickedName = statsName;
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = clickedName;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      // Add + position legend
      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend(currentMode);
        return div;
      };
      legend.addTo(map);

      // Move legend upward (towards Virgin Islands) on large screens
      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      // Initialize details to islandwide
      updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico'), null);

      // Wire up interactions
      wireMetricToggle();
      wireClearSelection();
      wireDropdown();
    })();
  </script>
</body>
</html>
