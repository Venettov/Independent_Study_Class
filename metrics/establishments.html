<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employment & Establishment Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Custom Styles for Aesthetics */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f7;
    }
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.12), transparent 60%),
        linear-gradient(to bottom right, #f9f9f9, #e9e9e9);
      background-size: cover;
      background-position: center;
      border-bottom: 3px solid #6366f1; /* Indigo 500 */
    }
    .leaflet-container {
      border-radius: 1rem;
      height: 600px; /* Default height */
      width: 100%;
    }
    #info, #legend {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    #legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      border-radius: 3px;
    }
    #metrics-dropdown-root.hovering .metrics-menu {
        display: block;
    }
    .metrics-menu {
        display: none;
    }
    @media (max-width: 640px) {
        .leaflet-container {
            height: 400px;
        }
    }
  </style>

</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation and Header (UNCHANGED STRUCTURE) -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">PR Economic Dashboard</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="population.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Population</a></li>
                    <li><a href="income.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Income</a></li>
                    <li><a href="establishments.html" class="text-indigo-600 font-semibold border-b-2 border-indigo-600">Establishments</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hero/Banner Section (UPDATED TITLE) -->
    <div class="hero py-12 mb-8">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-2">
                County Business Patterns (CBP)
            </h2>
            <p class="text-xl text-gray-600">
                Total Paid Employment by Municipio (2012–<span id="latest-year-display">XXXX</span>)
            </p>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Map Card (Column 1) -->
            <div class="lg:col-span-2 card p-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-2 sm:mb-0">
                        Choropleth Map: <span id="metric-title" class="text-indigo-600">Total Employment in <span id="current-map-year">XXXX</span></span>
                    </h3>
                    <!-- Dropdown for Metrics -->
                    <div id="metrics-dropdown-root" class="relative inline-block text-left z-10">
                        <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-indigo-500 text-sm font-medium text-white hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="menu-button" aria-expanded="true" aria-haspopup="true">
                            Select Metric
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="metrics-menu" class="metrics-menu origin-top-right absolute right-0 mt-2 w-60 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                            <div class="py-1" role="none">
                                <span class="block px-4 py-2 text-xs font-semibold text-gray-500">Employment Figures (Count)</span>
                                <button data-metric="NOMINAL" data-year="LATEST" class="metric-option text-gray-700 block w-full text-left px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Total Employment (<span class="latest-year"></span>)</button>
                                <button data-metric="CUM_PCT_CHANGE" data-year="LATEST" class="metric-option text-gray-700 block w-full text-left px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">% Change (<span class="first-year"></span>–<span class="latest-year"></span>)</button>
                                <button data-metric="PCT_CHANGE" data-year="LATEST" class="metric-option text-gray-700 block w-full text-left px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">% Change (<span class="previous-year"></span>–<span class="latest-year"></span>)</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="map" class="leaflet-container"></div>
                <p id="data-note" class="text-xs text-gray-500 mt-3"></p>
            </div>

            <!-- Detail Card (Column 2) -->
            <div class="lg:col-span-1 flex flex-col space-y-8">
                <!-- Municipio Summary Card -->
                <div class="card p-6 flex-grow">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">
                        Municipio Details
                    </h3>
                    <div id="municipio-details" class="text-gray-600">
                        <p class="mb-2">Click on a municipio in the map to see details here.</p>
                        <p class="font-bold text-lg"><span id="detail-municipio">Puerto Rico</span> Total</p>
                        <hr class="my-3">
                        <p>Latest Employment (<span class="latest-year"></span>): <span id="detail-current" class="text-2xl font-bold text-indigo-600">N/A</span></p>
                        <p>Cumulative % Change (<span class="first-year"></span>–<span class="latest-year"></span>): <span id="detail-cum-pct" class="font-semibold text-lg">N/A</span></p>
                        <p>Year-over-Year Change (<span class="previous-year"></span>–<span class="latest-year"></span>): <span id="detail-yoy-pct" class="font-semibold text-lg">N/A</span></p>
                    </div>
                </div>

                <!-- Islandwide Chart Card -->
                <div class="card p-6 flex-grow">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">
                        Islandwide Total Employment
                    </h3>
                    <div class="w-full h-auto">
                        <canvas id="islandwide-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata Section -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Data Source & Notes</h3>
            <p id="metadata-source" class="text-gray-600 mb-1"></p>
            <p id="metadata-units" class="text-gray-600 mb-1"></p>
            <p id="metadata-years" class="text-gray-600 mb-1"></p>
            <p id="metadata-notes" class="text-gray-600 text-sm italic mt-3"></p>
        </div>
    </main>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // --- CONSTANTS AND CONFIGURATION ---
        // Data File Path (FIXED: Using absolute path from root for robustness)
        const DATA_FILE = "/data/employment_establishments/municipios_cbp_total_employment_2010_2023_wide.json";
        
        // GeoJSON for Puerto Rico municipios (FIXED: Using absolute path from root for robustness)
        const GEO_JSON_FILE = "/data/pr_municipios.geojson"; 

        let map;
        let info;
        let legend;
        let geojsonLayer;
        let dataMap = {}; // Maps Municipio name to its data record
        let islandwideData = {}; 
        let currentMetric = 'NOMINAL'; // NOMINAL, CUM_PCT_CHANGE, PCT_CHANGE
        let LATEST_YEAR = 2023; // Max year in the collected data
        let PREVIOUS_YEAR = 2022; // For YOY comparison
        let FIRST_YEAR = 2012; // First year of consistent CBP data in the file

        // CBP is total employment count, so the breaks are for number of employees, not dollars.
        // Adjusted breaks suitable for employment counts (in thousands)
        const NOMINAL_ABS_BREAKS = [5000, 10000, 15000, 25000, 40000]; // Total Employees
        const PCT_BREAKS = [-10, -5, 0, 5, 10]; // Percentage change

        // Color ramp (adjusting colors to Indigo theme for employment)
        const CHORO_COLORS = ['#fee0d2', '#fc9272', '#de2d26', '#a50f15', '#67000d', '#252525']; // Red/Maroon theme
        const CHANGE_COLORS = ['#2b83ba', '#91bfdb', '#e0f3f8', '#ffffbf', '#fee090', '#fc8d59', '#d73027'].reverse(); // Blue-to-Red Diverging

        // --- UTILITY FUNCTIONS ---

        function getMetricKey(metric, latestYear) {
            const firstYear = FIRST_YEAR;
            const prevYear = latestYear - 1;

            switch(metric) {
                case 'CUM_PCT_CHANGE':
                    return `Cum_Pct_Change_${firstYear}_${latestYear}`;
                case 'PCT_CHANGE':
                    return `Pct_Change_${prevYear}_${latestYear}`;
                case 'NOMINAL':
                default:
                    // Employment is simply the year key
                    return String(latestYear); 
            }
        }

        function getColor(value, metric) {
            let breaks = (metric.includes('PCT')) ? PCT_BREAKS : NOMINAL_ABS_BREAKS;
            let colors = (metric.includes('PCT')) ? CHANGE_COLORS : CHORO_COLORS;
            if (metric.includes('PCT') && value < breaks[0]) return colors[0]; // Outlier low for change

            return value > breaks[4] ? colors[5] :
                   value > breaks[3] ? colors[4] :
                   value > breaks[2] ? colors[3] :
                   value > breaks[1] ? colors[2] :
                   value > breaks[0] ? colors[1] :
                   colors[0]; 
        }

        // UPDATED: Removed dollar sign, adjusted formatting for thousands of employees
        function formatValue(value, isPct = false) {
            if (value === null || isNaN(value)) return "N/A";
            if (isPct) {
                return (value).toFixed(1) + '%';
            }
            // Format large numbers (e.g., 50000 -> 50K)
            return (value >= 1000 ? (value / 1000).toFixed(0) + 'K' : value) + ' Employees';
        }

        // --- MAP FUNCTIONS ---

        function style(feature) {
            const municipioData = dataMap[feature.properties.NAME];
            let value = municipioData ? municipioData[getMetricKey(currentMetric, LATEST_YEAR)] : null;
            
            // Handle zero/null/suppressed data
            if (value === 0 || value === null || isNaN(value)) {
                 return {
                    fillColor: '#ccc', // Gray for missing/zero data
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                };
            }

            return {
                fillColor: getColor(value, currentMetric),
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.9
            });
            if (!L.Browser.ie && L.Browser.chrome) {
                layer.bringToFront();
            }
            updateInfo(layer.feature.properties.NAME);
            updateDetailsPanel(layer.feature.properties.NAME);
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            updateInfo(null);
            updateDetailsPanel('Puerto Rico'); // Reset to islandwide summary
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        function updateInfo(municipioName) {
            let content;
            if (municipioName) {
                const data = dataMap[municipioName];
                const metricKey = getMetricKey(currentMetric, LATEST_YEAR);
                const isPct = currentMetric.includes('PCT');
                const value = data ? data[metricKey] : null;
                
                content = `<b>${municipioName}</b><br/>${formatValue(value, isPct)}`;
            } else {
                // UPDATED: Label for Total Employment
                content = 'Hover over a municipio for **Total Employment** details';
            }
            info.update(content);
        }
        
        // --- DATA PANEL/CHART FUNCTIONS ---

        function updateDetailsPanel(municipioName) {
            let data;
            if (municipioName === 'Puerto Rico') {
                data = islandwideData;
            } else {
                data = dataMap[municipioName];
            }
            
            const detailElement = document.getElementById('municipio-details');
            if (!data || !detailElement) return;

            const latestKey = String(LATEST_YEAR);
            const prevKey = PREVIOUS_YEAR;
            const cumPctKey = getMetricKey('CUM_PCT_CHANGE', LATEST_YEAR);
            const yoyPctKey = getMetricKey('PCT_CHANGE', LATEST_YEAR);
            
            // UPDATED: Removed Real Income references
            const latestValue = data[latestKey];
            const cumPctValue = data[cumPctKey];
            const yoyPctValue = data[yoyPctKey];

            document.getElementById('detail-municipio').textContent = municipioName + (municipioName === 'Puerto Rico' ? ' Total' : '');
            document.getElementById('detail-current').textContent = formatValue(latestValue, false);
            
            // Format change percentages
            document.getElementById('detail-cum-pct').textContent = formatValue(cumPctValue, true);
            document.getElementById('detail-yoy-pct').textContent = formatValue(yoyPctValue, true);

            // Update chart data if we are looking at a specific Municipio
            if (municipioName !== 'Puerto Rico') {
                drawAreaChart(data, latestKey, `${municipioName} Employment`);
            } else {
                drawAreaChart(islandwideData, latestKey, 'Puerto Rico Total Employment');
            }
        }

        let employmentChart;

        function drawAreaChart(data, latestKey, title) {
            if (employmentChart) {
                employmentChart.destroy();
            }

            const years = Object.keys(data).filter(key => !isNaN(parseInt(key)) && parseInt(key) >= FIRST_YEAR).sort();
            const employmentValues = years.map(year => data[year] || 0);

            const ctx = document.getElementById('islandwide-chart').getContext('2d');
            
            // UPDATED: Title and label updated for employment
            employmentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Total Paid Employees',
                        data: employmentValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)', // Indigo 500 Light
                        borderColor: '#6366f1', // Indigo 500
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 3,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title, // Use dynamic title
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                // UPDATED: Tooltip formatter
                                label: function(context) {
                                    return ' Employees: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Year' },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: 'Employees' }, // UPDATED: Axis label
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    // UPDATED: Format Y-axis ticks for thousands
                                    return value >= 1000 ? (value / 1000).toFixed(0) + 'K' : value;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- LEGEND FUNCTIONS ---
        function updateLegend(metric) {
            if (!legend) return;
            
            const isPct = metric.includes('PCT');
            const breaks = (isPct) ? PCT_BREAKS : NOMINAL_ABS_BREAKS;
            const colors = (isPct) ? CHANGE_COLORS : CHORO_COLORS;

            const formatBreak = (val, isPct) => formatValue(val, isPct).replace(' Employees', '').replace('%', '');

            const row = (color, label) => `
                <i style="background:${color}"></i> ${label}<br>
            `;
            
            // UPDATED: Title for legend
            let title = isPct ? 
                `% Change in Employment (${PREVIOUS_YEAR}-${LATEST_YEAR})` : 
                `Total Employees in ${LATEST_YEAR}`;

            let labels = [`<strong>${title}</strong><br>`];

            // Define ranges for nominal breaks (5 bins)
            const fmtRange = (min, max, isPct) => {
                const fMin = formatBreak(min, isPct);
                const fMax = formatBreak(max, isPct);
                return isPct ? `${fMin}% to ${fMax}%` : `${fMin} to ${fMax}`;
            };
            
            // Create legend rows
            labels.push(row(colors[0], isPct ? `< ${formatBreak(breaks[0], true)}%` : `< ${formatBreak(breaks[0], false)}`));
            labels.push(row(colors[1], fmtRange(breaks[0], breaks[1], isPct)));
            labels.push(row(colors[2], fmtRange(breaks[1], breaks[2], isPct)));
            labels.push(row(colors[3], fmtRange(breaks[2], breaks[3], isPct)));
            labels.push(row(colors[4], fmtRange(breaks[3], breaks[4], isPct)));
            labels.push(row(colors[5], isPct ? `> ${formatBreak(breaks[4], true)}%` : `> ${formatBreak(breaks[4], false)}`));

            legend._div.innerHTML = labels.join('');
        }
        
        // --- INITIALIZATION ---

        function initMap() {
            map = L.map('map', { 
                zoomControl: false // Disable default zoom control
            }).setView([18.2208, -66.5901], 9); // Centered on PR
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors, © CartoDB'
            }).addTo(map);

            // Add custom zoom control to bottom right
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Add info control
            info = L.control({position: 'topright'});
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info card');
                this.update();
                return this._div;
            };
            info.update = function (props) {
                this._div.innerHTML = props || 'Hover over a municipio for **Total Employment** details';
            };
            info.addTo(map);

            // Add legend control
            legend = L.control({position: 'bottomleft'});
            legend.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info legend card');
                return this._div;
            };
            legend.addTo(map);
        }

        function loadData() {
            d3.json(DATA_FILE).then(data => {
                // Separate metadata (last object) from data records
                const metadata = data.pop().metadata;
                const records = data;
                
                // Get latest year from data
                LATEST_YEAR = metadata.data_years[metadata.data_years.length - 1];
                PREVIOUS_YEAR = metadata.data_years[metadata.data_years.length - 2];
                FIRST_YEAR = metadata.data_years[0];

                // Populate global dataMap and islandwideData
                records.forEach(d => {
                    if (d.Municipio === 'Puerto Rico') {
                        islandwideData = d;
                    } else {
                        dataMap[d.Municipio] = d;
                    }
                });

                // Update year labels in the HTML
                document.getElementById('latest-year-display').textContent = LATEST_YEAR;
                document.querySelectorAll('.latest-year').forEach(el => el.textContent = LATEST_YEAR);
                document.querySelectorAll('.previous-year').forEach(el => el.textContent = PREVIOUS_YEAR);
                document.querySelectorAll('.first-year').forEach(el => el.textContent = FIRST_YEAR);
                document.getElementById('current-map-year').textContent = LATEST_YEAR;
                
                // Load GeoJSON after data is ready
                loadGeoJson();
                
                // Update Metadata Section
                document.getElementById('metadata-source').textContent = `Source: ${metadata.source}`;
                document.getElementById('metadata-units').textContent = `Units: ${metadata.units}`;
                document.getElementById('metadata-years').textContent = `Years Available: ${metadata.data_years.join(', ')}`;
                document.getElementById('metadata-notes').textContent = `Notes: ${metadata.notes}`;
                document.getElementById('data-note').textContent = `Data reflects Total Paid Employees (NAICS 00) for the reference year (e.g., ${LATEST_YEAR}).`;

                // Initialize details panel and chart
                updateDetailsPanel('Puerto Rico');

            }).catch(error => {
                console.error("Error loading Census data:", error);
                document.getElementById('map').innerHTML = `<p class="text-red-600 p-4">Error loading data. Check console for details.</p>`;
            });
        }

        function loadGeoJson() {
             d3.json(GEO_JSON_FILE).then(geojson => {
                geojsonLayer = L.geoJson(geojson, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Initial render of the map and legend (Default: Nominal Latest Year)
                updateMapMetric('NOMINAL');

            }).catch(error => {
                console.error("Error loading GeoJSON data:", error);
                document.getElementById('map').innerHTML = `<p class="text-red-600 p-4">Error loading GeoJSON. Check console for details.</p>`;
            });
        }

        function updateMapMetric(newMetric) {
            currentMetric = newMetric;

            // 1. Update Map Style (re-color)
            if (geojsonLayer) {
                geojsonLayer.setStyle(style);
            }

            // 2. Update Legend
            updateLegend(newMetric);

            // 3. Update Title
            let titleText;
            switch(newMetric) {
                case 'CUM_PCT_CHANGE':
                    titleText = `% Change in Employment (${FIRST_YEAR}–${LATEST_YEAR})`;
                    break;
                case 'PCT_CHANGE':
                    titleText = `% Change in Employment (${PREVIOUS_YEAR}–${LATEST_YEAR})`;
                    break;
                case 'NOMINAL':
                default:
                    titleText = `Total Employment in ${LATEST_YEAR}`;
                    break;
            }
            document.getElementById('metric-title').innerHTML = `Choropleth Map: <span class="text-indigo-600">${titleText}</span>`;
            
            // 4. Reset highlight (to update info box label)
            updateInfo(null);
            updateDetailsPanel(document.getElementById('detail-municipio').textContent.replace(' Total', ''));
        }

        // --- DOM Event Wiring ---

        function wireMetricButtons() {
            document.querySelectorAll('.metric-option').forEach(button => {
                button.addEventListener('click', (e) => {
                    const metric = e.currentTarget.getAttribute('data-metric');
                    updateMapMetric(metric);
                    
                    // Close the dropdown menu (using the shared logic)
                    document.getElementById('metrics-dropdown-root').classList.remove('hovering');
                });
            });
        }

        function wireDropdown() {
            const root = document.getElementById('metrics-dropdown-root');
            if (!root) return;
            let hoverTimeout;
            const menu = document.getElementById('metrics-menu');
            
            function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
            function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
            
            // Toggle dropdown on button click for mobile/touch
            const menuButton = document.getElementById('menu-button');
            menuButton.addEventListener('click', () => {
                 root.classList.toggle('hovering');
            });
            
            // Hide menu if clicked outside (a simple solution)
            document.addEventListener('click', (event) => {
                if (!root.contains(event.target)) {
                    root.classList.remove('hovering');
                }
            });

            // Re-implement hover logic for desktop experience
            root.addEventListener('mouseenter', addHovering);
            root.addEventListener('mouseleave', removeHovering);
            if (menu) {
              menu.addEventListener('mouseenter', addHovering);
              menu.addEventListener('mouseleave', removeHovering);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData(); 
            wireMetricButtons();
            wireDropdown();
        });

    </script>
</body>
</html>
