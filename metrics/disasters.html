<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Earthquake Plotting in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 75vh; width: 100%; border-radius: .75rem; }
    
    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    /* Simplified scale wrapper for focusing on the map */
    #scale-wrapper {
        transform: scale(1); 
        transform-origin: top center;
        height: auto; 
        padding-bottom: 0;
        margin-bottom: 0; 
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>
      <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold">Earthquake Map</a>
      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
          <div>
            <p class="text-sm font-semibold text-gray-500 uppercase">Natural Disaster Visualization</p>
            <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
              Earthquake Activity in Puerto Rico
            </h1>
            <p class="mt-3 text-lg text-gray-700">
              An interactive map showing earthquake locations and magnitudes near Puerto Rico.
            </p>
            <div class="mt-5">
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-red-100 text-red-800">
                <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-red-800 text-white text-xs">!</span>
                Circle size indicates magnitude: Larger circle = Larger magnitude (Filtered to magnitude 3.5+)
              </span>
            </div>
          </div>
        </div>
      </header>

      <section class="card p-4">
        <div id="map" class="mt-3">
          <div class="leaflet-control-container" id="map-dropdown-container"></div>
        </div>
      </section>

      <hr class="border-gray-300">

      <section class="card p-6 space-y-6">
        <h2 class="text-lg font-semibold">Visualization Details</h2>
        <div class="space-y-4">
          <h3 class="text-base font-semibold text-gray-700">Earthquake Data Source and Plotting</h3>
          <p>
            The data is sourced from historical earthquake catalogs (expected to be USGS/PRSN data). Each red circle marker represents an earthquake, plotted at its hypocenter location.
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
              <li><strong>Magnitude Visualization:</strong> The radius of the circle is directly scaled by the magnitude, providing a quick visual representation of the energy released.</li>
              <li><strong>Filtering:</strong> Only events with a **magnitude of 3.5 or greater** are plotted to avoid map clutter from numerous minor tremors.</li>
              <li><strong>Interactivity:</strong> Click on any circle marker to view the exact magnitude, date, time, depth, and location description.</li>
            </ul>
          </p>
        </div>
      </section>
      </main>
  </div>

  <script>
    // ---------------------- Data paths ----------------------
    // Removed GEOJSON_URL as municipal boundaries are no longer needed
    // Removed EDU_JSON link
    const DISASTER_JSON = '../data/natural_disasters/puerto_rico_earthquakes.json'; 
    
    let _disasterEvents = []; // To store loaded disaster data
    let earthquakeLayerGroup = null; // Global for earthquake markers
    let map = null;
    let prBoundsGlobal = null;

    // ---------------------- NEW: Earthquake Plotting ----------------------
    function plotEarthquakes(data, mapInstance){
        if (!data || data.length === 0) return;

        if (earthquakeLayerGroup) {
            earthquakeLayerGroup.clearLayers();
        } else {
            earthquakeLayerGroup = L.layerGroup().addTo(mapInstance);
        }

        const MIN_MAG_THRESHOLD = 3.5; 

        data.forEach(event => {
            const lat = event.latitude;
            const lng = event.longitude;
            const mag = event.mag;
            const date = event.date;
            const place = event.place || 'Unknown Location';
            const depth = event.depth_km;

            // Ensure magnitude is a number for the filter and scaling
            if (Number(mag) < MIN_MAG_THRESHOLD) return; 

            // Calculate the radius in pixels for L.circleMarker (Magnitude * 3)
            const radius = Number(mag) * 3; 

            const circle = L.circleMarker([lat, lng], {
                radius: radius,
                fillColor: '#b91c1c', 
                color: '#7f1d1d', 
                weight: 1,
                opacity: 1,
                fillOpacity: 0.6
            }).addTo(earthquakeLayerGroup);

            // Bind popup for details
            circle.bindPopup(`
                <strong>Magnitude ${Number(mag).toFixed(1)} Earthquake</strong>
                <br>Place: ${place}
                <br>Date: ${new Date(date).toLocaleString()}
                <br>Depth: ${Number(depth).toFixed(1)} km
            `);

        });
    }

    // ---------------------- Load data + map ----------------------
    (async function init(){
      // Load disaster data
      try {
        const disRes = await fetch(DISASTER_JSON);
        _disasterEvents = await disRes.json();
      } catch (error) {
        console.error("Error loading disaster data:", error);
      }
      
      // Initialize Map Centered on Puerto Rico
      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomControl: false, zoomSnap: .25 }).fitBounds(prBounds);

      L.control.zoom({ position: 'topleft' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Plot the earthquakes 
      plotEarthquakes(_disasterEvents, map);

    })();
    
  </script>
</body>
</html>