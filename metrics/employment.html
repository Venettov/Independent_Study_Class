<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employment & Labor Force in Puerto Rico (2010–2023)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* General site consistency */
    body { background: #f9fafb; color: #111827; font-family: system-ui, sans-serif; }

    /* Cards + subtle shadows for all sections */
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),
                  0 4px 6px -2px rgba(0,0,0,0.05);
    }

    /* Map height similar to population.html */
    #map { height: 60vh; border-radius: 1rem; }

    /* Tooltip styling for map hover */
    .leaflet-tooltip {
      background: rgba(255,255,255,0.95);
      color: #111;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 6px;
    }

    /* Dropdown menu hover persistence (matches population.html) */
    #metrics-menu {
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }
    #metrics-chevron {
      transition: transform .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">
  <!-- 🌐 TOP NAVBAR (identical to population.html) -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="./index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="./metrics.html"
           class="nav-link border-b-2 border-transparent inline-flex items-center gap-1 cursor-pointer select-none">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
               viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"/>
          </svg>
        </a>

        <!-- Dropdown menu under “Metrics” -->
        <div id="metrics-menu"
             class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="./metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">
              All Metrics Overview
            </a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html" class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html" class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html" class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html" class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html" class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html" class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="./literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="./strategy.html" class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="./about.html" class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <!-- 🧭 MAIN CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- 🏁 HERO SECTION -->
    <header class="card p-8">
      <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
      <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
        Employment & Labor Force in Puerto Rico (2010–2023)
      </h1>
      <p class="mt-3 text-lg text-gray-700">
        Explore unemployment rates, employment-to-population ratios, and labor force participation
        for all 78 municipios. Click on any municipio to view detailed trends.
      </p>
    </header>

    <!-- 🗺️ MAP CARD -->
    <section class="card p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-xl font-semibold">Puerto Rico Municipios — Labor Indicators (2023)</h2>

        <!-- Two-button toggle for map mode -->
        <div class="flex mt-3 sm:mt-0 border rounded-lg overflow-hidden">
          <button id="btnUnemp"
                  class="px-4 py-2 text-sm font-semibold bg-blue-600 text-white border border-blue-600">
            Unemployment Rate
          </button>
          <button id="btnEmpPop"
                  class="px-4 py-2 text-sm font-semibold bg-white text-blue-600 border border-blue-600">
            Employment / Population
          </button>
        </div>
      </div>

      <!-- Leaflet Map -->
      <div id="map" class="mt-4"></div>

      <!-- Reset + Clear Buttons below map -->
      <div class="flex gap-2 mt-4">
        <button id="resetBtn"
                class="px-3 py-1.5 text-sm border rounded-lg bg-white hover:bg-gray-50">
          Reset View
        </button>
        <button id="clearSel"
                class="px-3 py-1.5 text-sm border rounded-lg bg-white hover:bg-gray-50">
          Clear Selection
        </button>
      </div>
    </section>

    <!-- 🚀 MUNICIPIO DETAILS + CHART PLACEHOLDERS -->
    <section class="card p-6">
      <h2 class="text-xl font-semibold mb-4">Municipio Employment Details</h2>

      <!-- Info and charts aligned in three columns (like population page) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Municipio summary -->
        <div>
          <p class="text-sm">Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></p>
          <ul class="mt-3 space-y-1 text-sm">
            <li><span class="font-semibold">Unemployment (2023):</span> <span id="d-rate">—</span></li>
            <li><span class="font-semibold">Employment / Population:</span> <span id="d-epr">—</span></li>
            <li><span class="font-semibold">Labor Force Participation:</span> <span id="d-lfp">—</span></li>
          </ul>
        </div>

        <!-- Middle: Unemployment chart -->
        <div>
          <h3 class="font-semibold mb-2">Unemployment Rate Trend (2010–2023)</h3>
          <div class="bg-gray-50 rounded p-3"><canvas id="chartUnemp"></canvas></div>
        </div>

        <!-- Right: Employment/Population chart -->
        <div>
          <h3 class="font-semibold mb-2">Employment / Population Trend</h3>
          <div class="bg-gray-50 rounded p-3"><canvas id="chartEPR"></canvas></div>
        </div>
      </div>

      <!-- Below: LFP chart -->
      <div class="mt-6">
        <h3 class="font-semibold mb-2">Labor Force Participation Trend</h3>
        <div class="bg-gray-50 rounded p-3"><canvas id="chartLFP"></canvas></div>
      </div>
    </section>

    <!-- 🔧 JS START: Data and Map Initialization -->
    <script>
      // ---------- DATA PATHS ----------
      const GEOJSON_URL = './data/tl_2022_72_cousub/pr_municipalities.geojson';
      const EMP_JSON    = './data/employment/municipios_acs_s2301_2010_2023.json';
      const BLS_CSV     = './data/employment/puertorico_bls_unemployment_2010_2024_annual.csv';

      // ---------- GLOBAL VARIABLES ----------
      let acs = [];            // Holds ACS data for all municipios (2010–2023)
      let map, geoLayer;       // Leaflet map + layer
      let currentMode = 'unemployment'; // Active mode (unemployment or employment/population)
      let legendDiv;           // Legend container
      let prBounds;            // Puerto Rico map bounds
      const fmt1 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });

      // ---------- HELPER: Normalize Municipio Names (handles Spanish accents) ----------
      const normalize = s => (s||'')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();

      // ---------- INITIALIZATION ----------
      document.addEventListener('DOMContentLoaded', async () => {
        // Load datasets
        acs = await (await fetch(EMP_JSON)).json();
        const geo = await (await fetch(GEOJSON_URL)).json();

        // Initialize map with default bounds for Puerto Rico
        prBounds = L.latLngBounds([[17.8, -67.5], [18.6, -65.2]]);
        map = L.map('map').fitBounds(prBounds);

        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          minZoom: 7, maxZoom: 19
        }).addTo(map);

        // Create main GeoJSON layer
        geoLayer = L.geoJSON(geo, {
          style: feature => styleFeature(feature),
          onEachFeature: (feature, layer) => {
            const n = feature.properties.NAMELSAD || feature.properties.NAME;
            const info = getLatest(n);
            const tip = info ? `
              <b>${n}</b><br>
              Unemployment: ${fmt1.format(info.unemployment_rate_pct)}%<br>
              Emp/Pop: ${fmt1.format(info.emp_pop_ratio_pct)}%<br>
              LFP: ${fmt1.format(info.labor_force_participation_pct)}%
            ` : `<b>${n}</b><br>No data`;
            layer.bindTooltip(tip);
            layer.on('click', () => updateMunicipio(n));
          }
        }).addTo(map);

        // Add legend control
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
          legendDiv = L.DomUtil.create('div', 'info legend');
          legendDiv.style.background = 'white';
          legendDiv.style.padding = '8px 10px';
          legendDiv.style.borderRadius = '8px';
          legendDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
          legendDiv.style.font = '12px/1.3 system-ui, sans-serif';
          renderLegend();
          return legendDiv;
        };
        legend.addTo(map);

        // Buttons
        document.getElementById('resetBtn').onclick = () => map.fitBounds(prBounds);
        document.getElementById('clearSel').onclick = () => map.fitBounds(prBounds);

        // Toggle buttons behavior
        document.getElementById('btnUnemp').onclick = () => switchMode('unemployment');
        document.getElementById('btnEmpPop').onclick = () => switchMode('employment');

        // Dropdown hover logic (keeps menu open briefly)
        wireDropdown();

        // Default municipio display
        updateMunicipio('Puerto Rico');
      });
      // ---------- COLOR + LEGEND HANDLING ----------
      // Color scales for both toggle modes
      function colorFor(value, mode) {
        if (value == null) return '#cbd5e1'; // gray for missing data
        if (mode === 'unemployment') {
          // Higher unemployment = worse (red)
          if (value < 10) return '#16a34a';
          if (value < 15) return '#a3e635';
          if (value < 20) return '#fde047';
          if (value < 25) return '#f97316';
          if (value < 30) return '#dc2626';
          return '#7f1d1d';
        } else {
          // Higher employment ratio = better (green/blue)
          if (value < 25) return '#f87171';
          if (value < 35) return '#fb923c';
          if (value < 45) return '#fde047';
          if (value < 55) return '#86efac';
          if (value < 65) return '#22c55e';
          return '#15803d';
        }
      }

      // Style each municipio polygon depending on active mode
      function styleFeature(feature) {
        const name = feature.properties.NAMELSAD || feature.properties.NAME;
        const info = getLatest(name);
        const value = info ? (
          currentMode === 'unemployment'
            ? info.unemployment_rate_pct
            : info.emp_pop_ratio_pct
        ) : null;
        return {
          color: '#333',
          weight: 0.3,
          fillOpacity: 0.8,
          fillColor: colorFor(value, currentMode)
        };
      }

      // Render/update legend according to mode
      function renderLegend() {
        if (!legendDiv) return;
        const bins = currentMode === 'unemployment'
          ? [
              { label: '<10%', color: '#16a34a' },
              { label: '10–15%', color: '#a3e635' },
              { label: '15–20%', color: '#fde047' },
              { label: '20–25%', color: '#f97316' },
              { label: '25–30%', color: '#dc2626' },
              { label: '≥30%', color: '#7f1d1d' }
            ]
          : [
              { label: '<25%', color: '#f87171' },
              { label: '25–35%', color: '#fb923c' },
              { label: '35–45%', color: '#fde047' },
              { label: '45–55%', color: '#86efac' },
              { label: '55–65%', color: '#22c55e' },
              { label: '≥65%', color: '#15803d' }
            ];
        legendDiv.innerHTML =
          `<div class="font-semibold mb-1">${
            currentMode === 'unemployment'
              ? 'Unemployment Rate (2023)'
              : 'Employment/Population (2023)'
          }</div>` +
          bins
            .map(
              b =>
                `<div class='flex items-center gap-2'><span style='display:inline-block;width:14px;height:14px;background:${b.color};border:1px solid #0001;border-radius:2px'></span>${b.label}</div>`
            )
            .join('');
      }

      // Switch between unemployment ↔ employment modes
      function switchMode(mode) {
        if (mode === 'employment') {
          currentMode = 'employment';
          document.getElementById('btnUnemp').className =
            'px-4 py-2 text-sm font-semibold bg-white text-blue-600 border border-blue-600';
          document.getElementById('btnEmpPop').className =
            'px-4 py-2 text-sm font-semibold bg-blue-600 text-white border border-blue-600';
        } else {
          currentMode = 'unemployment';
          document.getElementById('btnUnemp').className =
            'px-4 py-2 text-sm font-semibold bg-blue-600 text-white border border-blue-600';
          document.getElementById('btnEmpPop').className =
            'px-4 py-2 text-sm font-semibold bg-white text-blue-600 border border-blue-600';
        }
        geoLayer.setStyle(styleFeature); // recolor polygons
        renderLegend(); // refresh legend
      }

      // ---------- DATA UTILITIES ----------
      function rowsFor(name) {
        return acs
          .filter(r => normalize(r.municipio) === normalize(name))
          .sort((a, b) => a.year - b.year);
      }
      function getLatest(name) {
        return rowsFor(name).find(r => r.year === 2023) || null;
      }

      // ---------- MUNICIPIO DETAIL + CHARTS ----------
      function updateMunicipio(name) {
        const rows = rowsFor(name);
        document.getElementById('d-name').textContent = name;

        const last = rows[rows.length - 1] || {};
        document.getElementById('d-rate').textContent =
          last.unemployment_rate_pct ? fmt1.format(last.unemployment_rate_pct) + '%' : '—';
        document.getElementById('d-epr').textContent =
          last.emp_pop_ratio_pct ? fmt1.format(last.emp_pop_ratio_pct) + '%' : '—';
        document.getElementById('d-lfp').textContent =
          last.labor_force_participation_pct ? fmt1.format(last.labor_force_participation_pct) + '%' : '—';

        const years = rows.map(r => r.year);
        drawMini('chartUnemp', 'line', years, rows.map(r => r.unemployment_rate_pct),
          '#ef4444', 'Unemployment %');
        drawMini('chartEPR', 'bar', years, rows.map(r => r.emp_pop_ratio_pct),
          '#3b82f6', 'Employment/Pop %');
        drawMini('chartLFP', 'line', years, rows.map(r => r.labor_force_participation_pct),
          '#10b981', 'Labor Force Participation %');
      }

      // Generic Chart.js mini-chart function
      function drawMini(id, type, labels, data, color, label) {
        const ctx = document.getElementById(id).getContext('2d');
        if (window[id]) window[id].destroy(); // clear previous
        window[id] = new Chart(ctx, {
          type,
          data: {
            labels,
            datasets: [{
              label,
              data,
              borderColor: color,
              backgroundColor: color + '66',
              fill: type !== 'bar',
              tension: 0.3
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: v => v + '%' } } },
            maintainAspectRatio: false
          }
        });
      }

      // ---------- DROPDOWN HOVER FIX ----------
      function wireDropdown() {
        const root = document.getElementById('metrics-dropdown-root');
        if (!root) return;
        let hoverTimeout;
        const menu = document.getElementById('metrics-menu');
        function addHover() { clearTimeout(hoverTimeout); root.classList.add('hovering'); }
        function removeHover() { hoverTimeout = setTimeout(() => root.classList.remove('hovering'), 250); }
        root.addEventListener('mouseenter', addHover);
        root.addEventListener('mouseleave', removeHover);
        menu.addEventListener('mouseenter', addHover);
        menu.addEventListener('mouseleave', removeHover);
      }

      // ---------- BLS ISLANDWIDE TREND ----------
      async function drawBLS() {
        const txt = await (await fetch(BLS_CSV)).text();
        const rows = txt.trim().split(/\r?\n/).slice(1);
        const data = rows.map(r => {
          const [date, val] = r.split(',');
          return { year: +date.slice(0, 4), value: +val };
        }).filter(d => d.year >= 2010);
        const ctx = document.getElementById('chartBLS').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.year),
            datasets: [{
              label: 'BLS Unemployment %',
              data: data.map(d => d.value),
              borderColor: '#16a34a',
              tension: 0.3,
              fill: false
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: v => v + '%' } } },
            maintainAspectRatio: false
          }
        });
      }

      // ---------- TOP-10 MUNICIPIOS COMPARISON ----------
      function drawTop10() {
        const yr = acs.filter(r => r.year === 2023 && Number.isFinite(r.unemployment_rate_pct));
        const sorted = [...yr].sort((a, b) => a.unemployment_rate_pct - b.unemployment_rate_pct);
        const low = sorted.slice(0, 10);
        const high = sorted.slice(-10).reverse();
        const labels = [...low.map(d => '↓ ' + d.municipio), ...high.map(d => '↑ ' + d.municipio)];
        const values = [...low.map(d => d.unemployment_rate_pct), ...high.map(d => d.unemployment_rate_pct)];

        const ctx = document.getElementById('chartTop10').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Unemployment % (2023)',
              data: values,
              backgroundColor: labels.map(l => l.startsWith('↓') ? '#22c55e' : '#dc2626')
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: v => v + '%' } } },
            maintainAspectRatio: false
          }
        });
      }

      // Draw BLS + Top10 after data load (slight delay for DOM ready)
      setTimeout(() => { drawBLS(); drawTop10(); }, 1200);
    </script>

    <!-- 📈 BLS + TOP-10 CHARTS SECTIONS -->
    <section class="card p-6">
      <h2 class="text-xl font-semibold mb-2">Islandwide Unemployment Rate — BLS (2010–2024)</h2>
      <div class="bg-gray-50 rounded p-3"><canvas id="chartBLS"></canvas></div>
    </section>

    <section class="card p-6 mb-10">
      <h2 class="text-xl font-semibold mb-2">Top 10 Municipios — Lowest & Highest Unemployment (2023)</h2>
      <div class="bg-gray-50 rounded p-3"><canvas id="chartTop10"></canvas></div>
    </section>
  </main>

  <!-- 📚 FOOTER -->
  <footer class="mx-auto max-w-7xl text-sm text-gray-600 mt-6 mb-10 px-4">
    <p>
      <strong>Sources:</strong>
      U.S. Census Bureau ACS 5-Year (S2301, 2010–2023);
      Bureau of Labor Statistics LAUS (2010–2024).
    </p>
  </footer>
</body>
</html>
