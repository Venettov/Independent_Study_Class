<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employment — Puerto Rico Metrics</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body { height: 100%; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .hero { background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%); }
    .hero h1, .hero p { color: #f0f9ff; }
    #map { width: 100%; height: 540px; border-radius: 1rem; }
    .legend { background: white; padding: .5rem .75rem; border-radius: .5rem; line-height: 1.2; box-shadow: 0 2px 8px rgba(0,0,0,.12); }
    .legend i { display:inline-block; width:14px; height:14px; margin-right:6px; border-radius:3px; vertical-align:middle; }
    .leaflet-control-container .leaflet-top.leaflet-right { top: 80px; } /* move zoom under our header */
    .metric-pill { cursor:pointer; }
    .sticky-subnav { position: sticky; top: 0; z-index: 40; }
    /* dropdown hover behavior preserved from your other pages */
    .group:hover .group-hover:block { display:block; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Top Banner / Nav (kept consistent with your site) -->
  <header class="hero">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold text-white">Population & Economic Dynamics in Puerto Rico</div>
        <nav class="hidden md:flex items-center gap-6 text-sky-50">
          <a href="../index.html" class="hover:underline">Home</a>

          <!-- Metrics dropdown with hover persistence -->
          <div class="relative group">
            <a href="../metrics.html" class="hover:underline">Metrics</a>
            <div class="absolute left-0 mt-2 w-56 card p-2 hidden group-hover:block"
                 onmouseenter="this.classList.add('block')"
                 onmouseleave="this.classList.remove('block')">
              <a href="./population.html" class="block px-3 py-2 rounded hover:bg-slate-100">Population</a>
              <a href="./employment.html" class="block px-3 py-2 rounded hover:bg-slate-100 font-semibold">Employment</a>
              <a href="./metrics.html" class="block px-3 py-2 rounded hover:bg-slate-100">All Metrics</a>
              <!-- add other metric pages here as you build them -->
            </div>
          </div>

          <a href="../charts.html" class="hover:underline">Charts</a>
          <a href="../strategy.html" class="hover:underline">Strategy</a>
          <a href="../about.html" class="hover:underline">About</a>
          <a href="../literature.html" class="hover:underline">Literature</a>
        </nav>
      </div>

      <div class="mt-6">
        <h1 class="text-3xl md:text-4xl font-bold">Employment & Unemployment (ACS S2301)</h1>
        <p class="mt-2 text-sky-100">Explore employment rate, unemployment rate, labor force participation, and the employment-population ratio across Puerto Rico’s municipios (2010–2023).</p>
      </div>
    </div>
  </header>
  <!-- Sticky sub-nav with metric pills -->
  <div class="sticky-subnav bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2">
      <span class="text-sm text-slate-600 mr-2">Map metric:</span>
      <button class="metric-pill px-3 py-1.5 rounded-full bg-sky-100 text-sky-800 hover:bg-sky-200"
              data-metric="employment_rate">Employment rate</button>
      <button class="metric-pill px-3 py-1.5 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200"
              data-metric="unemployment_rate">Unemployment rate</button>
      <button class="metric-pill px-3 py-1.5 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200"
              data-metric="labor_force_participation_rate">Labor force participation</button>
      <button class="metric-pill px-3 py-1.5 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200"
              data-metric="employment_population_ratio">Employment-population ratio</button>

      <div class="ml-auto flex items-center gap-3">
        <label class="text-sm text-slate-600">Year</label>
        <select id="yearSelect" class="px-3 py-1.5 rounded border border-slate-300 bg-white">
          <!-- filled via JS (2010 → 2023) -->
        </select>
        <button id="clearSelection" class="px-3 py-1.5 rounded bg-slate-100 hover:bg-slate-200 text-slate-700">Clear selection</button>
      </div>
    </div>
  </div>

  <!-- Map & right info panel -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card p-3">
        <div id="map"></div>
      </div>

      <aside class="card p-5">
        <h2 class="text-xl font-semibold mb-1">Municipio details</h2>
        <p class="text-sm text-slate-600 mb-4">Click a municipio on the map to lock selection. Use the selector below to switch metrics.</p>

        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-slate-600">Selected</span>
            <span id="selName" class="font-medium">—</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-600">Year</span>
            <span id="selYear" class="font-medium">—</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-600">Metric</span>
            <span id="selMetric" class="font-medium">Employment rate</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-600">Value</span>
            <span id="selValue" class="font-semibold">—</span>
          </div>
        </div>

        <div class="mt-4">
          <label class="text-sm text-slate-600">Quick metric</label>
          <select id="detailMetric" class="mt-1 w-full px-3 py-2 rounded border border-slate-300 bg-white">
            <option value="employment_rate">Employment rate</option>
            <option value="unemployment_rate">Unemployment rate</option>
            <option value="labor_force_participation_rate">Labor force participation</option>
            <option value="employment_population_ratio">Employment-population ratio</option>
          </select>
        </div>
      </aside>
    </div>
    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-3" id="tsTitle">Time series (2010–2023) — Employment rate</h3>
        <canvas id="tsChart" height="260"></canvas>
        <p class="text-xs text-slate-500 mt-2">Note: switches to selected municipio; defaults to Puerto Rico total.</p>
      </div>

      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-3" id="barTitle">Latest year comparison — Employment rate</h3>
        <canvas id="barChart" height="260"></canvas>
        <p class="text-xs text-slate-500 mt-2">Compares selected municipio vs Puerto Rico total for the chosen metric.</p>
      </div>
    </section>

    <!-- Sources / Notes -->
    <section class="card p-5 mt-6">
      <h3 class="text-lg font-semibold mb-2">File Sources</h3>
      <ul class="list-disc ml-6 text-sm leading-6">
        <li>ACS Table S2301 — Employment Status (2010–2023) JSON:
          <code class="bg-slate-100 px-1 py-0.5 rounded">data/acs/municipios_acs_s2301_2010_2023_wide.json</code>
        </li>
        <li>Puerto Rico municipios GeoJSON:
          <code class="bg-slate-100 px-1 py-0.5 rounded">data/geo/pr_municipios.geojson</code>
        </li>
        <li>Intercensal 2010–2020 population (for totals context, optional):
          Census “Intercensal 2010–2020 Puerto Rico Municipios” (prm-est2020int-pop-72.xlsx).
        </li>
      </ul>
    </section>
  </main>
  <!-- Scripts -->
  <script>
  // ---------- Paths (adjust if your repo structure differs) ----------
  const GEOJSON_PATH = "../data/geo/pr_municipios.geojson";
  const S2301_JSON   = "../data/acs/municipios_acs_s2301_2010_2023_wide.json";

  // ---------- Years & metrics ----------
  const YEARS = Array.from({length: 2023 - 2010 + 1}, (_, i) => 2010 + i);
  const METRICS = {
    employment_rate: { label: "Employment rate", fmt: v => (v==null?'—':(v*100).toFixed(1)+'%') },
    unemployment_rate: { label: "Unemployment rate", fmt: v => (v==null?'—':(v*100).toFixed(1)+'%') },
    labor_force_participation_rate: { label: "Labor force participation", fmt: v => (v==null?'—':(v*100).toFixed(1)+'%') },
    employment_population_ratio: { label: "Employment-population ratio", fmt: v => (v==null?'—':(v*100).toFixed(1)+'%') },
  };

  // ---------- State ----------
  let rawS2301 = null;          // original JSON
  let dataWide = null;          // normalized to: { muni: { metric: {year: value}, ... }, 'Puerto Rico': {...}}
  let prTotals = {};            // Puerto Rico totals per metric/year if present; else computed average
  let currentMetric = "employment_rate";
  let currentYear   = 2023;
  let lockedMuni    = null;     // string name when clicked

  // ---------- Helpers ----------
  function titleCase(s){ return s ? (s[0].toUpperCase() + s.slice(1)) : s; }

  function injectYears() {
    const sel = document.getElementById('yearSelect');
    YEARS.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      sel.appendChild(opt);
    });
    sel.value = currentYear;
  }

  function normalizeS2301(json) {
    // Accept either:
    //  WIDE array of rows: [{municipio, employment_rate_2010, ..., unemployment_rate_2023, ...}, ...]
    //  or LONG/NESTED like: {municipio: {year: {metric: value}}} or [{municipio, year, metric, value}]
    const out = {};
    const rows = Array.isArray(json) ? json : (json.rows || json.data || json);

    const addVal = (muni, metric, year, val) => {
      if (!out[muni]) out[muni] = {};
      if (!out[muni][metric]) out[muni][metric] = {};
      out[muni][metric][year] = (val === null || val === undefined || val === '') ? null : +val;
    };

    if (Array.isArray(rows)) {
      // Try to detect wide columns by suffix _YYYY
      const sample = rows[0] || {};
      const keys = Object.keys(sample);
      const hasWide = keys.some(k => /_(201\d|202[0-3])$/.test(k));
      if (hasWide) {
        rows.forEach(r => {
          const muni = r.municipio || r.Municipio || r.name || r.muni || r.geoname || "Unknown";
          Object.keys(r).forEach(k => {
            const m = k.match(/^(employment_rate|unemployment_rate|labor_force_participation_rate|employment_population_ratio)_(\d{4})$/);
            if (m) {
              const metric = m[1], year = +m[2];
              addVal(muni, metric, year, r[k]);
            }
          });
        });
      } else {
        // Assume long: {municipio, year, metric, value} or nested objects
        rows.forEach(r => {
          const muni = r.municipio || r.Municipio || r.name || r.muni || "Unknown";
          const year = + (r.year || r.Year);
          const metric = (r.metric || r.Metric || "").toString().toLowerCase();
          let mapped = null;
          if (metric.includes("employment-population")) mapped = "employment_population_ratio";
          else if (metric.includes("labor force") && metric.includes("participation")) mapped = "labor_force_participation_rate";
          else if (metric.includes("unemployment")) mapped = "unemployment_rate";
          else if (metric.includes("employment")) mapped = "employment_rate";
          if (mapped && year >= 2010 && year <= 2023) addVal(muni, mapped, year, r.value ?? r.Value);
        });
      }
    } else {
      // Object form: { municipio: { year: { metric: val } } }
      Object.keys(rows).forEach(muni => {
        const yearsObj = rows[muni];
        Object.keys(yearsObj || {}).forEach(y => {
          const yy = +y;
          const metricsObj = yearsObj[y];
          Object.keys(metricsObj || {}).forEach(metricKey => {
            const mk = metricKey.toLowerCase();
            let mapped = null;
            if (mk.includes("employment_population")) mapped = "employment_population_ratio";
            else if (mk.includes("labor_force_participation")) mapped = "labor_force_participation_rate";
            else if (mk.includes("unemployment")) mapped = "unemployment_rate";
            else if (mk.includes("employment")) mapped = "employment_rate";
            if (mapped && yy >= 2010 && yy <= 2023) addVal(muni, mapped, yy, metricsObj[metricKey]);
          });
        });
      });
    }

    return out;
  }

  function computePRTotals() {
    // Prefer explicit "Puerto Rico" if present; else average municipalities for each metric/year
    const hasPR = !!dataWide["Puerto Rico"];
    Object.keys(METRICS).forEach(metric => {
      prTotals[metric] = {};
      YEARS.forEach(y => {
        if (hasPR && dataWide["Puerto Rico"][metric] && dataWide["Puerto Rico"][metric][y] != null) {
          prTotals[metric][y] = dataWide["Puerto Rico"][metric][y];
        } else {
          // average across municipios that have data for that metric/year
          let sum = 0, n = 0;
          Object.keys(dataWide).forEach(muni => {
            if (muni === "Puerto Rico") return;
            const v = dataWide[muni]?.[metric]?.[y];
            if (v != null) { sum += v; n++; }
          });
          prTotals[metric][y] = n ? sum / n : null;
        }
      });
    });
  }

  function valueFor(muni, metric, year) {
    const v = dataWide[muni]?.[metric]?.[year];
    return (v == null) ? null : +v;
  }

  // ---------- Leaflet ----------
  let map, geoLayer, hoverLayer = null, legendControl;

  function colorScale(metric, v) {
    // Shared % scales (0–100%). We color by “higher-is-better” except unemployment which is reversed.
    if (v == null) return '#e2e8f0';
    const pct = Math.max(0, Math.min(100, v * 100));
    const reversed = (metric === 'unemployment_rate');
    // bins
    const stops = [30, 40, 50, 60, 70]; // %
    const palettes = reversed
      ? ['#14532d','#166534','#16a34a','#86efac','#dcfce7']  // low unemployment = dark green
      : ['#fee2e2','#fecaca','#fca5a5','#f87171','#ef4444']; // higher = darker red
    // map value to bin index
    let idx = 0;
    while (idx < stops.length && pct >= stops[idx]) idx++;
    // reversed palette means low values are dark green; otherwise red scale above
    return reversed ? palettes[idx] : palettes[idx];
  }

  function makeLegend(metric) {
    const reversed = (metric === 'unemployment_rate');
    const bins = [ '<30%', '30–40%', '40–50%', '50–60%', '60–70%', '≥70%' ];
    const colors = reversed
      ? ['#14532d','#166534','#16a34a','#86efac','#dcfce7','#ecfdf5']
      : ['#fee2e2','#fecaca','#fca5a5','#f87171','#ef4444','#991b1b'];
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `<div class="font-medium mb-1">${METRICS[metric].label}</div>` +
      bins.map((b,i)=>`<div class="text-sm"><i style="background:${colors[i]}"></i>${b}</div>`).join('');
    return div;
  }

  function updateLegend() {
    if (legendControl) legendControl.remove();
    legendControl = L.control({ position: 'bottomright' });
    legendControl.onAdd = () => makeLegend(currentMetric);
    legendControl.addTo(map);
  }

  function styleFeature(feature) {
    const muni = feature.properties?.NAME10 || feature.properties?.NAME || feature.properties?.municipio;
    const v = valueFor(muni, currentMetric, currentYear);
    return {
      color: '#334155', weight: 0.8, opacity: 0.7,
      fillColor: colorScale(currentMetric, v),
      fillOpacity: 0.85
    };
  }

  function initMap(geojson) {
    map = L.map('map', { zoomControl: true, minZoom: 7, maxZoom: 12 });
    geoLayer = L.geoJSON(geojson, {
      style: styleFeature,
      onEachFeature: (feature, layer) => {
        const muni = feature.properties?.NAME10 || feature.properties?.NAME || feature.properties?.municipio;
        layer.on({
          mouseover: e => {
            e.target.setStyle({ weight: 2, opacity: 1 });
            if (!lockedMuni) showHover(muni);
          },
          mouseout: e => {
            geoLayer.resetStyle(e.target);
            if (!lockedMuni) clearHover();
          },
          click: () => {
            lockedMuni = muni;
            updateSelectionUI();
            zoomToMunicipio(layer);
            refreshCharts();
          }
        });
      }
    }).addTo(map);

    const bounds = geoLayer.getBounds();
    map.fitBounds(bounds.pad(0.05));
    updateLegend();
  }

  function zoomToMunicipio(layer) {
    map.fitBounds(layer.getBounds().pad(0.2));
  }

  function resetZoom() {
    const b = geoLayer.getBounds();
    map.fitBounds(b.pad(0.05));
  }

  function showHover(muni) {
    const v = valueFor(muni, currentMetric, currentYear);
    document.getElementById('selName').textContent = muni;
    document.getElementById('selValue').textContent = METRICS[currentMetric].fmt(v);
    document.getElementById('selYear').textContent = currentYear;
    document.getElementById('selMetric').textContent = METRICS[currentMetric].label;
  }
  function clearHover() {
    document.getElementById('selName').textContent = '—';
    document.getElementById('selValue').textContent = '—';
  }
  function updateSelectionUI() {
    const name = lockedMuni ?? 'Puerto Rico';
    const v = valueFor(name, currentMetric, currentYear) ?? prTotals[currentMetric][currentYear];
    document.getElementById('selName').textContent = name;
    document.getElementById('selValue').textContent = METRICS[currentMetric].fmt(v);
    document.getElementById('selYear').textContent = currentYear;
    document.getElementById('selMetric').textContent = METRICS[currentMetric].label;
  }

  // ---------- Load data & bootstrap ----------
  async function loadJSON(path) {
    const r = await fetch(path);
    if (!r.ok) throw new Error(`Failed to load ${path}`);
    return r.json();
  }

  async function boot() {
    injectYears();

    rawS2301 = await loadJSON(S2301_JSON);
    dataWide = normalizeS2301(rawS2301);
    computePRTotals();

    const geojson = await loadJSON(GEOJSON_PATH);
    initMap(geojson);

    wireControls();
    updateSelectionUI();
    refreshCharts();
  }

  function wireControls() {
    // metric pills
    document.querySelectorAll('.metric-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.metric-pill').forEach(b => b.classList.remove('bg-sky-100','text-sky-800'));
        document.querySelectorAll('.metric-pill').forEach(b => b.classList.add('bg-slate-100','text-slate-700'));
        btn.classList.add('bg-sky-100','text-sky-800');
        btn.classList.remove('bg-slate-100','text-slate-700');

        currentMetric = btn.dataset.metric;
        updateLegend();
        geoLayer.setStyle(styleFeature);
        updateSelectionUI();
        refreshCharts();
      });
    });

    document.getElementById('detailMetric').addEventListener('change', (e) => {
      currentMetric = e.target.value;
      // sync pill highlight
      document.querySelectorAll('.metric-pill').forEach(b => {
        if (b.dataset.metric === currentMetric) {
          b.classList.add('bg-sky-100','text-sky-800');
          b.classList.remove('bg-slate-100','text-slate-700');
        } else {
          b.classList.remove('bg-sky-100','text-sky-800');
          b.classList.add('bg-slate-100','text-slate-700');
        }
      });
      updateLegend();
      geoLayer.setStyle(styleFeature);
      updateSelectionUI();
      refreshCharts();
    });

    document.getElementById('yearSelect').addEventListener('change', e => {
      currentYear = +e.target.value;
      geoLayer.setStyle(styleFeature);
      updateSelectionUI();
      refreshCharts();
    });

    document.getElementById('clearSelection').addEventListener('click', () => {
      lockedMuni = null;
      resetZoom();
      updateSelectionUI();
      refreshCharts();
    });
  }
  </script>
  <script>
  // ---------- Chart.js ----------
  let tsChart, barChart;

  function ensureCharts() {
    const tsCtx = document.getElementById('tsChart').getContext('2d');
    const barCtx = document.getElementById('barChart').getContext('2d');
    if (!tsChart) {
      tsChart = new Chart(tsCtx, {
        type: 'line',
        data: { labels: YEARS, datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { ticks: { callback: v => v == null ? '—' : (v*100).toFixed(1) + '%' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }
    if (!barChart) {
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { callback: v => v == null ? '—' : (v*100).toFixed(1) + '%' } } },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
  }

  function refreshCharts() {
    ensureCharts();

    const metricLabel = METRICS[currentMetric].label;
    document.getElementById('tsTitle').textContent = `Time series (2010–2023) — ${metricLabel}`;
    document.getElementById('barTitle').textContent = `Latest year comparison — ${metricLabel}`;

    const target = lockedMuni ?? 'Puerto Rico';
    const muniSeries = YEARS.map(y => valueFor(target, currentMetric, y) ?? null);
    const prSeries   = YEARS.map(y => prTotals[currentMetric][y] ?? null);

    tsChart.data.labels = YEARS;
    tsChart.data.datasets = [
      { label: target, data: muniSeries, borderWidth: 2, tension: .2 },
      { label: 'Puerto Rico', data: prSeries, borderWidth: 2, borderDash: [4,3], tension: .2 }
    ];
    tsChart.update();

    // Bar compare (latest year)
    const y = currentYear;
    const muniVal = valueFor(target, currentMetric, y) ?? null;
    const prVal   = prTotals[currentMetric][y] ?? null;

    barChart.data.labels = [String(y)];
    barChart.data.datasets = [
      { label: target, data: [muniVal], borderWidth: 1 },
      { label: 'Puerto Rico', data: [prVal], borderWidth: 1 }
    ];
    barChart.update();
  }

  // ---------- Start ----------
  boot().catch(err => {
    console.error(err);
    alert("Error loading employment page data. Open the console for details.");
  });
  </script>

  <!-- (Optional) Footer kept consistent with your site -->
  <footer class="mt-10 py-8 text-center text-sm text-slate-500">
    Built with Tailwind, Leaflet, and Chart.js • ACS S2301 (2010–2023)
  </footer>
</body>
</html>
