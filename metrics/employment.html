<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employment & Economic Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(22,163,74,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 bg-gray-100 font-semibold">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Employment & Economic Dynamics in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            A graduate research project examining employment, labor force participation, and sustainable development
            strategies through linked data analysis and policy synthesis.
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see county / municipality details
            </span>
          </div>
        </div>
      </div>
    </header>

    <section class="card p-4">
      <div class="flex items-center justify-between gap-3 flex-wrap"> 
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2 flex-wrap"> 
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricEmploymentRate" type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Employment Rate</button>
            <button id="metricUnemploymentRate" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Unemployment Rate</button>
            <button id="metricLFPR" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Labor Force Part.</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4" id="details-metric-title">Employment Rate details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700" id="current-metric-label">Employment Rate (% of Pop 16+ Employed) (2023):</div>
            <ul class="mt-1 space-y-1">
              <li>2023: <span id="d-2023" class="font-semibold">—</span></li>
              <li>Change since 2010: <span id="d-chg" class="font-semibold">—</span></li>
              <li>2022→2023: <span id="d-2223" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">
              Open on data.census.gov ↗
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2" id="line-chart-title">Employment Rate trend (2010–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChart"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2" id="bar-chart-title">Annual Rate Change</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <div class="space-y-4">
        <p>Data for this project was derived from the U.S. Census Bureau American Community Survey (ACS) 5-Year Estimates:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>
            <a href="https://data.census.gov/cedsci/table?tid=ACSCP5Y2023.S2301"
               target="_blank" rel="noopener" class="text-blue-600 underline">
              ACS S2301: Employment Status
            </a>
          </li>
        </ul>

        <p>Specific files used:</p>
        <ul class="list-disc list-inside">
          <li>municipios_acs_s2301_2010_2023.json (site build)</li>
          <li>municipios_acs_s2301_2010_2023.csv (analysis)</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // **CRITICAL PATH CHECK:** Ensure these paths are correct relative to employment.html
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const DATA_JSON   = '../data/municipios_acs_s2301_2010_2023.json';

    const YEARS = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];

    const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    const pctFmt = (v) => `${(Number(v)||0).toFixed(2)}%`;
    const signed = (n) => (n > 0 ? '+' : '') + fmt.format(n);

    // --- CHOROPLETH COLORS AND BREAKS ---
    const GREEN_RED_COLORS = ['#dc2626', '#fca5a5', '#d1d5db', '#6ee7b7', '#10b981', '#047857'];
    const RED_GREEN_COLORS = [...GREEN_RED_COLORS].reverse();

    let EMPLOYMENT_RATE_BREAKS    = [40, 45, 50, 55, 60];
    let UNEMPLOYMENT_RATE_BREAKS  = [15, 12, 9, 6, 3];
    let LFPR_BREAKS               = [50, 52, 54, 56, 58];

    const METRIC_CONFIGS = {
      'EmploymentRate': {
        label: 'Employment Rate (% of Pop 16+ Employed)',
        key: 'emp_pop_ratio_pct',
        colors: GREEN_RED_COLORS,
        breaks: EMPLOYMENT_RATE_BREAKS,
        chartLabel: 'Employment Rate %',
        tooltipSuffix: '%',
        isInverse: false,
      },
      'UnemploymentRate': {
        label: 'Unemployment Rate (% of Labor Force)',
        key: 'unemployment_rate_pct',
        colors: RED_GREEN_COLORS,
        breaks: UNEMPLOYMENT_RATE_BREAKS,
        chartLabel: 'Unemployment Rate %',
        tooltipSuffix: '%',
        isInverse: true,
      },
      'LFPR': {
        label: 'Labor Force Participation Rate (% of Pop 16+ in Labor Force)',
        key: 'labor_force_participation_pct',
        colors: GREEN_RED_COLORS,
        breaks: LFPR_BREAKS,
        chartLabel: 'Labor Force Part. Rate %',
        tooltipSuffix: '%',
        isInverse: false,
      }
    };

    let currentMetric = 'EmploymentRate';

    const sanitizeName = s => {
      let str = String(s || '').trim();
      str = str.replace(/\s*Municipio$/i, '');
      str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return str.toUpperCase().replace(/\s/g, '');
    };

    const yearVal = (municipioData, y, metricKey) => {
      const v = municipioData?.[String(y)]?.[metricKey];
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    };

    function statsForMunicipio(name, metricKey){
      // Special case: Use 'PUERTORICO' key only if the input name is exactly 'Puerto Rico'
      const mapNameKey = (name === 'Puerto Rico') ? 'PUERTORICO' : sanitizeName(name);
      
      const municipioData = _rows[mapNameKey];
      if (!municipioData) return null;

      const vals = YEARS.map(y => yearVal(municipioData, y, metricKey));
      
      // If any year is missing data, return null to signify incomplete stats
      if (vals.some(v => !Number.isFinite(v))) return null;

      const val2010 = vals[YEARS.indexOf(2010)];
      const val2023 = vals[YEARS.indexOf(2023)];
      const abs = val2023 - val2010;
      const pctTot = (abs / val2010) * 100;

      const annualChange = [];
      for (let i = 1; i < YEARS.length; i++) {
        annualChange.push(vals[i] - vals[i - 1]);
      }
      return { vals, abs, pctTot, annualChange, val2023 };
    }

    function censusLink(name){
      const g = '040XX00US72';
      return `https://data.census.gov/cedsci/table?tid=ACSCP5Y2023.S2301&g=${g}`;
    }

    let lineChart = null, barChart = null;
    
    function drawCharts(name, st, metricKey){
      if (!st) return;
      const config = METRIC_CONFIGS[metricKey];
      const ctxL = document.getElementById('lineChart').getContext('2d');
      const ctxB = document.getElementById('barChart').getContext('2d');

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctxL, {
        type: 'line',
        data: { labels: YEARS, datasets:[{ label:config.chartLabel, data: st.vals, tension:.2, pointRadius:3 }] },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${fmt.format(c.parsed.y)}${config.tooltipSuffix}` } } },
          scales:{ y:{ ticks:{ callback:v=>`${fmt.format(v)}${config.tooltipSuffix}` } } },
          maintainAspectRatio:false
        }
      });

      const labels = YEARS.slice(1).map((y,i)=> `${YEARS[i]}→${y}`);
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxB, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Annual Rate Change (pp)', data: st.annualChange.map(v=>+v.toFixed(2)) }] },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${signed(c.parsed.y)} pp` } } },
          scales:{ y:{ ticks:{ callback:v=>`${signed(v)} pp` } } },
          maintainAspectRatio:false
        }
      });
    }

    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const d2023 = document.getElementById('d-2023');
    const dChg  = document.getElementById('d-chg');
    const d2223 = document.getElementById('d-2223');
    const dCenL = document.getElementById('d-census');

    const detailsMetricTitle = document.getElementById('details-metric-title');
    const currentMetricLabel = document.getElementById('current-metric-label');
    const lineChartTitle = document.getElementById('line-chart-title');
    const barChartTitle = document.getElementById('bar-chart-title');


    function updateDetails(name, st, centroid){
      const config = METRIC_CONFIGS[currentMetric];

      dName.textContent = name.replace(/\s*Municipio$/,'');
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      d2023.textContent = Number.isFinite(st?.val2023) ? `${fmt.format(st.val2023)}${config.tooltipSuffix}` : '—';
      dChg.textContent  = st ? `${signed(st.abs)} pp (${pctFmt(st.pctTot)})` : '—';
      const last = st && st.annualChange.length ? st.annualChange[st.annualChange.length-1] : NaN;
      d2223.textContent = Number.isFinite(last) ? `${signed(last)} pp` : '—';
      dCenL.href = censusLink(name);

      detailsMetricTitle.textContent = `${config.label} details`;
      currentMetricLabel.textContent = `${config.label} (2023):`;
      lineChartTitle.textContent = `${config.label} trend (2010–2023)`;
      barChartTitle.textContent = `Annual Rate Change (${config.tooltipSuffix})`;

      drawCharts(name, st, currentMetric);
    }


    let _rows = {}, map, layer, fc, legend;
    let lockedName = null, selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    (async function init(){
      let rawData = [];
      try {
        const res = await fetch(DATA_JSON, { cache:'no-store' });
        if (!res.ok) {
            console.error(`Failed to load data: ${DATA_JSON} status: ${res.status}`);
        } else {
            rawData = await res.json();
        }
      } catch (error) {
        console.error("Error fetching data JSON (check path and JSON syntax):", error);
      }

      // STEP 1: Restructure data (Only if data was loaded successfully)
      if (rawData.length > 0) {
          _rows = rawData.reduce((acc, curr) => {
              const key = sanitizeName(curr.municipio);
              if (!acc[key]) {
                  acc[key] = { Municipio: curr.municipio };
              }
              acc[key][String(curr.year)] = {
                  unemployment_rate_pct: curr.unemployment_rate_pct,
                  emp_pop_ratio_pct: curr.emp_pop_ratio_pct,
                  labor_force_participation_pct: curr.labor_force_participation_pct
              };
              return acc;
          }, {});
          
          // Calculate and store 'Puerto Rico' (overall) aggregated stats
          _rows['PUERTORICO'] = rawData.reduce((acc, curr) => {
              const year = String(curr.year);
              if (!acc[year]) {
                  acc[year] = {
                      unemployment_rate_pct: [],
                      emp_pop_ratio_pct: [],
                      labor_force_participation_pct: []
                  };
              }
              acc[year].unemployment_rate_pct.push(curr.unemployment_rate_pct);
              acc[year].emp_pop_ratio_pct.push(curr.emp_pop_ratio_pct);
              acc[year].labor_force_participation_pct.push(curr.labor_force_participation_pct);
              return acc;
          }, { Municipio: 'Puerto Rico' });
          
          for (const year of YEARS) {
              const y = String(year);
              if (_rows['PUERTORICO'][y] && Array.isArray(_rows['PUERTORICO'][y].unemployment_rate_pct)) {
                  const count = _rows['PUERTORICO'][y].unemployment_rate_pct.length;
                  _rows['PUERTORICO'][y] = {
                      unemployment_rate_pct: _rows['PUERTORICO'][y].unemployment_rate_pct.reduce((a, b) => a + b, 0) / count,
                      emp_pop_ratio_pct: _rows['PUERTORICO'][y].emp_pop_ratio_pct.reduce((a, b) => a + b, 0) / count,
                      labor_force_participation_pct: _rows['PUERTORICO'][y].labor_force_participation_pct.reduce((a, b) => a + b, 0) / count,
                  };
              }
          }
      }

      // STEP 2: Initialize Map
      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Load GeoJSON
      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      if (!gjRes.ok) {
          console.error(`Failed to load GeoJSON: ${GEOJSON_URL} status: ${gjRes.status}`);
          fc = { "type": "FeatureCollection", "features": [] }; 
      } else {
          fc = await gjRes.json();
      }
      
      // STEP 3: Compute Breaks (Only effective if data was loaded)
      computeMetricBreaks('EmploymentRate');
      computeMetricBreaks('UnemploymentRate');
      computeMetricBreaks('LFPR');

      // STEP 4: Add GeoJSON Layer to Map
      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };
      
      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const name = rawName.replace(/\s*Municipio$/,'');
          const geoid = p.GEOID || p.geoid || '';
          
          const st = statsForMunicipio(name, currentMetric);
          
          const changeLine = st
            ? `<br><small>2010→2023: ${signed(st.abs)} pp (${st.pctTot.toFixed(2)}%)</small>`
            : '';
          lyr.bindTooltip(rawName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${rawName}</strong>${geoid?`<br><small>GEOID: ${geoid}</small>`:''}${changeLine}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              e.target.bringToFront?.();
              const c = e.target.getBounds().getCenter();
              updateDetails(name, statsForMunicipio(name, currentMetric), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              const l = e.target;
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = l;
              lockedName = name;
              l.setStyle(selectedOutline);
              map.fitBounds(l.getBounds(), { padding:[20,20] });
              const c = l.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName, currentMetric), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      // STEP 5: Initialize Legend and Details
      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend();
        return div;
      };
      legend.addTo(map);

      function moveLegend() {
        const el = legend._div;
        if (!el) return;
        el.style.marginBottom = Math.round(map.getSize().y * 0.25) + 'px';
        el.style.marginRight  = '8px';
      }
      map.on('resize', moveLegend);
      moveLegend();

      const initName = 'Puerto Rico';
      updateDetails(initName, statsForMunicipio(initName, currentMetric), null);

      wireMetricToggles();
      wireClearSelection();
      wireDropdown();
    })();

    function wireMetricToggles(){
      const buttons = {
        'EmploymentRate': document.getElementById('metricEmploymentRate'),
        'UnemploymentRate': document.getElementById('metricUnemploymentRate'),
        'LFPR': document.getElementById('metricLFPR')
      };

      function setActive(metric){
        currentMetric = metric;
        for (const key in buttons) {
          const btn = buttons[key];
          btn.classList.toggle('bg-blue-600', key === metric);
          btn.classList.toggle('text-white', key === metric);
          btn.classList.toggle('hover:bg-gray-50', key !== metric);
        }

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend();

        const name = lockedName || 'Puerto Rico';
        const c = selectedLayer ? selectedLayer.getBounds().getCenter() : null;
        updateDetails(name, statsForMunicipio(name, currentMetric), c);
      }

      for (const key in buttons) {
        buttons[key].addEventListener('click', () => setActive(key));
      }
      setActive(currentMetric);
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
        updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico', currentMetric), null);
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function styleForFeature(feature){
      const p = feature.properties || {};
      const name = (p.NAME || p.NAMELSAD || p.name || 'Unknown').replace(/\s*Municipio$/,'');
      const st = statsForMunicipio(name, currentMetric);
      
      if (!st) {
        return { fillColor: '#93c5fd', weight: 1.2, color:'#111827', fillOpacity:.5 }; 
      }

      const config = METRIC_CONFIGS[currentMetric];

      const value = st.val2023;
      const breaks = config.breaks;
      const colors = config.colors;
      const col = colorFor(value, breaks, colors, config.isInverse);
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    function colorFor(value, breaks, colors, isInverse = false) {
      if (!Number.isFinite(value)) return '#93c5fd';

      let idx;
      if (isInverse) {
        if (value >= breaks[0]) idx = 0;
        else if (value >= breaks[1]) idx = 1;
        else if (value >= breaks[2]) idx = 2;
        else if (value >= breaks[3]) idx = 3;
        else if (value >= breaks[4]) idx = 4;
        else idx = 5;
      } else {
        if (value <= breaks[0]) idx = 0;
        else if (value <= breaks[1]) idx = 1;
        else if (value <= breaks[2]) idx = 2;
        else if (value <= breaks[3]) idx = 3;
        else if (value <= breaks[4]) idx = 4;
        else idx = 5;
      }
      return colors[idx];
    }

    function renderLegend(){
      if (!legend || !legend._div) return;
      const config = METRIC_CONFIGS[currentMetric];
      const breaks = config.breaks;
      const colors = config.colors;
      const isInverse = config.isInverse;
      const title = `${config.label} (2023)`;

      const labels = [];
      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;

      labels.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);

      if (isInverse) {
        labels.push(row(colors[0], `> ${fmt.format(breaks[0])}${config.tooltipSuffix}`));
        labels.push(row(colors[1], `${fmt.format(breaks[1])}–${fmt.format(breaks[0])}${config.tooltipSuffix}`));
        labels.push(row(colors[2], `${fmt.format(breaks[2])}–${fmt.format(breaks[1])}${config.tooltipSuffix}`));
        labels.push(row(colors[3], `${fmt.format(breaks[3])}–${fmt.format(breaks[2])}${config.tooltipSuffix}`));
        labels.push(row(colors[4], `${fmt.format(breaks[4])}–${fmt.format(breaks[3])}${config.tooltipSuffix}`));
        labels.push(row(colors[5], `≤ ${fmt.format(breaks[4])}${config.tooltipSuffix}`));
      } else {
        labels.push(row(colors[0], `≤ ${fmt.format(breaks[0])}${config.tooltipSuffix}`));
        labels.push(row(colors[1], `${fmt.format(breaks[0])}–${fmt.format(breaks[1])}${config.tooltipSuffix}`));
        labels.push(row(colors[2], `${fmt.format(breaks[1])}–${fmt.format(breaks[2])}${config.tooltipSuffix}`));
        labels.push(row(colors[3], `${fmt.format(breaks[2])}–${fmt.format(breaks[3])}${config.tooltipSuffix}`));
        labels.push(row(colors[4], `${fmt.format(breaks[3])}–${fmt.format(breaks[4])}${config.tooltipSuffix}`));
        labels.push(row(colors[5], `> ${fmt.format(breaks[4])}${config.tooltipSuffix}`));
      }

      legend._div.innerHTML = labels.join('');
    }

    function computeMetricBreaks(metricKey){
      const values = [];
      (fc.features || []).forEach(f => {
        const p = f.properties || {};
        const name = (p.NAME || p.NAMELSAD || p.name || 'Unknown').replace(/\s*Municipio$/,'');
        const st = statsForMunicipio(name, metricKey);
        if (st && Number.isFinite(st.val2023)) values.push(st.val2023);
      });
      if (!values.length) return;

      values.sort((a,b)=>a-b);
      
      const q = (arr, t) => {
        if (!arr.length) return NaN;
        const i = (arr.length - 1) * t;
        const lo = Math.floor(i), hi = Math.ceil(i);
        if (lo === hi) return arr[lo];
        return arr[lo] * (hi - i) + arr[hi] * (i - lo);
      };

      const breaks = [
        q(values, 0.1),
        q(values, 0.3),
        q(values, 0.5),
        q(values, 0.7),
        q(values, 0.9)
      ].map(v => parseFloat(v.toFixed(1)));

      METRIC_CONFIGS[metricKey].breaks = breaks;

      if (METRIC_CONFIGS[metricKey].isInverse) {
        METRIC_CONFIGS[metricKey].breaks.reverse();
      }
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const subPageLink = document.querySelector('#metrics-menu a[href="employment.html"]');
      if (subPageLink) subPageLink.classList.add('bg-gray-100','font-semibold');
    });
  </script>
</body>
</html>