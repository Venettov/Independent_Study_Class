<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Employment & Labor Force – Puerto Rico</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .card { background:#fff; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
  #map { height: 50vh; width: 100%; border-radius: .75rem; }
  .leaflet-tooltip { background: rgba(255,255,255,.95); font-size:14px; font-weight:600; padding:5px 10px; }
  .mini { min-height: 260px; }
</style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
  <header class="card p-8 bg-gradient-to-r from-sky-50 to-slate-100">
    <h1 class="text-4xl font-extrabold">Employment & Labor Force in Puerto Rico</h1>
    <p class="mt-3 text-gray-700">
      This interactive map shows unemployment rates and labor force participation for all 78 municipios.
      Hover for quick stats, click for detailed time trends (2010–2023).
    </p>
  </header>

  <!-- MAP SECTION -->
  <section class="card p-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Unemployment Rate by Municipio (2023)</h2>
      <button id="clearSel" class="px-3 py-1.5 text-sm border rounded-lg bg-white hover:bg-gray-50">Clear Selection</button>
    </div>
    <div id="map" class="mt-3"></div>
  </section>

  <!-- DETAILS + CHARTS -->
  <section class="card p-6">
    <h2 class="text-lg font-semibold mb-4">Municipio Employment Details</h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div>
        <p><span class="font-semibold">Municipio:</span> <span id="d-name">Puerto Rico</span></p>
        <p><span class="font-semibold">Unemployment (2023):</span> <span id="d-rate">—</span></p>
        <p><span class="font-semibold">Employment/Pop Ratio:</span> <span id="d-epr">—</span></p>
        <p><span class="font-semibold">Labor Force Participation:</span> <span id="d-lfp">—</span></p>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Unemployment Rate Trend (2010–2023)</h3>
        <div class="mini bg-gray-50 rounded p-3"><canvas id="lineChart"></canvas></div>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Employment/Population Ratio Trend</h3>
        <div class="mini bg-gray-50 rounded p-3"><canvas id="barChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Islandwide BLS -->
  <section class="card p-6">
    <h2 class="text-lg font-semibold mb-3">Puerto Rico Annual Unemployment Rate (BLS)</h2>
    <div class="bg-gray-50 rounded p-3"><canvas id="islandChart"></canvas></div>
  </section>
</main>

<script>
const GEOJSON_URL = "../data/tl_2022_72_cousub/pr_municipalities.geojson";
const EMP_JSON = "../data/employment/municipios_acs_s2301_2010_2023.json";
const BLS_CSV = "../data/employment/puertorico_bls_unemployment_2010_2024_annual.csv";

const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });
const COLORS = ['#7f1d1d','#b91c1c','#f97316','#fde68a','#bbf7d0','#22c55e','#15803d'];

let map, geoLayer, acsData = [], blsData = [];

fetch(EMP_JSON).then(r=>r.json()).then(data=>{
  acsData = data;
  return fetch(GEOJSON_URL);
}).then(r=>r.json()).then(geo=>{
  initMap(geo);
  loadBLS();
});

function initMap(geo){
  map = L.map('map').setView([18.2,-66.4],8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
  }).addTo(map);

  geoLayer = L.geoJSON(geo,{
    style: f => ({
      color:'#333', weight:0.5, fillOpacity:0.8,
      fillColor: colorFor(getRate(f.properties.NAMELSAD))
    }),
    onEachFeature:(f,l)=>{
      const name = f.properties.NAMELSAD;
      const rec = getLatest(name);
      const tip = rec ?
        `<b>${name}</b><br>
         Unemp: ${fmt.format(rec.unemployment_rate_pct)}%<br>
         Emp/Pop: ${fmt.format(rec.emp_pop_ratio_pct)}%<br>
         LFP: ${fmt.format(rec.labor_force_participation_pct)}%` :
        `<b>${name}</b><br>No data`;
      l.bindTooltip(tip);
      l.on('click',()=>updateMunicipio(name));
    }
  }).addTo(map);
}

function getLatest(name){
  const arr = acsData.filter(d => d.municipio.normalize("NFD").replace(/[\u0300-\u036f]/g,"") === name.normalize("NFD").replace(/[\u0300-\u036f]/g,""));
  if(!arr.length) return null;
  return arr.find(d=>d.year===2023);
}
function getRate(name){
  const d = getLatest(name);
  return d ? d.unemployment_rate_pct : null;
}

function colorFor(v){
  if(v==null) return '#cbd5e1';
  if(v<10) return COLORS[5];
  if(v<15) return COLORS[4];
  if(v<20) return COLORS[3];
  if(v<25) return COLORS[2];
  if(v<30) return COLORS[1];
  return COLORS[0];
}

function updateMunicipio(name){
  const recs = acsData.filter(d => d.municipio.normalize("NFD").replace(/[\u0300-\u036f]/g,"") === name.normalize("NFD").replace(/[\u0300-\u036f]/g,""));
  if(!recs.length) return;
  const last = recs[recs.length-1];
  document.getElementById('d-name').textContent = name;
  document.getElementById('d-rate').textContent = fmt.format(last.unemployment_rate_pct)+"%";
  document.getElementById('d-epr').textContent = fmt.format(last.emp_pop_ratio_pct)+"%";
  document.getElementById('d-lfp').textContent = fmt.format(last.labor_force_participation_pct)+"%";
  drawCharts(recs);
}

function drawCharts(recs){
  const years = recs.map(r=>r.year);
  const unemp = recs.map(r=>r.unemployment_rate_pct);
  const epr = recs.map(r=>r.emp_pop_ratio_pct);

  const ctxL = document.getElementById('lineChart').getContext('2d');
  const ctxB = document.getElementById('barChart').getContext('2d');
  if(window.lineC) window.lineC.destroy();
  if(window.barC) window.barC.destroy();

  window.lineC = new Chart(ctxL,{
    type:'line',
    data:{ labels: years, datasets:[{label:'Unemployment %',data:unemp,borderColor:'#ef4444',fill:false,tension:.3}] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>v+"%"}}}, maintainAspectRatio:false }
  });

  window.barC = new Chart(ctxB,{
    type:'bar',
    data:{ labels: years, datasets:[{label:'Employment/Pop %',data:epr,backgroundColor:'#3b82f6'}] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>v+"%"}}}, maintainAspectRatio:false }
  });
}

function loadBLS(){
  fetch(BLS_CSV).then(r=>r.text()).then(txt=>{
    const rows = txt.trim().split(/\r?\n/).slice(1);
    const data = rows.map(r=>{
      const [date,val] = r.split(',');
      return { year:+date.slice(0,4), value:+val };
    }).filter(d=>d.year>=2010);
    drawIslandChart(data);
  });
}

function drawIslandChart(data){
  const ctx = document.getElementById('islandChart').getContext('2d');
  new Chart(ctx,{
    type:'line',
    data:{ labels:data.map(d=>d.year), datasets:[{label:'Unemployment % (BLS)', data:data.map(d=>d.value), borderColor:'#10b981', tension:.3}] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>v+"%"}}}, maintainAspectRatio:false }
  });
}

document.getElementById('clearSel').onclick=()=>{ map.setView([18.2,-66.4],8); };
</script>

</body>
</html>
