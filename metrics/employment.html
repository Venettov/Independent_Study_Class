<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employment & Unemployment — Puerto Rico</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(16,185,129,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover (matches population.html) */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- NAV (kept identical to population.html) -->
  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 bg-gray-100 font-semibold">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Employment & Unemployment Trends in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            Municipal-level employment-to-population ratio and unemployment rates (2010–2023), built from ACS S2301.
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see municipality details. Click to lock; “Clear selection” to reset.
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- MAP -->
    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricEmp"   type="button" class="px-3 py-1.5 text-sm font-medium bg-blue-600 text-white">Employment Ratio</button>
            <button id="metricUnemp" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Unemployment Rate</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <!-- DETAILS -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Employment details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico (avg)</span></div>
            <div>GEOID: <span id="d-geoid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Latest Year (2023):</div>
            <ul class="mt-1 space-y-1">
              <li>Employment-Population Ratio: <span id="d-emp" class="font-semibold">—</span></li>
              <li>Unemployment Rate: <span id="d-unemp" class="font-semibold">—</span></li>
              <li>Labor Force Participation: <span id="d-lfp" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">View ACS S2301 profile ↗</a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Employment Ratio Trend (2010–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartEmp"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Unemployment Rate Trend (2010–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartUnemp"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- SOURCES -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <p>Data derived from the U.S. Census Bureau, American Community Survey (ACS Table S2301):</p>
      <ul class="list-disc list-inside space-y-1 mt-2">
        <li><a href="https://data.census.gov/table?q=S2301:+EMPLOYMENT+STATUS&g=040XX00US72" target="_blank" class="text-blue-600 underline">
          ACS S2301 Employment Status — Puerto Rico (2010–2023)
        </a></li>
        <li><code>municipios_acs_s2301_2010_2023.json</code> (processed site file)</li>
      </ul>
    </section>
  </main>

  <!-- SCRIPT -->
  <script>
    // ---- Paths & constants ----
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const EMP_JSON    = '../data/employment/municipios_acs_s2301_2010_2023.json'; // fields per row: year, municipio, geoid, unemployment_rate_pct, emp_pop_ratio_pct, labor_force_participation_pct
    const YEARS = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];

    // ---- Formatting helpers ----
    const pct1 = v => Number.isFinite(+v) ? (+v).toFixed(1)+'%' : '—';
    const pctTick = v => (v===0? '0%': (Math.abs(v)>=1? v.toFixed(0)+'%': v.toFixed(1)+'%'));

    // ---- State ----
    let map, layer, legend, fc;
    let metric = 'emp'; // 'emp' | 'unemp'
    let selectedLayer = null, lockedName = null;

    // Data stores
    // dataByName: { name -> { byYear: {year: {emp, unemp, lfp}}, geoid? } }
    const dataByName = new Map();

    // ---- Build in-memory tables from flat rows ----
    function ingest(rows){
      rows.forEach(r => {
        const name = String(r.municipio || r.Municipio || '').replace(/\s*Municipio$/,'').trim();
        if(!name) return;
        const year = +r.year;
        const emp  = +r.emp_pop_ratio_pct;
        const un   = +r.unemployment_rate_pct;
        const lfp  = +r.labor_force_participation_pct;
        const geoid= String(r.geoid || r.GEOID || r.county_fips || '').padStart(5,'0');

        if(!dataByName.has(name)) dataByName.set(name, { byYear:{}, geoid: geoid || null });
        const rec = dataByName.get(name);
        rec.byYear[year] = { emp, un, lfp };
        if(geoid) rec.geoid = geoid;
      });
    }

    // ---- Get ordered series for a municipio ----
    function seriesFor(name){
      const rec = dataByName.get(name);
      if(!rec) return null;
      const byY = rec.byYear;
      const emp = YEARS.map(y => (byY[y]?.emp));
      const un  = YEARS.map(y => (byY[y]?.un));
      const lfp = YEARS.map(y => (byY[y]?.lfp));
      return { emp, un, lfp, geoid: rec.geoid || null };
    }

    // ---- Island-wide average (unweighted) ----
    function islandAverage(){
      const names = Array.from(dataByName.keys());
      const sum = (arrs) => arrs[0].map((_,i)=> {
        let s=0, c=0;
        for(const a of arrs){ const v = +a[i]; if(Number.isFinite(v)) { s+=v; c++; } }
        return c? s/c : NaN;
      });
      const allEmp = names.map(n => seriesFor(n).emp);
      const allUn  = names.map(n => seriesFor(n).un);
      const allLfp = names.map(n => seriesFor(n).lfp);
      return { emp: sum(allEmp), un: sum(allUn), lfp: sum(allLfp), geoid: null };
    }

    // ---- Legend breaks (quantiles from latest year for current metric) ----
    function computeBreaks(){
      const idx = YEARS.length-1;
      const vals = [];
      dataByName.forEach(rec => {
        const s = seriesFor(recName(rec));
      });
      const arr = Array.from(dataByName.keys()).map(n=>{
        const s = seriesFor(n); return metric==='emp'? s.emp[idx] : s.un[idx];
      }).filter(v=>Number.isFinite(v)).sort((a,b)=>a-b);
      const q = t => {
        if(!arr.length) return null;
        const i = (arr.length-1)*t; const lo = Math.floor(i), hi = Math.ceil(i);
        return lo===hi ? arr[lo] : arr[lo]*(hi-i)+arr[hi]*(i-lo);
      };
      const b1=q(0.20), b2=q(0.40), b3=q(0.60), b4=q(0.80);
      return [b1,b2,b3,b4].map(v=> Number.isFinite(v)? v : null);
    }

    // ---- Color scale ----
    const COLORS = ['#7f1d1d','#b91c1c','#f97316','#bbf7d0','#22c55e','#15803d'];
    let BREAKS = null; // computed per metric

    function colorFor(v){
      if(!Number.isFinite(v) || BREAKS==null) return '#93c5fd';
      const [b1,b2,b3,b4] = BREAKS;
      if(v <= b1) return COLORS[0];
      if(v <= b2) return COLORS[1];
      if(v <= b3) return COLORS[2];
      if(v <= b4) return COLORS[3];
      // > top break → greener
      return COLORS[5];
    }

    // ---- Map feature styling ----
    function styleForFeature(feature){
      const name = (feature.properties.NAME || feature.properties.NAMELSAD || 'Unknown').replace(/\s*Municipio$/,'');
      const s = seriesFor(name);
      const v = s ? (metric==='emp' ? s.emp[YEARS.length-1] : s.un[YEARS.length-1]) : NaN;
      return { fillColor: colorFor(v), weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    // ---- Tooltip/Popup text ----
    function tipFor(name){
      const s = seriesFor(name);
      const emp = s ? s.emp[YEARS.length-1] : NaN;
      const un  = s ? s.un[YEARS.length-1]  : NaN;
      return `${name}<br>Emp-Pop Ratio: <b>${pct1(emp)}</b><br>Unemployment: <b>${pct1(un)}</b>`;
    }

    // ---- Charts ----
    let chartEmp=null, chartUn=null;
    function drawCharts(s){
      const ctxE = document.getElementById('lineChartEmp').getContext('2d');
      const ctxU = document.getElementById('lineChartUnemp').getContext('2d');
      if(chartEmp) chartEmp.destroy();
      if(chartUn)  chartUn.destroy();
      if(!s) return;

      chartEmp = new Chart(ctxE, {
        type:'line',
        data:{ labels:YEARS, datasets:[{ label:'Employment Ratio', data:s.emp, tension:.2, pointRadius:2 }]},
        options:{
          plugins:{ legend:{ display:false }},
          scales:{ y:{ ticks:{ callback:pctTick } } },
          maintainAspectRatio:false
        }
      });

      chartUn = new Chart(ctxU, {
        type:'line',
        data:{ labels:YEARS, datasets:[{ label:'Unemployment Rate', data:s.un, tension:.2, pointRadius:2 }]},
        options:{
          plugins:{ legend:{ display:false }},
          scales:{ y:{ ticks:{ callback:pctTick } } },
          maintainAspectRatio:false
        }
      });
    }

    // ---- Detail panel ----
    const dName  = document.getElementById('d-name');
    const dGEOID = document.getElementById('d-geoid');
    const dEmp   = document.getElementById('d-emp');
    const dUn    = document.getElementById('d-unemp');
    const dLfp   = document.getElementById('d-lfp');
    const dLink  = document.getElementById('d-census');

    function updateDetails(name, s, geoid){
      dName.textContent = name;
      dGEOID.textContent = geoid || '—';
      dEmp.textContent = pct1(s?.emp?.slice(-1)[0]);
      dUn.textContent  = pct1(s?.un?.slice(-1)[0]);
      dLfp.textContent = pct1(s?.lfp?.slice(-1)[0]);

      // Census profile link: county-equivalent (0500000US + GEOID)
      if(geoid){
        dLink.href = `https://data.census.gov/profile/${encodeURIComponent(name)},_Puerto_Rico?g=0500000US${geoid}`;
      } else {
        dLink.href = `https://data.census.gov/table?q=S2301:+EMPLOYMENT+STATUS&g=040XX00US72`;
      }
      drawCharts(s);
    }

    // ---- Legend control ----
    function addOrUpdateLegend(){
      if(!legend){
        legend = L.control({ position:'bottomright' });
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'info legend');
          div.style.background = 'white';
          div.style.padding = '8px 10px';
          div.style.borderRadius = '8px';
          div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
          div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
          legend._div = div;
          return div;
        };
        legend.addTo(map);
      }
      renderLegend();
    }

    function renderLegend(){
      if(!legend || !legend._div) return;
      const title = metric==='emp' ? 'Employment-to-Population Ratio (%)' : 'Unemployment Rate (%)';
      const [b1,b2,b3,b4] = BREAKS || [];
      const lines = [];
      lines.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      function swatch(color, txt){
        return `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
          <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};border:1px solid rgba(0,0,0,.15)"></span>
          <span>${txt}</span></div>`;
      }
      if(BREAKS){
        lines.push(swatch(COLORS[0], `≤ ${pct1(b1).replace('%','')}%`));
        lines.push(swatch(COLORS[1], `${pct1(b1).replace('%','')}% – ${pct1(b2).replace('%','')}%`));
        lines.push(swatch(COLORS[2], `${pct1(b2).replace('%','')}% – ${pct1(b3).replace('%','')}%`));
        lines.push(swatch(COLORS[3], `${pct1(b3).replace('%','')}% – ${pct1(b4).replace('%','')}%`));
        lines.push(swatch(COLORS[5], `> ${pct1(b4).replace('%','')}%`));
      } else {
        lines.push('<em>No data</em>');
      }
      legend._div.innerHTML = lines.join('');
    }

    // ---- Interactions ----
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };

    function bindFeature(f, lyr){
      const name = (f.properties.NAME || f.properties.NAMELSAD || 'Unknown').replace(/\s*Municipio$/,'');
      const geoid = String(f.properties.GEOID || '').padStart(5,'0');
      const tip = tipFor(name);
      lyr.bindTooltip(tip, { direction:'center', className:'leaflet-tooltip' });

      lyr.on({
        mouseover: e => {
          if (lockedName) return;
          e.target.setStyle({ weight:3, color:'#111827' });
          const s = seriesFor(name);
          updateDetails(name, s, geoid);
        },
        mouseout: e => {
          if (lockedName) return;
          layer.resetStyle(e.target);
        },
        click: e => {
          if (selectedLayer) layer.resetStyle(selectedLayer);
          selectedLayer = e.target;
          lockedName = name;
          e.target.setStyle(selectedOutline);
          updateDetails(name, seriesFor(name), geoid);
          map.fitBounds(e.target.getBounds(), { padding:[20,20] });
        }
      });
    }

    function wireControls(){
      const btnEmp   = document.getElementById('metricEmp');
      const btnUnemp = document.getElementById('metricUnemp');
      const clearSel = document.getElementById('clearSel');

      function setMetric(m){
        metric = m;
        btnEmp.classList.toggle('bg-blue-600', m==='emp');
        btnEmp.classList.toggle('text-white', m==='emp');
        btnUnemp.classList.toggle('bg-blue-600', m==='unemp');
        btnUnemp.classList.toggle('text-white', m==='unemp');

        BREAKS = computeBreaks();
        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        renderLegend();

        // Keep current selection highlighted
        if(selectedLayer) selectedLayer.setStyle(selectedOutline);
      }

      btnEmp.addEventListener('click', ()=> setMetric('emp'));
      btnUnemp.addEventListener('click', ()=> setMetric('unemp'));
      clearSel.addEventListener('click', ()=>{
        lockedName = null;
        if (selectedLayer){ layer.resetStyle(selectedLayer); selectedLayer=null; }
        // Reset to island average
        updateDetails('Puerto Rico (avg)', islandAvgSeries, null);
        map.fitBounds(layer.getBounds(), { padding:[15,15] });
      });

      setMetric('emp'); // default
    }

    // ---- Dropdown hover persistence (same as population.html) ----
    function wireDropdown(){
      const root = document.getElementById('metrics-dropdown-root');
      const menu = document.getElementById('metrics-menu');
      if (!root || !menu) return;
      let hoverTimeout;
      function addHover(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function remHover(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHover);
      root.addEventListener('mouseleave', remHover);
      menu.addEventListener('mouseenter', addHover);
      menu.addEventListener('mouseleave', remHover);
    }

    // ---- Init ----
    let islandAvgSeries = null;

    (async function init(){
      // Load ACS rows, ingest → dataByName
      const rows = await fetch(EMP_JSON, { cache:'no-store' }).then(r=>r.json());
      ingest(rows);

      // Compute island average
      islandAvgSeries = islandAverage();

      // Build map
      map = L.map('map', { zoomSnap:.25 }).fitBounds([[17.85, -67.45],[18.55, -65.25]]);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      fc = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now()).then(r=>r.json());
      layer = L.geoJSON(fc, { style: f=>styleForFeature(f), onEachFeature: bindFeature }).addTo(map);

      BREAKS = computeBreaks();
      addOrUpdateLegend();

      // Seed details with island average
      updateDetails('Puerto Rico (avg)', islandAvgSeries, null);

      wireControls();
      wireDropdown();

      // Highlight current submenu item
      const currentPathname = window.location.pathname.split('/').pop();
      const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
      if (subPageLink) subPageLink.classList.add('bg-gray-100','font-semibold');
    })();
  </script>
</body>
</html>
