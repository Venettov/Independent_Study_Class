<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employment & Labor Dynamics in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    #map { height: 48vh; width: 100%; border-radius: .75rem; }
    @media (min-width: 1280px) { #map { height: 46vh; } }
    @media (max-width: 640px)  { #map { height: 54vh; } }

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 260px; }

    /* Dropdown show-on-hover */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="../metrics.html" class="block px-4 py-2 hover:bg-gray-50 font-semibold">All Metrics Overview</a>
            <div class="my-1 border-t border-gray-100"></div>
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 bg-gray-100 font-semibold">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <header class="card hero p-6 sm:p-8 lg:p-10 relative">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
          <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
            Employment & Labor Dynamics in Puerto Rico
          </h1>
          <p class="mt-3 text-lg text-gray-700">
            A graduate research project examining employment trends, labor force participation, and unemployment shifts across Puerto Rico’s municipalities.
          </p>
          <div class="mt-5">
            <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              Hover over the map to see municipality employment metrics
            </span>
          </div>
        </div>
      </div>
    </header>

    <section class="card p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-gray-700 font-medium">Map shading by</div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            <button id="metricEmp" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Employment-Pop Ratio</button>
            <button id="metricUnemp" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Unemployment Rate</button>
            <button id="metricLabor" type="button" class="px-3 py-1.5 text-sm font-medium hover:bg-gray-50">Labor Force Part.</button>
          </div>
          <button id="clearSel" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Clear selection</button>
        </div>
      </div>
      <div id="map" class="mt-3"></div>
    </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Employment details</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <div class="text-sm">
            <div>Municipio: <span id="d-name" class="font-semibold">Puerto Rico</span></div>
            <div>Centroid: <span id="d-centroid" class="text-gray-600">—</span></div>
          </div>

          <div class="mt-4 text-sm">
            <div class="font-semibold text-gray-700">Latest Values (2023):</div>
            <ul class="mt-1 space-y-1">
              <li>Employment-population ratio: <span id="d-emppop" class="font-semibold">—</span></li>
              <li>Unemployment rate: <span id="d-unemp" class="font-semibold">—</span></li>
              <li>Labor force participation: <span id="d-labor" class="font-semibold">—</span></li>
            </ul>
          </div>

          <div class="mt-4 text-sm">
            <a id="d-census" class="text-blue-600 underline" href="#" target="_blank" rel="noopener">
              Open on data.census.gov ↗
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Employment-Pop Ratio Trend (2010–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartEmpPop"></canvas>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Labor Force Participation Trend (2010–2023)</h3>
          <div class="mini bg-gray-50 rounded p-3">
            <canvas id="lineChartLabor"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Unemployment Rate Changes</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h3 class="font-semibold mb-2">Unemployment Rate Trend (2010–2023)</h3>
                <div class="mini bg-gray-50 rounded p-3">
                    <canvas id="barChartUnemp"></canvas>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Annual Unemployment Change (2022–2023)</h3>
                <div class="mini bg-gray-50 rounded p-3">
                    <canvas id="barChartAnnualChange"></canvas>
                </div>
            </div>
        </div>
    </section>

    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">File Sources</h2>
      <div class="space-y-4">
        <p>Data for this project was derived from the U.S. Census Bureau’s American Community Survey (ACS S2301):</p>
        <ul class="list-disc list-inside space-y-1">
          <li>
            <a href="https://data.census.gov/table?q=S2301:+EMPLOYMENT+STATUS+Puerto+Rico"
               target="_blank" rel="noopener" class="text-blue-600 underline">
              ACS S2301 – Employment Status, Puerto Rico Municipalities
            </a>
          </li>
        </ul>

        <p>Specific files used:</p>
        <ul class="list-disc list-inside">
          <li>municipios_acs_s2301_2010_2023_wide.json (site build)</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // ---- Config ----
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    // Adjust this path if your JSON lives elsewhere:
    const EMP_JSON    = '../data/employment/municipios_acs_s2301_2010_2023_wide.json';

    const YEARS = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];
    const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });

    // Choropleth colors
    const CHORO_COLORS = ['#7f1d1d', '#b91c1c', '#f97316', '#bbf7d0', '#22c55e', '#15803d'];
    const EMP_BREAKS   = [30, 33, 36, 39, 42]; // employment-pop ratio % bins (Higher is better)
    const UNEMP_BREAKS = [5, 10, 15, 20, 25];  // unemployment rate % bins (Lower is better)
    const LABOR_BREAKS = [35, 38, 41, 44, 47]; // labor force participation % bins (Higher is better)

    const sanitizeName = s => String(s||'').trim();

    // ---- Data helpers ----
    function statsForMunicipio(name){
      const key = sanitizeName(name).replace(/\s*Municipio$/,'');
      const row = _rows.find(r => sanitizeName(r.Municipio) === key);
      if (!row) return null;

      const empVals   = YEARS.map(y => Number(row[`EmpPop_${y}`]));
      const unempVals = YEARS.map(y => Number(row[`Unemp_${y}`]));
      const laborVals = YEARS.map(y => Number(row[`LaborForce_${y}`]));

      return { empVals, unempVals, laborVals, row };
    }
    
    // NEW/MODIFIED: Added mode parameter to handle color direction
    function colorFor(value, breaks, mode) {
      if (!Number.isFinite(value)) return '#93c5fd';
      const isHigherBetter = (mode === 'emp' || mode === 'labor');
      
      let colors = [...CHORO_COLORS];
      if (isHigherBetter) colors = colors.reverse();
      
      if (value <= breaks[0]) return colors[0];
      if (value <= breaks[1]) return colors[1];
      if (value <= breaks[2]) return colors[2];
      if (value <= breaks[3]) return colors[3];
      if (value <= breaks[4]) return colors[4];
      return colors[5];
    }
    
    // NEW: Function to get array of all municipality names (excluding PR aggregate)
    function getAllMunicipios() {
        return _rows.filter(r => r.Municipio !== 'Puerto Rico').map(r => r.Municipio).sort();
    }
    
    // NEW: Function to prepare data for the Annual Change Bar Chart
    function prepareAnnualChangeData() {
        const municipios = getAllMunicipios();
        const data = municipios.map(name => {
            const row = _rows.find(r => r.Municipio === name);
            return {
                name: name.replace(/\s*Municipio$/,''),
                change: Number(row.Change_2022_2023) // Absolute change
            };
        }).sort((a, b) => a.change - b.change); // Sort by change: most negative (best) at top

        return {
            labels: data.map(d => d.name),
            values: data.map(d => d.change)
        };
    }

    // ---- Charts + Details ----
    // MODIFIED: Renamed and added new chart variables
    let lineChartEmpPop=null, lineChartLabor=null, barChartUnemp=null, barChartAnnualChange=null;
    const dName = document.getElementById('d-name');
    const dCent = document.getElementById('d-centroid');
    const dEmp  = document.getElementById('d-emppop');
    const dUn   = document.getElementById('d-unemp');
    const dLab  = document.getElementById('d-labor');
    const dCenL = document.getElementById('d-census');

    // MODIFIED: Consolidated all chart drawing logic
    function drawCharts(name, st){
      if (!st) return;
      
      const ctxL_EmpPop = document.getElementById('lineChartEmpPop').getContext('2d');
      const ctxL_Labor  = document.getElementById('lineChartLabor').getContext('2d');
      const ctxB_Unemp  = document.getElementById('barChartUnemp').getContext('2d');
      
      if (lineChartEmpPop) lineChartEmpPop.destroy();
      if (lineChartLabor) lineChartLabor.destroy();
      if (barChartUnemp) barChartUnemp.destroy();
      
      // 1. Employment-Pop Ratio Trend (Line Chart)
      lineChartEmpPop = new Chart(ctxL_EmpPop, {
        type: 'line',
        data: {
          labels: YEARS,
          datasets:[{
            label:'Employment-population ratio (%)',
            data: st.empVals,
            tension:.25,
            pointRadius:3
          }]
        },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${fmt.format(c.parsed.y)}%` } } },
          scales:{ y:{ ticks:{ callback:v=>`${v}%` } } },
          maintainAspectRatio:false
        }
      });
      
      // 2. Labor Force Participation Trend (Line Chart)
      lineChartLabor = new Chart(ctxL_Labor, {
        type: 'line',
        data: {
          labels: YEARS,
          datasets:[{
            label:'Labor Force Participation (%)',
            data: st.laborVals,
            tension:.25,
            pointRadius:3,
            borderColor: 'rgb(21, 128, 61)' // A distinct green color
          }]
        },
        options: {
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${fmt.format(c.parsed.y)}%` } } },
          scales:{ y:{ ticks:{ callback:v=>`${v}%` } } },
          maintainAspectRatio:false
        }
      });

      // 3. Unemployment Rate Trend (Bar Chart)
      barChartUnemp = new Chart(ctxB_Unemp, {
        type:'bar',
        data:{
          labels: YEARS,
          datasets:[{
            label:'Unemployment rate (%)',
            data: st.unempVals,
            backgroundColor: 'rgba(239, 68, 68, 0.7)' // Reddish color
          }]
        },
        options:{
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${fmt.format(c.parsed.y)}%` } } },
          scales:{ y:{ ticks:{ callback:v=>`${v}%` } } },
          maintainAspectRatio:false
        }
      });
      
      // 4. Annual Unemployment Change Bar Chart (All Municipios)
      const changeData = prepareAnnualChangeData();
      const ctxB_AnnualChange = document.getElementById('barChartAnnualChange').getContext('2d');
      if (barChartAnnualChange) barChartAnnualChange.destroy();
      
      // Assign different colors for positive/negative change
      const colors = changeData.values.map(v => v < 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)');

      barChartAnnualChange = new Chart(ctxB_AnnualChange, {
        type: 'bar',
        data: {
            labels: changeData.labels,
            datasets: [{
                label: 'Absolute Change in Unemployment Rate (2022 to 2023)',
                data: changeData.values,
                backgroundColor: colors
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bars
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (c) => `${c.parsed.x < 0 ? 'Decreased' : 'Increased'} by ${fmt.format(Math.abs(c.parsed.x))} pp` } }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Change in Percentage Points (pp)' },
                    stacked: true
                },
                y: {
                    stacked: true,
                    ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 }
                }
            },
            maintainAspectRatio: false
        }
    });
    }

    function updateDetails(name, st, centroid){
      dName.textContent = name.replace(/\s*Municipio$/,'');
      dCent.textContent = centroid ? `${centroid.lat.toFixed(4)}, ${centroid.lng.toFixed(4)}` : '—';
      dEmp.textContent  = st?.row?.EmpPop_2023   != null ? `${fmt.format(st.row.EmpPop_2023)}%`   : '—';
      dUn.textContent   = st?.row?.Unemp_2023    != null ? `${fmt.format(st.row.Unemp_2023)}%`    : '—';
      dLab.textContent  = st?.row?.LaborForce_2023!= null ? `${fmt.format(st.row.LaborForce_2023)}%` : '—';
      dCenL.href = "https://data.census.gov/table?q=S2301:+EMPLOYMENT+STATUS+Puerto+Rico";
      drawCharts(name, st);
    }

    // ---- Map + Legend ----
    let _rows = [], map, layer, fc, legend;
    // MODIFIED: Added 'labor' as a possible mode
    let currentMode = 'emp'; // 'emp' = employment-pop; 'unemp' = unemployment; 'labor' = labor force participation
    let lockedName = null, selectedLayer = null;
    const selectedOutline = { weight: 4, color: '#111827', dashArray: '3', fillOpacity: 0.85 };
    let prBoundsGlobal = null;

    function styleForFeature(feature){
      const p = feature.properties || {};
      const name = (p.NAME || p.NAMELSAD || p.name || 'Unknown').replace(/\s*Municipio$/,'');
      const st = statsForMunicipio(name);
      let value = NaN, breaks = EMP_BREAKS, mode = currentMode;
      
      if (st && st.row) {
        if (currentMode === 'emp') {
          value = st.row.EmpPop_2023;
          breaks = EMP_BREAKS;
        } else if (currentMode === 'unemp') {
          value = st.row.Unemp_2023;
          breaks = UNEMP_BREAKS;
        } else if (currentMode === 'labor') {
          value = st.row.LaborForce_2023;
          breaks = LABOR_BREAKS;
        }
      }
      
      const col = colorFor(value, breaks, mode); 
      return { fillColor: col, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }

    // MODIFIED: Updated Legend logic for 3 modes
    function renderLegend(){
      if (!legend || !legend._div) return;
      
      let title, breaks, isHigherBetter;

      if (currentMode === 'emp') {
          title = 'Employment-population ratio (%)';
          breaks = EMP_BREAKS;
          isHigherBetter = true;
      } else if (currentMode === 'unemp') {
          title = 'Unemployment rate (%)';
          breaks = UNEMP_BREAKS;
          isHigherBetter = false;
      } else { // 'labor'
          title = 'Labor Force Participation (%)';
          breaks = LABOR_BREAKS;
          isHigherBetter = true;
      }
      
      let colors = [...CHORO_COLORS];
      // Flip colors if higher values are "better" (emp-pop ratio, LFP)
      if (isHigherBetter) colors = colors.reverse();
      
      const rows = [];
      const row = (color, label) =>
        `<div style="display:flex;align-items:center;gap:.5rem;margin:.2rem 0;">
           <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};
                        border:1px solid rgba(0,0,0,.15)"></span>
           <span>${label}</span>
         </div>`;

      const fmtRange = (a,b) => `${a}% – ${b}%`;
      rows.push(`<div style="font-weight:600;margin-bottom:.25rem">${title}</div>`);
      // Logic for the first and last bin labels:
      // If higher is better, the lowest color (index 0) is <= min break.
      // If lower is better (unemp), the lowest color is >= max break.
      rows.push(row(colors[0], isHigherBetter ? `≤ ${breaks[0]}%` : `> ${breaks[4]}%`));
      rows.push(row(colors[1], fmtRange(breaks[0], breaks[1])));
      rows.push(row(colors[2], fmtRange(breaks[1], breaks[2])));
      rows.push(row(colors[3], fmtRange(breaks[2], breaks[3])));
      rows.push(row(colors[4], fmtRange(breaks[3], breaks[4])));
      rows.push(row(colors[5], isHigherBetter ? `> ${breaks[4]}%` : `≤ ${breaks[0]}%`));

      legend._div.innerHTML = rows.join('');
    }

    // MODIFIED: Updated metric toggle logic for 3 modes
    function wireMetricToggle(){
      const btnEmp = document.getElementById('metricEmp');
      const btnUn  = document.getElementById('metricUnemp');
      const btnLab = document.getElementById('metricLabor');
      
      function setMode(mode){
        currentMode = mode;
        
        btnEmp.classList.toggle('bg-blue-600', mode==='emp');
        btnEmp.classList.toggle('text-white', mode==='emp');
        btnEmp.classList.toggle('hover:bg-gray-50', mode!=='emp');
        
        btnUn.classList.toggle('bg-blue-600', mode==='unemp');
        btnUn.classList.toggle('text-white', mode==='unemp');
        btnUn.classList.toggle('hover:bg-gray-50', mode!=='unemp');
        
        btnLab.classList.toggle('bg-blue-600', mode==='labor');
        btnLab.classList.toggle('text-white', mode==='labor');
        btnLab.classList.toggle('hover:bg-gray-50', mode!=='labor');

        layer.eachLayer(l => l.setStyle(styleForFeature(l.feature)));
        if (selectedLayer) selectedLayer.setStyle(selectedOutline);
        renderLegend();
      }
      
      // Set initial mode
      setMode(currentMode); 
      
      btnEmp.addEventListener('click', ()=>setMode('emp'));
      btnUn.addEventListener('click', ()=>setMode('unemp'));
      btnLab.addEventListener('click', ()=>setMode('labor'));
    }

    function wireClearSelection(){
      function clearSelection(){
        lockedName = null;
        if (selectedLayer) { layer.resetStyle(selectedLayer); selectedLayer = null; }
        if (prBoundsGlobal) map.fitBounds(prBoundsGlobal, { padding:[15,15] });
        // Reset details to Puerto Rico aggregate
        updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico'), null); 
      }
      document.getElementById('clearSel').addEventListener('click', clearSelection);
      document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') clearSelection(); });
    }

    function wireDropdown() {
      const root = document.getElementById('metrics-dropdown-root');
      if (!root) return;
      let hoverTimeout;
      const menu = document.getElementById('metrics-menu');
      function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); }
      function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 300); }
      root.addEventListener('mouseenter', addHovering);
      root.addEventListener('mouseleave', removeHovering);
      if (menu) {
        menu.addEventListener('mouseenter', addHovering);
        menu.addEventListener('mouseleave', removeHovering);
      }
    }

    // ---- Init ----
    (async function init(){
      const res = await fetch(EMP_JSON, { cache:'no-store' });
      _rows = await res.json();

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      prBoundsGlobal = prBounds;
      map = L.map('map', { zoomSnap:.25 }).fitBounds(prBounds);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      const gjRes = await fetch(GEOJSON_URL + (GEOJSON_URL.includes('?')?'&':'?') + 'cb=' + Date.now());
      fc = await gjRes.json();

      const hiStyle = { weight:3, color:'#111827', fillOpacity:0.9 };

      layer = L.geoJSON(fc, {
        style: (feature) => styleForFeature(feature),
        onEachFeature: (f, lyr) => {
          const p = f.properties || {};
          const rawName = p.NAME || p.NAMELSAD || p.name || 'Unknown';
          const name = rawName.replace(/\s*Municipio$/,'');
          const st = statsForMunicipio(name);
          
          let line = '';
          if (st && st.row) {
              const emp = fmt.format(st.row.EmpPop_2023);
              const unemp = fmt.format(st.row.Unemp_2023);
              const labor = fmt.format(st.row.LaborForce_2023);
              line = `<br><small>Emp-Pop 2023: ${emp}% | Unemp 2023: ${unemp}% | LFP 2023: ${labor}%</small>`;
          }
          
          lyr.bindTooltip(rawName, { direction:'center', className:'leaflet-tooltip' });
          lyr.bindPopup(`<strong>${rawName}</strong>${line}`);

          lyr.on({
            mouseover: e => {
              if (lockedName) return;
              e.target.setStyle(hiStyle);
              const c = e.target.getBounds().getCenter();
              updateDetails(name, statsForMunicipio(name), c);
            },
            mouseout: e => {
              if (lockedName) return;
              layer.resetStyle(e.target);
            },
            click: e => {
              if (selectedLayer) layer.resetStyle(selectedLayer);
              selectedLayer = e.target;
              lockedName = name;
              e.target.setStyle(selectedOutline);
              map.fitBounds(e.target.getBounds(), { padding:[20,20] });
              const c = e.target.getBounds().getCenter();
              updateDetails(lockedName, statsForMunicipio(lockedName), c);
            }
          });
        }
      }).addTo(map);

      const b = layer.getBounds();
      if (b.isValid()) map.fitBounds(b, { padding:[15,15] });

      legend = L.control({ position:'bottomright' });
      legend.onAdd = function(){
        const div = L.DomUtil.create('div', 'info legend');
        div.style.background = 'white';
        div.style.padding = '8px 10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
        div.style.font = '12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
        legend._div = div;
        renderLegend();
        return div;
      };
      legend.addTo(map);

      // Initial details
      updateDetails('Puerto Rico', statsForMunicipio('Puerto Rico'), null);

      wireMetricToggle();
      wireClearSelection();
      wireDropdown();

      // highlight active link in dropdown based on URL
      document.addEventListener('DOMContentLoaded', () => {
        const currentPathname = window.location.pathname.split('/').pop();
        const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
        if (subPageLink) subPageLink.classList.add('bg-gray-100','font-semibold');
      });
    })();
  </script>
</body>
</html>