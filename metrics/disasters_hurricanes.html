<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Natural Disaster Map: Hurricane Tracks in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ... (CSS Styles remain largely unchanged) ... */
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    /* Map IDs updated to target only map 1 */
    #map { height: 48vh; width: 100%; border-radius: .75rem; } 
    @media (min-width: 1280px) { #map { height: 46vh; } } 
    @media (max-width: 640px)  { #map { height: 54vh; } } 

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 300px; } /* Increased min-height for bigger graphs */

    /* CUSTOM: Hurricane Legend positioned bottom-right */
    .leaflet-control-hu-legend {
        position: absolute !important; 
        bottom: 10px !important; 
        right: 10px !important;
        background: white;
        padding: 8px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,.15);
        font: 12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        z-index: 1000; 
        width: 150px;
    }
    
    /* Global wrappers/dropdowns remain unchanged */
    #metrics-menu {opacity: 0; visibility: hidden; transform: translateY(4px); pointer-events: none; transition: opacity .15s ease, transform .15s ease, visibility .15s ease;}
    #metrics-dropdown-root:hover #metrics-menu, #metrics-dropdown-root.hovering #metrics-menu {opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;}
    #metrics-dropdown-root:hover #metrics-chevron, #metrics-dropdown-root.hovering #metrics-chevron {transform: rotate(180deg);}
    #scale-wrapper {transform: scale(0.65); transform-origin: top center; height: 154%; padding-bottom: 200px; margin-bottom: -35%;}
    .leaflet-control-map-dropdown {padding: 0; margin-left: 45px; margin-top: 5px;}
    .leaflet-control-map-dropdown .dropdown-root {background: #fff; box-shadow: 0 1px 5px rgba(0,0,0,.65); border-radius: 4px; position: relative;}
    .leaflet-control-map-dropdown .nav-link {padding: 6px 10px; color: #333; font-weight: 500; font-size: 13px; line-height: 1.2; display: flex; align-items: center; gap: 4px; cursor: pointer;}
    .leaflet-control-map-dropdown .dropdown-menu {position: absolute; top: 100%; left: 0; margin-top: 5px; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(4px); pointer-events: none; transition: opacity .15s ease, transform .15s ease, visibility .15s ease;}
    .leaflet-control-map-dropdown .dropdown-root.hovering .dropdown-menu {opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;}
    .leaflet-control-map-dropdown .dropdown-root.hovering #map-selection-chevron {transform: rotate(180deg);}
    .leaflet-control-map-dropdown .dropdown-menu a {text-decoration: none; padding: 6px 12px; font-size: 13px;}

    /* NEW: Fixes Chart.js rendering issue inside hidden/scaled containers */
    .mini canvas {
        width: 100% !important;
        height: 100% !important;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
            <a href="disasters.html"      class="block px-4 py-2 bg-gray-100 font-semibold">Natural Disasters</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
          <div>
            <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
            <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
              Population & Economic Dynamics in Puerto Rico
            </h1>
            <p class="mt-3 text-lg text-gray-700">
              A research project focusing on natural disaster data over Puerto Rico's municipalities.
            </p>
            <div class="mt-5">
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
                <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
                </span>
            </div>
          </div>
        </div>
      </header>

      <section class="card p-4">
        <h2 class="text-lg font-semibold mb-3">Hurricane Tracks (2015-2025) near Puerto Rico</h2>
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-gray-700 font-medium">Map shading by</div>
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
              </div>
            </div>
        </div>
        <div id="map" class="mt-3">
          <div class="leaflet-control-container" id="map-dropdown-container">
            <div class="leaflet-top leaflet-left">
              <div class="leaflet-control leaflet-control-map-dropdown">
                <div class="relative dropdown-root" id="map-selection-dropdown-root">
                  <div class="nav-link inline-flex items-center gap-1 cursor-pointer select-none">
                    Metric Selection
                    <svg id="map-selection-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <div id="map-selection-menu" class="dropdown-menu w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
                    <div class="py-2">
                      <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
                      <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
                      <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
                      <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
                      <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
                      <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
                      <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
                      <a href="disasters.html"      class="block px-4 py-2 bg-gray-100 font-semibold">Natural Disasters</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
      </section>

      <hr class="border-gray-300">
      
      <section class="card p-6 space-y-6">
        <h2 class="text-lg font-semibold">Analysis and Supporting Resources</h2>

        <div class="space-y-4">
            <h3 class="text-base font-semibold text-gray-700">Hurricane Impact and Migration in Puerto Rico ðŸ‡µðŸ‡·</h3>
            <p>
                Puerto Rico is geographically exposed to frequent and severe <strong>tropical cyclones (hurricanes and tropical storms)</strong>, with impacts often triggering significant socioeconomic shifts, most notably mass migration.
            </p>
            
            <h4 class="text-sm font-semibold text-gray-600 mt-4">Socioeconomic and Infrastructural Impact:</h4>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>Major hurricanes inflict severe damage to the island's already fragile <strong>infrastructure</strong>, including the electrical grid, transportation networks, and housing stock.</li>
                <li>The recovery process is often slow and complicated by existing <strong>economic instability</strong> and structural vulnerabilities.</li>
                <li>The destruction leads to long-term <strong>service disruption</strong>, including prolonged power outages and limited access to essential medical and educational services.</li>
            </ul>

            <h4 class="text-sm font-semibold text-gray-600 mt-4">Disaster-Driven Migration:</h4>
            <p>
                Hurricanes serve as significant accelerators of pre-existing <strong>migration trends</strong> from Puerto Rico to the U.S. mainland. The displacement caused by severe storms is often permanent, transforming the migration pattern from economic necessity to survival:
            </p>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>Following <strong>Hurricane Maria in 2017</strong>, Puerto Rico experienced one of the largest <strong>mass displacement events</strong> in recent U.S. history, with hundreds of thousands of residents relocating, primarily to Florida and other eastern states.</li>
                <li>Migration rates accelerate sharply in the years immediately following major storms, driven by the loss of homes, lack of <strong>job opportunities</strong>, and the realization that rebuilding will take years.</li>
                <li>This outward migration results in a <strong>long-term decline in the tax base and population</strong>, challenging the islandâ€™s ability to recover economically and manage its debt.</li>
            </ul>
        </div>
        
        <div class="space-y-2 text-sm text-gray-600">
            <h4 class="font-semibold">Research References:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li><strong>Migration and Demographic Shifts:</strong> Center for Puerto Rican Studies (CUNY) research on post-Maria migration trends.</li>
                <li><strong>Hurricane Risk and Climate Vulnerability:</strong> General NOAA/NHC data on tropical cyclone exposure in the Caribbean.</li>
                <li><strong>Disaster Recovery Portal:</strong> Puerto Rico Disaster Recovery Transparency Portal (COR3) for economic impact data.</li>
            </ul>
        </div>
      </section>

      <section class="card p-6">
          <h2 class="text-lg font-semibold mb-4">Caribbean Tropical Cyclone Trends (2015-2024)</h2>
          <p class="mb-4 text-sm text-gray-600">
              The following graphs illustrate the frequency and intensity of tropical systems in the Caribbean region over the past decade, derived from track data.
          </p>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                  <h3 class="font-semibold mb-2">Number of Named Tropical Systems per Year</h3>
                  <div class="mini bg-gray-50 rounded p-3">
                      <canvas id="huLineChart"></canvas>
                  </div>
              </div>

              <div>
                  <h3 class="font-semibold mb-2">Maximum Category Reached by Systems</h3>
                  <div class="mini bg-gray-50 rounded p-3">
                      <canvas id="huBarChart"></canvas>
                  </div>
              </div>
          </div>
      </section>
      
      </main>
  </div>

  <script>
    // ---------------------- Data Paths ----------------------
    const EQ_JSON = '../data/natural_disasters/puerto_rico_earthquakes.json'; 
    const HU_JSON = '../data/natural_disasters/caribbean_hurricane_tracks_2015_2025.json'; 
    
    let earthquakeLayerGroup = null; 
    let hurricaneLayerGroup = null; 
    let huLineChart = null;
    let huBarChart = null;


    // ---------------------- Earthquake Plotting Logic (REMOVED/EMPTY) ----------------------
    function plotEarthquakes(data, mapInstance){
        if (!data || data.length === 0) {
            return;
        }
    }
    
    function renderEarthquakeLegend(map){
    }
    
    // ---------------------- Hurricane Plotting Logic ----------------------

    const HU_WIND_BREAKS = [34, 64, 83, 96, 113]; // Knots (TS, HU1, HU2, HU3, HU4/5)
    const HU_COLORS = ['#a3a3a3', '#3b82f6', '#fde047', '#fb923c', '#dc2626', '#991b1b']; 

    function getTrackColor(wind) {
        if (wind < HU_WIND_BREAKS[0]) return HU_COLORS[0];
        if (wind < HU_WIND_BREAKS[1]) return HU_COLORS[1];
        if (wind < HU_WIND_BREAKS[2]) return HU_COLORS[2];
        if (wind < HU_WIND_BREAKS[3]) return HU_COLORS[3];
        if (wind < HU_WIND_BREAKS[4]) return HU_COLORS[4];
        return HU_COLORS[5];
    }
    
    function getStatusLabel(wind, status) {
        if (status === 'TS') return 'Tropical Storm';
        if (status === 'HU') {
            if (wind < 83) return 'Hurricane Cat 1';
            if (wind < 96) return 'Hurricane Cat 2';
            if (wind < 113) return 'Hurricane Cat 3';
            return 'Hurricane Cat 4+';
        }
        if (status === 'DB') return 'Tropical Disturbance';
        if (status === 'TD') return 'Tropical Depression';
        if (status === 'SS') return 'Subtropical Storm';
        if (status === 'SD') return 'Subtropical Depression';
        if (status === 'LO') return 'Low';
        if (status === 'WV') return 'Tropical Wave';
        
        return 'Other'; 
    }

    function plotHurricaneTracks(data, mapInstance) {
        if (!data || data.length === 0) {
            console.warn("Hurricane data is empty or failed to load. Check console for fetch errors (404).");
            return;
        }

        if (hurricaneLayerGroup) {
            hurricaneLayerGroup.clearLayers();
        } else {
            hurricaneLayerGroup = L.layerGroup().addTo(mapInstance);
        }

        data.forEach(storm => {
            const latlons = storm.path.map(p => [p.lat, p.lon]);
            const pathData = storm.path;
            const stormName = storm.name;

            // 1. Draw the polylines
            L.polyline(latlons, { 
                color: '#333', 
                weight: 3.0, 
                opacity: 0.6 
            }).addTo(hurricaneLayerGroup);

            // 2. Draw the markers for each point, colored by wind speed
            pathData.forEach(p => {
                const wind_knots = p.wind;
                const color = getTrackColor(wind_knots);
                const statusLabel = getStatusLabel(wind_knots, p.status);
                const date = p.date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');

                L.circleMarker([p.lat, p.lon], {
                    radius: 6.0, 
                    fillColor: color, 
                    color: '#000', 
                    weight: 0.5,
                    opacity: 0.9,
                    fillOpacity: 0.9
                }).bindPopup(`
                    <strong>${stormName} - ${statusLabel} (${p.status})</strong>
                    <br>Date: ${date}
                    <br>Wind: ${wind_knots} knots (${(wind_knots * 1.15078).toFixed(0)} mph)
                    <br>Location: ${p.lat.toFixed(2)}N, ${p.lon.toFixed(2)}W
                `).addTo(hurricaneLayerGroup);
            });
        });
        
        hurricaneLayerGroup.bringToFront();
        console.log("âœ… Hurricane tracks plotted successfully.");
    }

    function renderHurricaneLegend(map){
        const div = document.createElement('div');
        div.className = 'leaflet-control-hu-legend'; 
        
        const title = 'Hurricane Track Wind Status (knots)';
        let html = `<div style="font-weight:600;margin-bottom:5px; border-bottom: 1px solid #ccc;">${title}</div>`;

        const legendItems = [
            { label: '$\le$ 33 knots (TD/Other)', color: HU_COLORS[0] }, 
            { label: '34-63 knots (TS)', color: HU_COLORS[1] },
            { label: '64-82 knots (HU Cat 1)', color: HU_COLORS[2] },
            { label: '83-95 knots (HU Cat 2)', color: HU_COLORS[3] },
            { label: '96-112 knots (HU Cat 3)', color: HU_COLORS[4] },
            { label: '$\ge$ 113 knots (HU Cat 4/5)', color: HU_COLORS[5] }
        ];

        legendItems.forEach(item => {
            html += `
                <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
                    <div style="width:12px;height:12px;border-radius:50%;background:${item.color};border:1px solid #000;box-shadow:0 1px 2px rgba(0,0,0,.1);"></div>
                    <span>${item.label}</span>
                </div>
            `;
        });
        
        // Use a dedicated control container to ensure proper positioning in Leaflet
        L.Control.HurricaneLegend = L.Control.extend({
            onAdd: function(map) {
                // Attach the manually created div element
                L.DomUtil.addClass(div, 'leaflet-control-hu-legend');
                L.DomEvent.disableClickPropagation(div);
                return div;
            },
            onRemove: function(map) {
                // Nothing to do here
            }
        });
        
        // Check if control already exists before adding
        if (!map.findControl(L.Control.HurricaneLegend)) {
            new L.Control.HurricaneLegend({position: 'bottomright'}).addTo(map);
        }
    }
    // ---------------------- End Hurricane Plotting Logic ----------------------

    // ---------------------- Hurricane Chart Logic (NEW) ----------------------
    
    function categorizeWind(wind) {
        if (wind < 64) return 'TD/TS (< 64 kt)';
        if (wind <= 82) return 'Cat 1 (64-82 kt)';
        if (wind <= 95) return 'Cat 2 (83-95 kt)';
        if (wind <= 113) return 'Cat 3 (96-113 kt)';
        if (wind <= 136) return 'Cat 4 (114-136 kt)';
        return 'Cat 5 (> 136 kt)';
    }

    function aggregateHurricaneData(data) {
        const stormCounts = {};
        const maxWinds = [];

        data.forEach(storm => {
            if (storm.path && storm.path.length > 0) {
                const year = storm.path[0].year;
                stormCounts[year] = (stormCounts[year] || 0) + 1;

                let maxWind = 0;
                storm.path.forEach(point => {
                    maxWind = Math.max(maxWind, point.wind);
                });

                if (maxWind >= 34) { // Filter out non-tropical systems below TS level
                    maxWinds.push(maxWind);
                }
            }
        });

        const categoryOrder = ['TD/TS (< 64 kt)', 'Cat 1 (64-82 kt)', 'Cat 2 (83-95 kt)', 'Cat 3 (96-113 kt)', 'Cat 4 (114-136 kt)', 'Cat 5 (> 136 kt)'];
        const maxCategoryCounts = {};
        
        maxWinds.map(categorizeWind).forEach(cat => {
            maxCategoryCounts[cat] = (maxCategoryCounts[cat] || 0) + 1;
        });

        // Order the categories correctly for the chart
        const orderedCategoryCounts = {};
        categoryOrder.forEach(cat => {
            if (cat in maxCategoryCounts) {
                orderedCategoryCounts[cat] = maxCategoryCounts[cat];
            }
        });

        return { 
            timeSeries: stormCounts, 
            maxCategoryDistribution: orderedCategoryCounts
        };
    }

    function drawHurricaneCharts(aggregatedData) {
        const tsCtx = document.getElementById('huLineChart').getContext('2d');
        const catCtx = document.getElementById('huBarChart').getContext('2d');

        // --- 1. Time Series Chart (Named Storms per Year) ---
        const years = Object.keys(aggregatedData.timeSeries).sort((a, b) => a - b);
        const counts = years.map(year => aggregatedData.timeSeries[year]);

        if (huLineChart) huLineChart.destroy();
        huLineChart = new Chart(tsCtx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: 'Storm Count',
                    data: counts,
                    borderColor: '#3b82f6', // Tailwind blue-500
                    tension: 0.2,
                    pointRadius: 4,
                    fill: false
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'Year' } },
                    y: { 
                        title: { display: true, text: 'Named Systems Count' }, 
                        beginAtZero: true, 
                        suggestedMax: Math.max(...counts) * 1.1 
                    }
                },
                maintainAspectRatio: false
            }
        });

        // --- 2. Maximum Category Distribution (Bar Chart) ---
        const catLabels = Object.keys(aggregatedData.maxCategoryDistribution);
        const catCounts = Object.values(aggregatedData.maxCategoryDistribution);

        // Map colors based on category index (from HU_COLORS used for the map legend)
        const HU_COLORS_CHART = ['#a3a3a3', '#3b82f6', '#fde047', '#fb923c', '#dc2626', '#991b1b']; 
        const categoryOrder = ['TD/TS (< 64 kt)', 'Cat 1 (64-82 kt)', 'Cat 2 (83-95 kt)', 'Cat 3 (96-113 kt)', 'Cat 4 (114-136 kt)', 'Cat 5 (> 136 kt)'];
        
        const barColors = catLabels.map(label => {
            const index = categoryOrder.indexOf(label);
            return (index !== -1) ? HU_COLORS_CHART[index] : '#ccc';
        });

        if (huBarChart) huBarChart.destroy();
        huBarChart = new Chart(catCtx, {
            type: 'bar',
            data: {
                labels: catLabels,
                datasets: [{
                    label: 'Number of Systems',
                    data: catCounts,
                    backgroundColor: barColors
                }]
            },
            options: {
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (c) => `Systems: ${c.parsed.y}`
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Maximum Wind Category' } },
                    y: { title: { display: true, text: 'Count' }, beginAtZero: true }
                },
                maintainAspectRatio: false
            }
        });
    }

    // ---------------------- Unused Logic Stubs ----------------------
    const GEOJSON_URL = '../data/tl_2022_72_cousub/pr_municipalities.geojson';
    const EDU_JSON    = '../data/education/municipios_acs_education_2013_2023_wide.json';
    const FIXED_GREEN_COLOR = '#22c55e'; // Kept constant for styleForFeature

    function styleForFeature(feature){
      return { fillColor: FIXED_GREEN_COLOR, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }
    // Dummy functions for compilation
    let _rows = []; 
    function calculateExtremeValues(){}
    function computeBreaks(){}
    function wireMetricToggle(){}
    function wireClearSelection(){}
    function wireDropdown() {
        const root = document.getElementById('metrics-dropdown-root'); if (!root) return; let hoverTimeout; const menu = document.getElementById('metrics-menu');
        function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); } 
        function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 500); }
        root.addEventListener('mouseenter', addHovering); root.addEventListener('mouseleave', removeHovering); if (menu) { menu.addEventListener('mouseenter', addHovering); menu.addEventListener('mouseleave', removeHovering); }
    }
    function wireMapDropdown() {
        const root1 = document.getElementById('map-selection-dropdown-root'); 
        if (root1) { 
            let hoverTimeout; const menu = document.getElementById('map-selection-menu');
            function addHovering(){ clearTimeout(hoverTimeout); root1.classList.add('hovering'); } 
            function removeHovering(){ hoverTimeout = setTimeout(()=>{ root1.classList.remove('hovering'); }, 500); }
            root1.addEventListener('mouseenter', addHovering); root1.addEventListener('mouseleave', removeHovering); 
            if (menu) { menu.addEventListener('mouseenter', addHovering); menu.addEventListener('mouseleave', removeHovering); }
        }
    }
    // ---------------------- End Unused Logic Stubs ----------------------

    (async function init(){
      
      // Load primary data (Education and GeoJSON)
      const EDU_JSON_PATH = '../data/education/municipios_acs_education_2013_2023_wide.json'; 
      const GEOJSON_URL_PATH = '../data/tl_2022_72_cousub/pr_municipalities.geojson'; 
      
      try {
        const res = await fetch(EDU_JSON_PATH, { cache:'no-store' });
        const rawData = await res.json();
        _rows = rawData.filter(row => !row.metadata);
      } catch (e) {
        console.error("Failed to load Education data.");
      }
      
      let geojsonData;
      try {
        const gjRes = await fetch(GEOJSON_URL_PATH + '?' + Date.now());
        geojsonData = await gjRes.json(); 
      } catch (e) {
        console.error("Failed to load GeoJSON data.");
      }


      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      
      // --- Map 1 Init (Choropleth/Hurricane Tracks) ---
      map = L.map('map', { zoomControl: false, zoomSnap: .25 }).fitBounds(prBounds);

      L.control.zoom({ position: 'topleft' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Initialize the map dropdown control for map 1
      L.Control.MapDropdown = L.Control.extend({
          onAdd: function(map) {
              const container = L.DomUtil.get('map-dropdown-container');
              L.DomEvent.disableClickPropagation(container);
              L.DomEvent.disableScrollPropagation(container);
              return container.querySelector('.leaflet-control-map-dropdown');
          },
          onRemove: function(map) {}
      });
      new L.Control.MapDropdown({ position: 'topleft' }).addTo(map);

      if (geojsonData) {
        let fc = geojsonData; 
        let layer = L.geoJSON(fc, {
          style: (feature) => styleForFeature(feature),
          onEachFeature: (f, lyr) => {
            lyr.bindPopup(`<strong>${f.properties.NAME || 'Unknown'}</strong>`);
            lyr.bindTooltip(f.properties.NAME || 'Unknown', { direction:'center', className:'leaflet-tooltip' });
          }
        }).addTo(map);

        const b = layer.getBounds();
        if (b.isValid()) map.fitBounds(b, { padding:[15,15] });
      }

      // --- DATA LOADING AND PLOTTING ---
      
      // 1. Hurricane Data (Plot on Map 1)
      let fullHurricaneData = [];
      try {
          const huRes = await fetch(HU_JSON);
          fullHurricaneData = await huRes.json();
      } catch (e) {
          console.error("Error loading or processing hurricane data:", HU_JSON, e);
      }
      
      plotHurricaneTracks(fullHurricaneData, map); // Plot tracks on map
      renderHurricaneLegend(map); // Legend on map

      // ** FIX FOR BLANK GRAPHS: Wait for DOM resize before drawing charts **
      const hurricaneStats = aggregateHurricaneData(fullHurricaneData);
      setTimeout(() => {
          drawHurricaneCharts(hurricaneStats);
      }, 500); // 500ms delay to allow parent container to fully size

      // ... Initial detail updates and wiring ...
      wireMetricToggle();
      wireClearSelection(); 
      wireDropdown(); 
      wireMapDropdown(); 
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const metricsLink = document.querySelector('#metrics-dropdown-root > a'); const isMetricsSubPage = window.location.pathname.includes('/metrics/');
        if (isMetricsSubPage) { metricsLink.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold'); metricsLink.setAttribute('aria-current', 'page');
            const currentPathname = window.location.pathname.split('/').pop(); const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
            if (subPageLink) { subPageLink.classList.add('bg-gray-100', 'font-semibold'); }
        } else {
            document.querySelectorAll('.nav-link[href]').forEach(a => { if (a.href.endsWith(window.location.pathname)) { a.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold'); a.setAttribute('aria-current', 'page'); } });
        }
        wireMapDropdown(); 
    });
  </script>
</body>
</html>