<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Natural Disaster Map: Hurricane Tracks in Puerto Rico</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      overflow:visible;
    }
    .hero {
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(239,68,68,.12), transparent 60%),
        radial-gradient(1200px 600px at 80% -10%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
    }
    /* Map IDs updated to target only map 1 */
    #map { height: 48vh; width: 100%; border-radius: .75rem; } 
    @media (min-width: 1280px) { #map { height: 46vh; } } 
    @media (max-width: 640px)  { #map { height: 54vh; } } 

    .leaflet-tooltip {
      background: rgba(255,255,255,.95);
      border-color:#333;
      color:#111827;
      font-size:14px;
      font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      padding:5px 10px;
    }

    .mini { min-height: 300px; } 
    
    /* Force canvas dimensions for Chart.js inside containers */
    .mini canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    /* UPDATED LEGEND CSS: Removed absolute positioning to let Leaflet control it */
    .leaflet-control-hu-legend {
        background: white;
        padding: 8px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,.15);
        font: 12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        width: 160px;
        margin-right: 10px;
        margin-bottom: 25px; /* Spacing to avoid overlap with attribution */
    }
    
    /* Global wrappers/dropdowns remain unchanged */
    #metrics-menu {
      opacity: 0; visibility: hidden; transform: translateY(4px); pointer-events: none;
      transition: opacity .15s ease, transform .15s ease, visibility .15s ease;
    }
    #metrics-dropdown-root:hover #metrics-menu,
    #metrics-dropdown-root.hovering #metrics-menu {
      opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;
    }
    #metrics-dropdown-root:hover #metrics-chevron,
    #metrics-dropdown-root.hovering #metrics-chevron {
      transform: rotate(180deg);
    }
    #scale-wrapper {transform: scale(0.65); transform-origin: top center; height: 154%; padding-bottom: 200px; margin-bottom: -35%;}
    .leaflet-control-map-dropdown {padding: 0; margin-left: 45px; margin-top: 5px;}
    .leaflet-control-map-dropdown .dropdown-root {background: #fff; box-shadow: 0 1px 5px rgba(0,0,0,.65); border-radius: 4px; position: relative;}
    .leaflet-control-map-dropdown .nav-link {padding: 6px 10px; color: #333; font-weight: 500; font-size: 13px; line-height: 1.2; display: flex; align-items: center; gap: 4px; cursor: pointer;}
    .leaflet-control-map-dropdown .dropdown-menu {position: absolute; top: 100%; left: 0; margin-top: 5px; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(4px); pointer-events: none; transition: opacity .15s ease, transform .15s ease, visibility .15s ease;}
    .leaflet-control-map-dropdown .dropdown-root.hovering .dropdown-menu {opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto;}
    .leaflet-control-map-dropdown .dropdown-root.hovering #map-selection-chevron {transform: rotate(180deg);}
    .leaflet-control-map-dropdown .dropdown-menu a {text-decoration: none; padding: 6px 12px; font-size: 13px;}

    /* --- RADIAL MENU STYLES --- */
    #radial-menu-container { pointer-events: none; width: 300px; height: 300px; position: fixed; bottom: 0; right: 0; z-index: 9999; }
    
    #radial-trigger { pointer-events: auto; }
    
    /* Radial Item Base State */
    .radial-item {
        position: absolute;
        bottom: 7rem;
        right: 2rem;  
        width: 3rem; height: 3rem;
        border-radius: 50%;
        background-color: white;
        color: #4f46e5;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex; align-items: center; justify-content: center;
        text-decoration: none;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        z-index: 9990; /* Base Z-index */

        /* CSS Variables for position */
        --tx: 0px;
        --ty: 0px;
        transform: translate(0, 0) scale(0.5);
    }
    
    /* Radial Item Open State */
    .radial-open .radial-item {
        opacity: 1;
        pointer-events: auto;
        transform: translate(var(--tx), var(--ty)) scale(1);
    }

    /* Radial Item Hover State */
    .radial-open .radial-item:hover { 
        background-color: #e0e7ff; 
        transform: translate(var(--tx), var(--ty)) scale(1.1); 
        z-index: 10005 !important; /* Forces this item AND its child label to be on top of neighbors */
    }
    
    .radial-label {
        position: absolute; 
        right: 125%; /* Pushed slightly further left to avoid icon clipping */
        top: 50%; 
        transform: translateY(-50%);
        background: rgba(17, 24, 39, 0.95); /* Slightly darker for readability */
        color: white;
        padding: 6px 10px; /* Slightly larger padding */
        border-radius: 6px; 
        font-size: 13px; /* Slightly larger text */
        font-weight: 600;
        white-space: nowrap; 
        opacity: 0; 
        transition: opacity 0.2s; 
        pointer-events: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .radial-item:hover .radial-label { opacity: 1; }

    #radial-trigger {
        position: absolute; bottom: 7rem; right: 2rem;
        width: 4rem; height: 4rem;
        border-radius: 50%;
        background-color: #4f46e5;
        color: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: transform 0.3s ease;
        z-index: 10000;
    }
    #radial-trigger:hover { transform: scale(1.05); background-color: #4338ca; }
    .radial-open #radial-trigger { transform: rotate(45deg); background-color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-center gap-6 text-sm sm:text-base">
      <a href="../index.html" class="nav-link border-b-2 border-transparent">Home</a>

      <div class="relative" id="metrics-dropdown-root">
        <a href="../metrics.html" class="nav-link border-b-2 border-blue-600 text-blue-600 font-semibold inline-flex items-center gap-1 cursor-pointer select-none" aria-current="page">
          Metrics
          <svg id="metrics-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </a>
        <div id="metrics-menu" class="absolute right-0 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
          <div class="py-2">
            <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
            <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
            <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
            <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
            <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
            <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
            <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
            <a href="disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
            <a href="disasters_hurricanes.html"      class="block px-4 py-2 bg-gray-100 font-semibold">Hurricanes</a>
          </div>
        </div>
      </div>

      <a href="../literature.html" class="nav-link border-b-2 border-transparent">Literature</a>
      <a href="../strategy.html"   class="nav-link border-b-2 border-transparent">Strategy</a>
      <a href="../about.html"      class="nav-link border-b-2 border-transparent">About</a>
    </div>
  </nav>

  <div id="scale-wrapper">
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
      <header class="card hero p-6 sm:p-8 lg:p-10 relative">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
          <div>
            <p class="text-sm font-semibold text-gray-500 uppercase">Graduate Independent Study</p>
            <h1 class="mt-2 text-4xl sm:text-5xl font-extrabold leading-tight">
              Population & Economic Dynamics in Puerto Rico
            </h1>
            <p class="mt-3 text-lg text-gray-700">
              A graduate research project examining demographic shifts, out-migration, and sustainable development strategies through linked data analysis and policy synthesis.
            </p>
            <div class="mt-5">
              <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800">
                <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-slate-800 text-white text-xs">i</span>
              </span>
            </div>
          </div>
        </div>
      </header>

      <section class="card p-4">
        <h2 class="text-lg font-semibold mb-3">Hurricane Tracks (2015-2025) near Puerto Rico</h2>
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-gray-700 font-medium">Map shading by</div>
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border bg-white shadow-sm overflow-hidden">
            </div>
          </div>
        </div>
        <div id="map" class="mt-3">
          <div class="leaflet-control-container" id="map-dropdown-container">
            <div class="leaflet-top leaflet-left">
              <div class="leaflet-control leaflet-control-map-dropdown">
                <div class="relative dropdown-root" id="map-selection-dropdown-root">
                  <div class="nav-link inline-flex items-center gap-1 cursor-pointer select-none">
                    Metric Selection
                    <svg id="map-selection-chevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <div id="map-selection-menu" class="dropdown-menu w-64 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 z-50">
                    <div class="py-2">
                      <a href="population.html"     class="block px-4 py-2 hover:bg-gray-50">Population</a>
                      <a href="employment.html"     class="block px-4 py-2 hover:bg-gray-50">Employment Rate</a>
                      <a href="establishments.html" class="block px-4 py-2 hover:bg-gray-50">Employer Establishments</a>
                      <a href="income.html"         class="block px-4 py-2 hover:bg-gray-50">Household Income</a>
                      <a href="housing.html"        class="block px-4 py-2 hover:bg-gray-50">Housing Units</a>
                      <a href="education.html"      class="block px-4 py-2 hover:bg-gray-50">Education</a>
                      <a href="health.html"         class="block px-4 py-2 hover:bg-gray-50">Health</a>
                      <a href="disasters_earthquakes.html"      class="block px-4 py-2 hover:bg-gray-50">Earthquakes</a>
                      <a href="disasters_hurricanes.html"      class="block px-4 py-2 bg-gray-100 font-semibold">Hurricanes</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Hurricane Statistics (2015-2025)</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="mini relative">
                <h3 class="text-sm text-gray-500 font-medium mb-2 text-center">Storm Frequency by Year</h3>
                <div class="h-64 w-full">
                    <canvas id="chart-frequency"></canvas>
                </div>
            </div>

            <div class="mini relative">
                <h3 class="text-sm text-gray-500 font-medium mb-2 text-center">Top 10 Strongest Storms (Max Wind)</h3>
                <div class="h-64 w-full">
                    <canvas id="chart-intensity"></canvas>
                </div>
            </div>
            
        </div>
      </section>

      <hr class="border-gray-300">

      <section class="card p-6 space-y-6">
        <h2 class="text-lg font-semibold">Analysis and Supporting Resources</h2>

        <div class="space-y-4">
            <h3 class="text-base font-semibold text-gray-700">Hurricane Impact and Migration in Puerto Rico ðŸ‡µðŸ‡·</h3>
            <p>
                Puerto Rico is geographically exposed to frequent and severe <strong>tropical cyclones (hurricanes and tropical storms)</strong>, with impacts often triggering significant socioeconomic shifts, most notably mass migration.
            </p>
            
            <h4 class="text-sm font-semibold text-gray-600 mt-4">Socioeconomic and Infrastructural Impact:</h4>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>Major hurricanes inflict severe damage to the island's already fragile <strong>infrastructure</strong>, including the electrical grid, transportation networks, and housing stock.</li>
                <li>The recovery process is often slow and complicated by existing <strong>economic instability</strong> and structural vulnerabilities.</li>
                <li>The destruction leads to long-term <strong>service disruption</strong>, including prolonged power outages and limited access to essential medical and educational services.</li>
            </ul>

            <h4 class="text-sm font-semibold text-gray-600 mt-4">Disaster-Driven Migration:</h4>
            <p>
                Hurricanes serve as significant accelerators of pre-existing <strong>migration trends</strong> from Puerto Rico to the U.S. mainland. The displacement caused by severe storms is often permanent, transforming the migration pattern from economic necessity to survival:
            </p>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                <li>Following <strong>Hurricane Maria in 2017</strong>, Puerto Rico experienced one of the largest <strong>mass displacement events</strong> in recent U.S. history, with hundreds of thousands of residents relocating, primarily to Florida and other eastern states.</li>
                <li>Migration rates accelerate sharply in the years immediately following major storms, driven by the loss of homes, lack of <strong>job opportunities</strong>, and the realization that rebuilding will take years.</li>
                <li>This outward migration results in a <strong>long-term decline in the tax base and population</strong>, challenging the islandâ€™s ability to recover economically and manage its debt.</li>
            </ul>
        </div>
        
        <div class="space-y-2 text-sm text-gray-600">
            <h4 class="font-semibold">Research References:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li>
                    <strong>Migration and Demographic Shifts:</strong> 
                    <a href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">Center for Puerto Rican Studies (CUNY) research on post-Maria migration trends.</a>
                </li>
                <li>
                    <strong>Hurricane Risk and Climate Vulnerability:</strong> 
                    <a href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">General NOAA/NHC data on tropical cyclone exposure in the Caribbean.</a>
                </li>
                <li>
                    <strong>Disaster Recovery Portal:</strong> 
                    <a href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">Puerto Rico Disaster Recovery Transparency Portal (COR3) for economic impact data.</a>
                </li>
            </ul>
        </div>
      </section>
      
    </main>
  </div>

  <div class="fixed bottom-8 right-8 z-[9998]">
    <a href="../metrics.html" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-full shadow-2xl transition transform hover:scale-105 font-bold text-lg no-underline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Metrics Overview
    </a>
  </div>

  <div id="radial-menu-container">
      <button id="radial-trigger" onclick="toggleRadialMenu()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
      </button>
  </div>

  <script>
    // ---------------------- Data Paths ----------------------
    // Ensure this path is correct relative to your HTML file location
    const HU_JSON = '../data/natural_disasters/caribbean_hurricane_tracks_2015_2025.json'; 
    
    let hurricaneLayerGroup = null; 
    let map;
    
    // ---------------------- Hurricane Plotting Logic ----------------------

    const HU_WIND_BREAKS = [34, 64, 83, 96, 113]; // Knots (TS, HU1, HU2, HU3, HU4/5)
    const HU_COLORS = ['#a3a3a3', '#3b82f6', '#fde047', '#fb923c', '#dc2626', '#991b1b']; 

    function getTrackColor(wind) {
        if (wind < HU_WIND_BREAKS[0]) return HU_COLORS[0];
        if (wind < HU_WIND_BREAKS[1]) return HU_COLORS[1];
        if (wind < HU_WIND_BREAKS[2]) return HU_COLORS[2];
        if (wind < HU_WIND_BREAKS[3]) return HU_COLORS[3];
        if (wind < HU_WIND_BREAKS[4]) return HU_COLORS[4];
        return HU_COLORS[5];
    }
    
    function getStatusLabel(wind, status) {
        if (status === 'TS') return 'Tropical Storm';
        if (status === 'HU') {
            if (wind < 83) return 'Hurricane Cat 1';
            if (wind < 96) return 'Hurricane Cat 2';
            if (wind < 113) return 'Hurricane Cat 3';
            return 'Hurricane Cat 4+';
        }
        if (status === 'DB') return 'Tropical Disturbance';
        if (status === 'TD') return 'Tropical Depression';
        if (status === 'SS') return 'Subtropical Storm';
        if (status === 'SD') return 'Subtropical Depression';
        if (status === 'LO') return 'Low';
        if (status === 'WV') return 'Tropical Wave';
        return 'Other'; 
    }

    function plotHurricaneTracks(data, mapInstance) {
        if (!data || data.length === 0) {
            console.warn("Hurricane data is empty or failed to load. Check console for fetch errors (404).");
            return;
        }

        if (hurricaneLayerGroup) {
            hurricaneLayerGroup.clearLayers();
        } else {
            hurricaneLayerGroup = L.layerGroup().addTo(mapInstance);
        }

        data.forEach(storm => {
            const latlons = storm.path.map(p => [p.lat, p.lon]);
            const pathData = storm.path;
            const stormName = storm.name;

            // 1. Draw the polylines
            L.polyline(latlons, { 
                color: '#333', 
                weight: 3.0, 
                opacity: 0.6 
            }).addTo(hurricaneLayerGroup);

            // 2. Draw the markers for each point
            pathData.forEach(p => {
                const wind_knots = p.wind;
                const color = getTrackColor(wind_knots);
                const statusLabel = getStatusLabel(wind_knots, p.status);
                const date = p.date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');

                L.circleMarker([p.lat, p.lon], {
                    radius: 6.0, 
                    fillColor: color, 
                    color: '#000', 
                    weight: 0.5,
                    opacity: 0.9,
                    fillOpacity: 0.9
                }).bindPopup(`
                    <strong>${stormName} - ${statusLabel} (${p.status})</strong>
                    <br>Date: ${date}
                    <br>Wind: ${wind_knots} knots (${(wind_knots * 1.15078).toFixed(0)} mph)
                    <br>Location: ${p.lat.toFixed(2)}N, ${p.lon.toFixed(2)}W
                `).addTo(hurricaneLayerGroup);
            });
        });
        
        hurricaneLayerGroup.bringToFront();
        console.log("âœ… Hurricane tracks plotted successfully.");
    }

    function renderHurricaneLegend(map){
        const div = document.createElement('div');
        // FIX: Added standard leaflet control class
        div.className = 'leaflet-control leaflet-control-hu-legend'; 
        
        const title = 'Hurricane Track Wind Status (knots)';
        let html = `<div style="font-weight:600;margin-bottom:5px; border-bottom: 1px solid #ccc;">${title}</div>`;

        const legendItems = [
            { label: '&le; 33 knots (TD/Other)', color: HU_COLORS[0] }, 
            { label: '34-63 knots (TS)', color: HU_COLORS[1] },
            { label: '64-82 knots (HU Cat 1)', color: HU_COLORS[2] },
            { label: '83-95 knots (HU Cat 2)', color: HU_COLORS[3] },
            { label: '96-112 knots (HU Cat 3)', color: HU_COLORS[4] },
            { label: '&ge; 113 knots (HU Cat 4/5)', color: HU_COLORS[5] }
        ];

        legendItems.forEach(item => {
            html += `
                <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
                    <div style="width:12px;height:12px;border-radius:50%;background:${item.color};border:1px solid #000;box-shadow:0 1px 2px rgba(0,0,0,.1);"></div>
                    <span>${item.label}</span>
                </div>
            `;
        });
        
        div.innerHTML = html;

        L.Control.HurricaneLegend = L.Control.extend({
            onAdd: function(map) {
                // Prevent clicks on legend from zooming map
                L.DomEvent.disableClickPropagation(div);
                return div;
            },
            onRemove: function(map) {}
        });
        
        new L.Control.HurricaneLegend({position: 'bottomright'}).addTo(map);
    }
    
    // ---------------------- Chart Plotting Logic ----------------------
    function renderCharts(data) {
        if (!data || data.length === 0) return;

        const yearCounts = {};
        const intensityData = [];

        data.forEach(storm => {
            // SAFETY CHECK: Ensure path is not empty to prevent crash
            if (!storm.path || storm.path.length === 0) return;

            // Get Year
            const year = storm.path[0].year;
            yearCounts[year] = (yearCounts[year] || 0) + 1;

            // Get Max Wind
            const maxWind = Math.max(...storm.path.map(p => p.wind));
            intensityData.push({
                name: storm.name + ` (${year})`,
                wind: maxWind
            });
        });

        // Prepare Frequency Chart Data
        const years = Object.keys(yearCounts).sort();
        const counts = years.map(y => yearCounts[y]);

        // Prepare Intensity Chart Data (Sort descending and take top 10)
        intensityData.sort((a, b) => b.wind - a.wind);
        const top10 = intensityData.slice(0, 10);
        
        // --- Render Chart 1: Frequency ---
        const ctxFreq = document.getElementById('chart-frequency');
        if(ctxFreq) {
            new Chart(ctxFreq.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Number of Storms',
                        data: counts,
                        backgroundColor: '#3b82f6', // Blue-500
                        borderRadius: 4,
                        hoverBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Count' } }
                    }
                }
            });
        }

        // --- Render Chart 2: Intensity (Top 10) ---
        const ctxInt = document.getElementById('chart-intensity');
        if(ctxInt) {
            // Helper to color bars based on category
            const getBarColor = (val) => {
                if(val >= 113) return '#991b1b'; // Cat 4/5
                if(val >= 96)  return '#dc2626'; // Cat 3
                if(val >= 83)  return '#fb923c'; // Cat 2
                if(val >= 64)  return '#fde047'; // Cat 1
                return '#3b82f6'; // TS and below
            };
            
            new Chart(ctxInt.getContext('2d'), {
                type: 'bar',
                indexAxis: 'y', // Horizontal Bar Chart
                data: {
                    labels: top10.map(d => d.name),
                    datasets: [{
                        label: 'Max Wind (knots)',
                        data: top10.map(d => d.wind),
                        backgroundColor: top10.map(d => getBarColor(d.wind)),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Wind Speed (knots)' } }
                    }
                }
            });
        }
    }
    
    // ---------------------- Unused Logic Stubs ----------------------
    const FIXED_GREEN_COLOR = '#22c55e';

    function styleForFeature(feature){
      return { fillColor: FIXED_GREEN_COLOR, weight: 1.2, color:'#111827', fillOpacity:.75 };
    }
    let _rows = []; 
    function calculateExtremeValues(){}
    function computeBreaks(){}
    function wireMetricToggle(){}
    function wireClearSelection(){}
    // ---------------------- End Unused Logic Stubs ----------------------
    
    // Dropdown wiring
    function wireDropdown() {
        const root = document.getElementById('metrics-dropdown-root');
        if (!root) return;
        let hoverTimeout;
        const menu = document.getElementById('metrics-menu');

        function addHovering(){ clearTimeout(hoverTimeout); root.classList.add('hovering'); } 
        function removeHovering(){ hoverTimeout = setTimeout(()=>root.classList.remove('hovering'), 500); }

        root.addEventListener('mouseenter', addHovering);
        root.addEventListener('mouseleave', removeHovering);
        if (menu) {
          menu.addEventListener('mouseenter', addHovering);
          menu.addEventListener('mouseleave', removeHovering);
        }
    }

    function wireMapDropdown() {
        const root1 = document.getElementById('map-selection-dropdown-root'); 
        if (root1) { 
            let hoverTimeout;
            const menu = document.getElementById('map-selection-menu');
            function addHovering(){ clearTimeout(hoverTimeout); root1.classList.add('hovering'); } 
            function removeHovering(){ hoverTimeout = setTimeout(()=>{ root1.classList.remove('hovering'); }, 500); }
            root1.addEventListener('mouseenter', addHovering);
            root1.addEventListener('mouseleave', removeHovering); 
            if (menu) {
              menu.addEventListener('mouseenter', addHovering);
              menu.addEventListener('mouseleave', removeHovering);
            }
        }
    }
    
    // --- RADIAL MENU LOGIC (Inserted) ---
    const menuItems = [
        { label: 'Population', href: 'population.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { label: 'Employment Rate', href: 'employment.html', icon: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
        { label: 'Employer Establishments', href: 'establishments.html', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
        { label: 'Household Income', href: 'income.html', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
        { label: 'Housing Units', href: 'housing.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { label: 'Education', href: 'education.html', icon: 'M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z' },
        { label: 'Health', href: 'health.html', icon: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z' },
        { label: 'Earthquakes', href: 'disasters_earthquakes.html', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
        { label: 'Hurricanes', href: 'disasters_hurricanes.html', icon: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' }
    ];

    function initRadialMenu() {
        const container = document.getElementById('radial-menu-container');
        const trigger = document.getElementById('radial-trigger');
        
        const totalAngle = 100; // Degrees of spread
        const radius = 180; // Distance from center
        const count = menuItems.length;
        const startAngle = -95; // Top (12 o'clock ish)
        const step = totalAngle / (count - 1);

        menuItems.forEach((item, index) => {
            const angleDeg = startAngle - (step * index); 
            const angleRad = angleDeg * (Math.PI / 180);
            
            const x = Math.round(radius * Math.cos(angleRad));
            const y = Math.round(radius * Math.sin(angleRad));

            const el = document.createElement('a');
            el.href = item.href;
            el.className = 'radial-item';
            el.style.transitionDelay = `${index * 0.03}s`;
            
            // Store coordinates in CSS variables on the element
            el.style.setProperty('--tx', `${x}px`);
            el.style.setProperty('--ty', `${y}px`);

            el.innerHTML = `
                <span class="radial-label">${item.label}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" />
                </svg>
            `;
            container.insertBefore(el, trigger);
        });
    }

    function toggleRadialMenu() {
        const container = document.getElementById('radial-menu-container');
        // Simply toggle class - CSS variables handle the positioning now
        container.classList.toggle('radial-open');
    }
    
    (async function init(){
      const GEOJSON_URL_PATH = '../data/tl_2022_72_cousub/pr_municipalities.geojson'; 

      let geojsonData;
      try {
        const gjRes = await fetch(GEOJSON_URL_PATH + '?' + Date.now());
        geojsonData = await gjRes.json(); 
      } catch (e) {
        console.error("Failed to load GeoJSON data.");
      }

      const prBounds = L.latLngBounds([[17.85, -67.45],[18.55, -65.25]]);
      
      // --- Map Init (Choropleth + Hurricane Tracks) ---
      map = L.map('map', { zoomControl: false, zoomSnap: .25 }).fitBounds(prBounds);

      L.control.zoom({ position: 'topleft' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 7, maxZoom: 19
      }).addTo(map);

      // Initialize the map dropdown control
      L.Control.MapDropdown = L.Control.extend({
          onAdd: function(map) {
              const container = L.DomUtil.get('map-dropdown-container');
              L.DomEvent.disableClickPropagation(container);
              L.DomEvent.disableScrollPropagation(container);
              return container.querySelector('.leaflet-control-map-dropdown');
          },
          onRemove: function(map) {}
      });
      new L.Control.MapDropdown({ position: 'topleft' }).addTo(map);

      if (geojsonData) {
        let fc = geojsonData; 
        let layer = L.geoJSON(fc, {
          style: (feature) => styleForFeature(feature),
          onEachFeature: (f, lyr) => {
            lyr.bindPopup(`<strong>${f.properties.NAME || 'Unknown'}</strong>`);
            lyr.bindTooltip(f.properties.NAME || 'Unknown', { direction:'center', className:'leaflet-tooltip' });
          }
        }).addTo(map);

        const b = layer.getBounds();
        if (b.isValid()) map.fitBounds(b, { padding:[15,15] });
      }

      // --- DATA LOADING AND PLOTTING ---
      let fullHurricaneData = [];
      try {
          const huRes = await fetch(HU_JSON);
          fullHurricaneData = await huRes.json();
      } catch (e) {
          console.error("Error loading or processing hurricane data:", HU_JSON, e);
      }
      
      // Plot tracks + legend
      plotHurricaneTracks(fullHurricaneData, map);
      renderHurricaneLegend(map);
      
      // Render Statistical Charts (New Call)
      renderCharts(fullHurricaneData);

      wireMetricToggle();
      wireClearSelection(); 
      wireDropdown(); 
      wireMapDropdown(); 
      
      // REMOVED: initRadialMenu(); from here to ensure it runs even if data load fails
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const metricsLink = document.querySelector('#metrics-dropdown-root > a');
        const isMetricsSubPage = window.location.pathname.includes('/metrics/');
        if (isMetricsSubPage) {
            metricsLink.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold');
            metricsLink.setAttribute('aria-current', 'page');
            const currentPathname = window.location.pathname.split('/').pop();
            const subPageLink = document.querySelector(`#metrics-menu a[href="${currentPathname}"]`);
            if (subPageLink) { subPageLink.classList.add('bg-gray-100', 'font-semibold'); }
        } else {
            document.querySelectorAll('.nav-link[href]').forEach(a => {
                if (a.href.endsWith(window.location.pathname)) {
                    a.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'font-semibold');
                    a.setAttribute('aria-current', 'page');
                }
            });
        }
        wireMapDropdown(); 
        
        // ADDED: Init Radial Menu here for reliability
        initRadialMenu(); 
    });
  </script>
</body>
</html>