<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Median Household Income in Puerto Rico (2010–2023)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8fafc;
    }

    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    #map {
      width: 100%;
      height: 530px;
      border-radius: 1rem;
      z-index: 1;
    }

    .legend {
      line-height: 1.3;
      color: #555;
      background: white;
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      font-size: 14px;
    }

    .leaflet-control-attribution {
      display: none;
    }

    .info {
      padding: 8px 10px;
      background: white;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 14px;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 360px;
    }

    .active-muni {
      font-weight: 600;
      color: #1d4ed8;
    }

    /* Hover dropdown styling for nav menu */
    .group:hover .group-hover\:block {
      display: block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    .dropdown-content a {
      color: #1e293b;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }

    .dropdown-content a:hover {
      background-color: #f1f5f9;
    }

    .group:hover .dropdown-content {
      display: block;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- ==================== TOP HEADER / NAVBAR ==================== -->
  <header class="bg-blue-900 text-white shadow">
    <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
      <h1 class="text-2xl font-semibold tracking-tight">Independent Study Class</h1>
      <nav class="flex space-x-6 items-center text-sm">
        <a href="../index.html" class="hover:text-blue-200">Home</a>
        <div class="relative group">
          <a href="../metrics.html" class="hover:text-blue-200 cursor-pointer">
            Metrics
          </a>
          <div class="dropdown-content absolute hidden group-hover:block">
            <a href="population.html">Population</a>
            <a href="employment.html">Employment</a>
            <a href="income.html" class="bg-blue-50 font-medium">Household Income</a>
            <a href="education.html">Education</a>
            <a href="health.html">Health</a>
            <a href="housing.html">Housing Units</a>
          </div>
        </div>
        <a href="../maps.html" class="hover:text-blue-200">Maps</a>
        <a href="../charts.html" class="hover:text-blue-200">Charts</a>
        <a href="../strategy.html" class="hover:text-blue-200">Strategy</a>
        <a href="../about.html" class="hover:text-blue-200">About</a>
      </nav>
    </div>
  </header>

  <!-- ==================== HERO SECTION ==================== -->
  <section class="bg-gradient-to-r from-blue-900 to-blue-700 text-white py-10 shadow-lg">
    <div class="max-w-6xl mx-auto text-center px-6">
      <h2 class="text-3xl md:text-4xl font-bold mb-4">
        Median Household Income in Puerto Rico (2010–2023)
      </h2>
      <p class="max-w-2xl mx-auto text-blue-100 text-lg">
        Visualizing income trends, disparities, and changes across all 78 municipios in Puerto Rico.
      </p>
    </div>
  </section>

  <!-- ==================== MAIN SECTION ==================== -->
  <main class="flex-grow max-w-7xl mx-auto px-6 py-10 space-y-10">

    <!-- ============ MAP CARD ============ -->
    <section class="card">
      <h2 class="text-xl font-semibold mb-4 text-slate-800">Map of Median Household Income</h2>
      <p class="text-slate-600 mb-6 text-sm">
        Hover or click on a municipio to explore median household income levels, annual change, and cumulative growth between 2010 and 2023.
      </p>
      <div id="map"></div>
      <div class="flex justify-between items-center mt-4 text-sm">
        <button id="clearSelection" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Clear Selection</button>
        <span id="selectedMunicipio" class="italic text-slate-500">No municipio selected</span>
      </div>
    </section>

    <!-- ============ CHARTS SECTION ============ -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left chart: Income trend -->
      <div class="card">
        <h3 class="font-semibold mb-2 text-gray-700">
          Median Household Income Trend (2010–2023)
        </h3>
        <div class="chart-container">
          <canvas id="incomeTrendChart"></canvas>
        </div>
      </div>

      <!-- Right chart: Annual % change -->
      <div class="card">
        <h3 class="font-semibold mb-2 text-gray-700">
          Annual % Change in Median Household Income
        </h3>
        <div class="chart-container">
          <canvas id="incomeChangeChart"></canvas>
        </div>
      </div>
    </section>

    <!-- ============ DETAILS SECTION ============ -->
    <section class="card">
      <h3 class="text-lg font-semibold mb-3 text-gray-800">
        Median Household Income Details
      </h3>
      <div id="municipioDetails" class="text-sm text-gray-600 space-y-2">
        <p>Select a municipio on the map to view its data.</p>
      </div>
    </section>

    <!-- ============ SOURCES ============ -->
    <section class="text-sm text-slate-600 mt-8">
      <p>
        <strong>Source:</strong> U.S. Census Bureau, American Community Survey (ACS) 5-Year Subject Tables (S1901);
        U.S. Bureau of Labor Statistics (CPI-U, FRED). Data compiled and adjusted to 2023 USD.
      </p>
    </section>

  </main>

  <!-- ==================== FOOTER ==================== -->
  <footer class="bg-slate-800 text-slate-200 py-6 text-center text-sm mt-auto">
    <p>&copy; 2025 Independent Study Class. Data visualization project for Puerto Rico socio-economic metrics.</p>
  </footer>

  <!-- ==================== JAVASCRIPT ==================== -->
  <script>
    const POP_JSON = '../data/household_income/municipios_acs_s1901_median_income_2010_2023_wide.json';
    const YEARS = Array.from({ length: 14 }, (_, i) => 2010 + i); // 2010–2023

    let map, geojsonLayer, incomeData = [];
    let incomeChart, changeChart;
    let selectedMunicipio = null;

    async function loadData() {
      const res = await fetch(POP_JSON, { cache: 'no-store' });
      incomeData = await res.json();
      return incomeData;
    }

    function getColor(d) {
      return d > 40000 ? '#08306b' :
             d > 35000 ? '#2171b5' :
             d > 30000 ? '#4292c6' :
             d > 25000 ? '#6baed6' :
             d > 20000 ? '#9ecae1' :
             d > 15000 ? '#c6dbef' :
             d > 10000 ? '#deebf7' :
                          '#f7fbff';
    }

    function style(feature) {
      const row = incomeData.find(r => r.Municipio.toLowerCase().includes(feature.properties.NOM_MUN.toLowerCase()));
      const latest = row ? row["2023"] : null;
      return {
        fillColor: latest ? getColor(latest) : '#ccc',
        weight: 1,
        opacity: 1,
        color: 'white',
        dashArray: '1',
        fillOpacity: 0.8
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 2,
        color: '#333',
        fillOpacity: 1
      });
      layer.bringToFront();
      const name = layer.feature.properties.NOM_MUN;
      const row = incomeData.find(r => r.Municipio.toLowerCase().includes(name.toLowerCase()));
      if (row) updateDetails(name, row);
    }

    function resetHighlight(e) {
      geojsonLayer.resetStyle(e.target);
    }

    function zoomToFeature(e) {
      map.fitBounds(e.target.getBounds());
      selectedMunicipio = e.target.feature.properties.NOM_MUN;
      const row = incomeData.find(r => r.Municipio.toLowerCase().includes(selectedMunicipio.toLowerCase()));
      if (row) updateCharts(selectedMunicipio, row);
      document.getElementById("selectedMunicipio").textContent = selectedMunicipio;
    }

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
      });
    }

    async function initMap() {
      map = L.map('map', {
        center: [18.22, -66.4],
        zoom: 8.5,
        zoomControl: true
      });

      const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">Carto</a>'
      }).addTo(map);

      const geoData = await fetch('../data/geojson/municipios_pr.geojson').then(r => r.json());
      geojsonLayer = L.geoJson(geoData, {
        style,
        onEachFeature
      }).addTo(map);

      L.control.attribution({ prefix: false }).addTo(map);
    }

    function updateDetails(name, row) {
      const html = `
        <p><strong>${name}</strong></p>
        <p>Median Household Income (2023): <strong>$${row["2023"]?.toLocaleString() || "N/A"}</strong></p>
        <p>Cumulative Change (2010–2023): <strong>$${row["Cum_Change_2010_2023"]?.toLocaleString() || "N/A"}</strong> (${row["Cum_Pct_Change_2010_2023"]?.toFixed(1) || 0}%)</p>
        <p>Annual Change (2022–2023): <strong>$${row["Change_2022_2023"]?.toLocaleString() || "N/A"}</strong> (${row["Pct_Change_2022_2023"]?.toFixed(1) || 0}%)</p>
      `;
      document.getElementById("municipioDetails").innerHTML = html;
    }

    function updateCharts(name, row) {
      const ctx1 = document.getElementById("incomeTrendChart").getContext("2d");
      const ctx2 = document.getElementById("incomeChangeChart").getContext("2d");

      const values = YEARS.map(y => row[String(y)]);
      const pctChange = YEARS.slice(1).map((y, i) => {
        const prev = row[String(YEARS[i])];
        const curr = row[String(y)];
        return prev && curr ? ((curr - prev) / prev) * 100 : null;
      });

      if (incomeChart) incomeChart.destroy();
      if (changeChart) changeChart.destroy();

      incomeChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: YEARS,
          datasets: [{
            label: "Median Household Income (USD)",
            data: values,
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.2)",
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 3
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: "Income (USD)"
              }
            }
          },
          plugins: {
            legend: { display: false },
            title: { display: false }
          }
        }
      });

      changeChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: YEARS.slice(1),
          datasets: [{
            label: "% Change",
            data: pctChange,
            backgroundColor: "#60a5fa"
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "% Change"
              }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    document.getElementById("clearSelection").addEventListener("click", () => {
      selectedMunicipio = null;
      document.getElementById("selectedMunicipio").textContent = "No municipio selected";
      map.setView([18.22, -66.4], 8.5);
      document.getElementById("municipioDetails").innerHTML = "<p>Select a municipio on the map to view its data.</p>";
      if (incomeChart) incomeChart.destroy();
      if (changeChart) changeChart.destroy();
    });

    (async function init() {
      await loadData();
      await initMap();
    })();
  </script>
</body>
</html>
